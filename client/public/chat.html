<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>与我对话 - 传家之宝</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/global.css">
</head>
<body>
  <nav class="afs-navbar">
    <div class="container d-flex justify-content-between align-items-center">
      <a href="/" class="afs-brand">传家之宝</a>
      <div>
        <a href="dashboard.html" class="nav-link">档案主页</a>
        <a href="timeline.html" class="nav-link">时间线</a>
      </div>
    </div>
  </nav>

  <div class="container py-5" style="max-width: 900px;">
    <div class="card h-100">
      <div class="card-header text-center">
        <h3 data-i18n>正在为您唤醒专属的「传家之宝」...</h3>
      </div>
      <div class="card-body text-center py-5">
        <!-- 训练进度条 -->
        <div id="training-section">
          <div class="progress" style="height: 30px;">
            <div id="training-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">
              <span id="training-text">0%</span>
            </div>
          </div>
          <p class="mt-4 text-muted" id="training-status" data-i18n>正在分析您的记忆与人生故事...</p>
        </div>

        <!-- 对话界面（训练完成后显示） -->
        <div id="chat-section" class="d-none">
          <div id="chat-messages" class="border rounded p-3 mb-3" style="height: 60vh; overflow-y: auto; background: rgba(0,212,255,0.05);">
            <div class="text-center text-muted">「传家之宝」已就绪，您可以开始对话了</div>
          </div>
          <div class="input-group">
            <input type="text" id="user-input" class="form-control form-control-lg" placeholder="说点什么吧..." data-i18n="[placeholder]说点什么吧...">
            <button class="btn btn-primary btn-lg" id="send-btn">发送</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>
        // 前端 chat.html 里的完整 JS（直接复制）
        const socket = io();
        const elderCode = localStorage.getItem('elderCode'); // 登录/注册后保存的编号

        if (elderCode) {
            socket.emit('join-elder-room', elderCode);
        }

        // 发送消息
        function sendMessage() {
        const input = document.getElementById('message-input');
        const msg = input.value.trim();
        if (!msg) return;

        addMessage('我', msg);
        fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: elderCode, message: msg })
        })
        .then(r => r.json())
        .then(data => {
            addMessage('传家之宝', data.reply || data);
        });

        input.value = '';
        }

        // 接收训练进度
        socket.on('training-progress', (data) => {
        if (data.code === elderCode) {
            const bar = document.getElementById('training-progress');
            const text = document.getElementById('progress-text');
            if (bar) bar.style.width = data.progress + '%';
            if (text) text.textContent = data.msg || `学习中...${data.progress}%`;

            if (data.progress === 100) {
            setTimeout(() => {
                document.getElementById('chat-container').style.display = 'block';
                document.getElementById('training-container').style.display = 'none';
            }, 2000);
            }
        }
        });

        function addMessage(sender, text) {
        const div = document.createElement('div');
        div.className = sender === '我' ? 'text-end' : 'text-start';
        div.innerHTML = `<div class="badge ${sender === '我' ? 'bg-primary' : 'bg-success'} p-3 rounded">${text}</div>`;
        document.getElementById('chat-messages').appendChild(div);
        div.scrollIntoView();
        }
  </script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/i18n.js"></script>
  <script src="assets/js/common.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>