<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat-Beta - 您的专属 AI 陪伴</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .chat-container {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .message {
      margin: 10px 0;
    }
    .message.ai {
      background: #f0f0f0;
      border-radius: 10px 10px 10px 0;
      padding: 10px 15px;
      margin-left: 50px;
    }
    .message.user {
      background: #e3f2fd;
      border-radius: 10px 10px 0 10px;
      padding: 10px 15px;
      margin-right: 50px;
    }
    .memory-card {
      background: #fff9c4;
      border-left: 4px solid #ffc107;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .token-badge {
      background: #ffc107;
      color: #000;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.85em;
    }
  </style>
</head>
<body>
  <div class="container-fluid p-0">
    <!-- 登录界面 -->
    <div id="login-screen" class="row">
      <div class="col-12 col-md-6 offset-md-3 mt-5">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Chat-Beta - 您的专属 AI 陪伴</h4>
          </div>
          <div class="card-body">
            <form id="login-form">
              <div class="mb-3">
                <label for="target-code" class="form-label">对方的编号</label>
                <input type="text" class="form-control" id="target-code" placeholder="输入对方的 16 位编号" required>
              </div>
              <div class="mb-3">
                <label for="my-code" class="form-label">您的编号</label>
                <input type="text" class="form-control" id="my-code" placeholder="输入您的 16 位编号" required>
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">验证邮箱</label>
                <input type="email" class="form-control" id="email" placeholder="user@example.com" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">登录</button>
            </form>
            <div id="login-msg" class="mt-2 text-center"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 聊天界面 -->
    <div id="chat-screen" style="display: none;">
      <nav class="navbar bg-primary text-white">
        <div class="container-fluid">
          <a href="profile.html" class="btn btn-outline-light btn-sm me-3">返回个人档案</a>
          <span class="navbar-brand" id="nav-title">对话</span>
          <span class="navbar-text ms-3">
            <span id="relation-display">关系：未知</span>
            <span id="affinity-display" class="ms-3"></span>
          </span>
        </div>
      </nav>
      
      <div class="chat-container">
        <div id="messages" class="p-3" style="height: 400px; overflow-y: auto;">
          <!-- 消息将动态添加 -->
        </div>
        
        <div class="p-3 border-top">
          <div id="memory-suggestions" class="mb-2"></div>
          <form id="chat-form" class="d-flex">
            <input type="text" class="form-control me-2" id="message-input" placeholder="输入消息...">
            <button type="submit" class="btn btn-primary">发送</button>
          </form>
          <div id="token-display" class="text-muted small mt-1"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 角色卡界面 -->
  <div id="rolecard-screen" style="display: none;">
    <div class="container py-4">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h4 class="mb-0">AI 陪伴设置</h4>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h5>记忆 Token 量</h5>
            <div class="progress mb-2">
              <div class="progress-bar" id="token-progress" role="progressbar" style="width: 0%"></div>
            </div>
            <small id="token-text">0 / 30,000</small>
            <button class="btn btn-primary btn-sm" id="generate-rolecard-btn" disabled>生成角色卡</button>
          </div>
          
          <div class="mb-3">
            <h5>当前模式</h5>
            <p id="mode-display">模式1（角色卡 + RAG）</p>
            <div id="mode-upgrade-area" style="display: none;">
              <button class="btn btn-success" id="upgrade-mode-btn">立即升级到模式2</button>
            </div>
          </div>
          
          <div id="rolecard-content" style="display: none;">
            <div class="row">
              <div class="col-md-4">
                <h6>自我认知</h6>
                <div id="self-cognition-content"></div>
              </div>
              <div class="col-md-4">
                <h6>家人情感脚本</h6>
                <div id="family-scripts-content"></div>
              </div>
              <div class="col-md-4">
                <h6>朋友情感脚本</h6>
                <div id="friend-scripts-content"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/main" data-presets="typescript">
    // API 配置
    const API_BASE = 'http://localhost:3001/api';

    // 全局状态
    let currentUser = null;
    let targetUser = null;
    let relation = null;
    let chatContext = null;
    let tokenUsage = { current: 0, total: 0 };

    // 页面加载
    document.addEventListener('DOMContentLoaded', () => {
      checkLogin();
    });

    function checkLogin() {
      const userStr = localStorage.getItem('chatbeta-user');
      const token = localStorage.getItem('token');
      
      if (userStr) {
        currentUser = JSON.parse(userStr);
      }
      
      if (token) {
        // 用户已经在主系统中登录了
        currentUser = currentUser || {};
        currentUser.token = token;
        // 获取当前用户信息
        fetchUserInfo();
      }
    }
    
    async function fetchUserInfo() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          currentUser = { ...currentUser, ...data.user };
          currentUser.uniqueCode = data.user.uniqueCode;
          
          if (!targetUser) {
            // 没有目标用户，显示选择界面或提示用户
            document.getElementById('login-screen').innerHTML = `
              <div class="col-12 col-md-6 offset-md-3 mt-5">
                <div class="card shadow">
                  <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">选择要对话的人</h4>
                  </div>
                  <div class="card-body">
                    <p class="mb-3">请输入要对话的人的专属编号，或查看您协助的人:</p>
                    <div class="mb-3">
                      <label for="target-code" class="form-label">对方的编号</label>
                      <input type="text" class="form-control" id="target-code-only" placeholder="输入对方的 16 位编号">
                    </div>
                    <button class="btn btn-primary w-100" id="start-chat-btn">开始对话</button>
                    <div class="mt-3">
                      <a href="assist.html" class="btn btn-outline-secondary btn-sm">管理我协助的人</a>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            document.getElementById('start-chat-btn').addEventListener('click', async () => {
              const targetCode = document.getElementById('target-code-only').value.trim();
              if (!targetCode) {
                alert('请输入对方编号');
                return;
              }
              await startChat(targetCode);
            });
          }
        }
      } catch (err) {
        console.error('获取用户信息失败:', err);
      }
    }
    
    async function startChat(targetCode) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/chatbeta/login`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify({ myUserId: currentUser.uniqueCode, targetUserId: targetCode })
        });
        
        const result = await response.json();
        
        if (result.success) {
          targetUser = result.targetUser;
          relation = result.relation;
          
          const chatCtx = await fetch(`${API_BASE}/chatbeta/chat/start`, {
            method: 'POST',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ userId: currentUser.uniqueCode, targetUserId: targetCode })
          });
          
          chatContext = await chatCtx.json();
          
          showChatScreen();
          addMessage('ai', '您好！很高兴能和您聊天。有什么我可以帮您的吗？');
          updateTokenDisplay();
        } else {
          alert('对话失败：' + (result.message || '未知错误'));
        }
      } catch (err) {
        console.error('启动对话失败:', err);
        alert('服务器错误，请稍后重试');
      }
    }

    // 登录表单
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const targetCode = document.getElementById('target-code').value.trim();
      const myCode = document.getElementById('my-code').value.trim();
      const email = document.getElementById('email').value.trim();

      try {
        const response = await fetch(`${API_BASE}/chatbeta/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ myUserId: myCode, targetUserId: targetCode, email })
        });

        const result = await response.json();
        
        if (result.success) {
          targetUser = result.targetUser;
          relation = result.relation;
          
          // 获取聊天上下文
          const chatCtx = await fetch(`${API_BASE}/chatbeta/chat/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: myCode, targetUserId: targetCode })
          });
          
          chatContext = await chatCtx.json();
          
          // 显示聊天界面
          showChatScreen();
          
          // 添加欢迎消息
          addMessage('ai', '您好！很高兴能和您聊天。有什么我可以帮您的吗？');
          
          // 获取 Token 使用量
          updateTokenDisplay();
        } else {
          document.getElementById('login-msg').innerHTML = 
            '<div class="alert alert-danger">登录失败</div>';
        }
      } catch (err) {
        console.error('登录错误:', err);
        document.getElementById('login-msg').innerHTML = 
          '<div class="alert alert-danger">服务器错误，请稍后重试</div>';
      }
    });

    function showChatScreen() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'block';
      document.getElementById('rolecard-screen').style.display = 'none';
      
      document.getElementById('nav-title').textContent = `与 ${targetUser.name} 对话`;
      document.getElementById('relation-display').textContent = 
        `关系：${relation.relationType === 'family' ? '家人' : '朋友'}`;
      
      if (relation.showAffinity) {
        document.getElementById('affinity-display').textContent = 
          `好感：${relation.affinityScore}（仅陌生人）`;
      }
    }

    function showRoleCardScreen() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'none';
      document.getElementById('rolecard-screen').style.display = 'block';
      loadRoleCard();
    }

    function addMessage(role, content, ragResults = []) {
      const messagesDiv = document.getElementById('messages');
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      
      let html = '';
      
      if (role === 'ai' && ragResults.length > 0) {
        html += '<div class="memory-suggestions"><strong>相关记忆：</strong><br>';
        ragResults.forEach(r => {
          html += `<div class="memory-card">> ${r.content.substring(0, 100)}...</div>`;
        });
        html += '</div>';
      }
      
      html += content;
      msgDiv.innerHTML = html;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // 聊天表单
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // 添加用户消息
      addMessage('user', message);
      input.value = '';
      
      try {
        // RAG 检索
        const ragRes = await fetch(`${API_BASE}/chatbeta/rag/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userId: targetUser.uniqueCode,
            query: message,
            topK: 5,
            relationType: relation.relationType
          })
        });
        
        const ragData = await ragRes.json();
        
        // 发送消息
        const chatRes = await fetch(`${API_BASE}/chatbeta/chat/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: currentUser?.uniqueCode || 'unknown',
            targetUserId: targetUser.uniqueCode,
            message,
            context: chatContext
          })
        });
        
        const chatData = await chatRes.json();
        
        if (chatData.success) {
          addMessage('ai', chatData.response, chatData.ragResults || []);
          
          // 更新 Token 显示
          updateTokenDisplay();
          
          // 更新关系（如果好感度变化）
          if (chatData.relation) {
            const relationDisplay = document.getElementById('relation-display');
            const affinityDisplay = document.getElementById('affinity-display');
            
            const levelMap = {
              'stranger': '陌生人',
              'casual': '普通朋友',
              'close': '好朋友',
              'intimate': '知心好友'
            };
            
            relationDisplay.textContent = `关系：${levelMap[chatData.relation] || relation.relationType}`;
            
            if (relation.showAffinity) {
              const affinityScore = await getAffinityScore();
              affinityDisplay.textContent = `好感：${affinityScore}`;
            }
          }
        } else if (chatData.action === 'force_close') {
          addMessage('ai', '我太累了，必须休息一下。');
          disableChat();
        }
      } catch (err) {
        console.error('发送消息错误:', err);
        addMessage('ai', '抱歉，发送消息时出现错误。');
      }
    });

    async function updateTokenDisplay() {
      try {
        const res = await fetch(`${API_BASE}/chatbeta/chat/token-usage/${targetUser.uniqueCode}`);
        const data = await res.json();
        
        if (data.success) {
          tokenUsage = data.usage;
          const percentage = Math.min(100, (data.usage.current / 128000) * 100);
          
          document.getElementById('token-display').textContent = 
            `Token 使用：${data.usage.current} / 128,000 (${percentage.toFixed(1)}%)`;
          
          document.getElementById('token-progress').style.width = `${percentage}%`;
          
          if (percentage >= 50) {
            document.getElementById('token-progress').classList.add('bg-warning');
          }
          if (percentage >= 70) {
            document.getElementById('token-progress').classList.remove('bg-warning');
            document.getElementById('token-progress').classList.add('bg-danger');
          }
        }
      } catch (err) {
        console.error('获取 Token 使用量失败:', err);
      }
    }

    async function getAffinityScore() {
      try {
        const res = await fetch(`${API_BASE}/chatbeta/status/${targetUser.uniqueCode}`);
        const data = await res.json();
        // 从 relationships 中获取
        return 0; // 简化处理
      } catch (err) {
        return 0;
      }
    }

    function disableChat() {
      document.getElementById('message-input').disabled = true;
      document.querySelector('#chat-form button').disabled = true;
    }

    async function loadRoleCard() {
      try {
        const res = await fetch(`${API_BASE}/chatbeta/status/${targetUser.uniqueCode}`);
        const data = await res.json();
        
        if (data.success) {
          const tokenCount = data.data.memoryTokenCount || 0;
          const hasRoleCard = data.data.hasRoleCard;
          
          document.getElementById('token-text').textContent = `${tokenCount} / 30,000`;
          
          if (tokenCount >= 1000) {
            document.getElementById('generate-rolecard-btn').disabled = false;
          }
          
          if (hasRoleCard) {
            // 加载角色卡内容 - 简化处理
            document.getElementById('rolecard-content').style.display = 'block';
          }
          
          // 模式切换提示
          if (tokenCount >= 30000) {
            document.getElementById('mode-upgrade-area').style.display = 'block';
          }
        }
      } catch (err) {
        console.error('加载状态失败:', err);
      }
    }

    // 生成角色卡
    document.getElementById('generate-rolecard-btn').addEventListener('click', async () => {
      const btn = document.getElementById('generate-rolecard-btn');
      
      btn.disabled = true;
      btn.textContent = '生成中...';
      
      try {
        const res = await fetch(`${API_BASE}/chatbeta/rolecard/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: targetUser.uniqueCode })
        });
        
        const data = await res.json();
        
        if (data.success) {
          loadRoleCard();
          alert('角色卡生成成功！');
        } else {
          alert('生成失败：' + data.error);
        }
      } catch (err) {
        console.error('生成角色卡失败:', err);
        alert('生成失败：' + err.message);
      }
      
      btn.disabled = false;
      btn.textContent = '生成角色卡';
    });

    // 导航切换
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' && e.ctrlKey) {
        e.preventDefault();
        showRoleCardScreen();
      }
    });
  </script>
</body>
</html>