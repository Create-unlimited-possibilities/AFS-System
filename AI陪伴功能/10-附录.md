# 附录

## A. 环境配置

### 后端依赖安装（已更新）

```bash
cd server
npm install

# LangChain生态（Phase 1新增）
npm install @langchain/community@^1.1.11
npm install @langchain/core@^1.1.19
npm install @langchain/langgraph@^1.1.3
npm install @langchain/ollama@^1.2.2
npm install langchain@^1.2.17

# Jest测试框架（Phase 1新增）
npm install -D jest@^30.2.0
npm install -D @types/jest@^30.0.0
npm install -D babel-jest@^30.2.0
npm install -D @babel/preset-env@latest

# 其他依赖
npm install uuid zod
```

### Jest配置（Phase 1新增）

#### 创建配置文件
```bash
# jest.config.cjs
module.exports = {
  testEnvironment: 'node',
  moduleFileExtensions: ['js', 'json', 'mjs'],
  testMatch: [
    '**/__tests__/**/*.test.js',
    '**/?(*.)+(spec|test).js'
  ],
  testPathIgnorePatterns: [
    '/node_modules/',
    '/dist/',
    '/build/'
  ],
  collectCoverage: true,
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/**/*.test.js',
    '!src/server.js',
    '!src/mongodb/**',
    '!src/utils/logger.js'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  transform: {
    '^.+\\.js$': 'babel-jest'
  },
  setupFilesAfterEnv: ['./tests/setup.js'],
  verbose: true,
  maxWorkers: '50%',
  testTimeout: 10000
};
```

#### 创建Babel配置
```bash
# babel.config.cjs
module.exports = {
  presets: [
    ['@babel/preset-env', {
      targets: { node: 'current' }
    }]
  ]
};
```

### 测试脚本（Phase 1新增）

在package.json中添加:
```json
{
  "scripts": {
    "test": "node --experimental-vm-modules node_modules/jest/bin/jest.js",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:unit": "jest tests/unit",
    "test:integration": "jest tests/integration",
    "test:ci": "jest --ci --coverage --watchAll=false"
  }
}
```

### Docker配置（Phase 1已验证）

```dockerfile
# Dockerfile-server
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# 安装测试依赖
RUN npm install -D jest babel-jest @babel/preset-env

EXPOSE 3000
CMD ["npm", "run", "dev"]
```

```yaml
# docker-compose.yml
services:
  afs-system-server:
    build:
      context: ./server
      dockerfile: Dockerfile-server
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=development
      - MONGO_URI=mongodb://mongoserver:27017/afs
      - MODEL_SERVER_URL=http://modelserver:11434
    depends_on:
      - mongoserver
      - modelserver
```

### ModelServer依赖安装

```python
cd modelserver
pip install -r requirements.txt

# 新增依赖
pip install langchain langchain-community langchain-ollama langchain-chroma
```

---

## B. 数据库配置

### MongoDB集合

```javascript
// 需要的集合：
- users          // 用户集合
- questions      // 问题集合
- answers        // 答案集合
- assistRelations // 协助关系集合
- chatSessions   // 对话会话集合
```

### ChromaDB集合

```python
# 每个用户独立的向量集合：
user_{userId}
```

---

## C. 文件系统结构

```
/app/storage/userdata/
├── {userId}/
│   ├── rolecard.json                    # 角色卡（双重存储）
│   ├── assistants-guidelines.json        # 协助者对话准则（双重存储）
│   ├── profile.json                    # 用户资料（双重存储）
│   ├── assist-relations.json           # 协助关系（双重存储）
│   ├── A_set/                         # A套问答记录（双重存储）
│   ├── B_sets/                        # B套问答记录（双重存储）
│   ├── C_sets/                        # C套问答记录（双重存储）
│   └── chroma_db/                     # RAG向量索引（文件系统独有）
└── chroma_db/                         # 全局ChromaDB存储
    ├── chroma.sqlite3
    └── user_{userId}/
```

---

## D. 已知问题和限制

### Phase 1已知问题

| 问题ID | 描述 | 影响 | 优先级 | 解决方案 |
|--------|------|------|--------|---------|
| P1-001 | Jest在ES模块环境中无法使用jest.mock() | 单元测试无法完全执行 | P0 | 1. 转换为CommonJS<br>2. 降级Jest版本<br>3. 迁移到Vitest |
| P1-002 | 测试覆盖率未达到80%目标 | 无法验证代码质量 | P1 | 解决P1-001后添加缺失测试 |
| P1-003 | 集成测试超时 | 测试不稳定 | P2 | 增加超时配置或优化LLM调用 |
| P1-004 | 集成测试期望值不匹配 | 测试可靠性低 | P2 | 修正测试期望值 |

### Phase 2已知问题

| 问题ID | 描述 | 影响 | 优先级 | 解决方案 |
|--------|------|------|--------|---------|
| P2-001 | Sprint 4性能测试跳过 | 无法验证性能 | P2 | 后续补充性能测试 |
| P2-002 | LLM调用依赖ModelServer | ModelServer故障导致功能不可用 | P1 | 添加降级方案或缓存 |

### Phase 3已知问题

| 问题ID | 描述 | 影响 | 优先级 | 解决方案 |
|--------|------|------|--------|---------|
| P3-001 | 测试覆盖率不足（<5%） | 代码质量无法保证 | P0 | 补充100+个测试用例 |
| P3-002 | 缺少集成测试 | 无法验证端到端流程 | P1 | 添加API集成测试和流程测试 |
| P3-003 | 缺少API测试 | 无法验证API功能 | P1 | 添加所有17个API端点的测试 |
| P3-004 | 会话存储在内存中 | 重启后丢失活跃会话 | P2 | 实现持久化缓存（Redis） |
| P3-005 | 未实现并发控制 | 并发请求可能冲突 | P2 | 添加锁机制（Redis分布式锁） |
| P3-006 | 未实现会话池化 | 高并发时性能下降 | P2 | 实现会话池和资源管理 |
| P3-007 | LangGraph未使用真正LangGraph库 | 自定义实现，缺少LangSmith支持 | P3 | 考虑迁移到@langchain/langgraph |

---

## E. 性能指标

| 指标 | 目标值 | 当前值 | 状态 |
|------|--------|--------|------|
| 代码覆盖率 | 80% | 9% (Phase 1-2), <5% (Phase 3) | ❌ 未达标 |
| 单元测试通过率 | 100% | 60.4% (Phase 1-2), 100% (Phase 3) | ⚠️ Phase 1-2部分通过 |
| 集成测试通过率 | 100% | 82.1% (Phase 1-2) | ⚠️ 部分通过 |
| 测试执行时间 | < 60s | 15s | ✅ 良好 |
| SentinelManger调用延迟 | < 100ms | ~50ms | ✅ 良好（估算） |
| LLMClient调用延迟 | < 3s | ~1-2s | ✅ 良好（估算） |
| LangGraph执行时间 | < 5s | ~2-3s (估算) | ✅ 良好（估算） |
| 会话创建时间 | < 500ms | ~200ms (估算) | ✅ 良好（估算） |
| 消息响应时间 | < 3s | ~1-2s (估算) | ✅ 良好（估算） |

### Phase 3新增性能指标

| 指标 | 目标值 | 预期值 | 状态 |
|------|--------|---------|------|
| 对话完整流程时间 | < 5s | ~2-3s | ✅ 预期达标 |
| LangGraph节点执行 | 每节点 < 500ms | ~100-300ms | ✅ 预期达标 |
| 状态管理开销 | < 50ms | ~10-20ms | ✅ 预期达标 |
| 记忆检索时间 | < 1s | ~300-500ms | ✅ 预期达标 |
| 并发会话数 | > 50 | 预期 > 50 | ⚠️ 待验证 |

---

## F. 验证清单

### Layer 1验证：数据模型
- [x] User模型包含companionChat完整字段
- [x] ChatSession模型创建成功
- [x] AssistRelation模型包含answerSummary和guidelinesGenerated
- [x] 所有索引创建成功
- [x] MongoDB集合验证通过

### Layer 2验证：依赖和工具
- [x] LangChain依赖安装成功
- [x] LLMClient可以正常实例化
- [x] LLMClient工厂方法可用
- [x] DualStorage扩展方法可用
- [x] 容器环境验证通过

### Layer 3验证：核心服务
- [x] SentimentManager实例化成功
- [x] 13个核心方法可用
- [x] 多因素计算逻辑正确
- [x] 好感度历史记录功能正常
- [x] 容器环境验证通过

### Layer 4验证：Phase 2服务
- [x] RoleCardGenerator实例化成功
- [x] AssistantsGuidelinesPreprocessor实例化成功
- [x] 角色卡生成功能正常
- [x] 对话准则预处理功能正常
- [x] 增量更新功能正常
- [x] 容器环境验证通过

### Layer 5验证：Phase 3服务
- [x] ChatGraphOrchestrator实例化成功
- [x] ConversationState状态管理正常
- [x] 9个LangGraph节点实现完成
- [x] 边和条件边实现完成
- [x] DynamicRoleCardAssembler集成正常
- [x] 容器环境验证通过

### Layer 6验证：API接口
- [x] ChatController 7个端点实现完成
- [x] RoleCardController 5个端点实现完成
- [x] SentimentController 5个端点实现完成
- [x] 所有路由已注册到server.js
- [x] 认证中间件配置正确
- [x] 错误处理完善

### Layer 7验证：单元测试
- [x] 所有测试文件创建完成（Phase 1-3）
- [x] 测试基础设施搭建完成
- [x] Jest/Vitest配置正确
- [x] 基础测试可以运行
- [x] 测试覆盖率报告可生成
- [ ] **[阻塞]** ES模块mock问题已解决
- [ ] **[阻塞]** 测试覆盖率达到80%（Phase 3: <5%）

### Layer 8验证：集成测试
- [x] Phase 1集成测试完成
- [x] Phase 2集成测试完成
- [ ] **[阻塞]** Phase 3集成测试完成
- [ ] **[阻塞]** API集成测试完成
- [ ] **[阻塞]** 端到端流程测试完成

### Layer 9验证：功能验收
- [x] 能够成功创建对话会话
- [x] 能够正常发送和接收消息
- [x] 好感度系统正常工作
- [x] LangGraph流程正确执行
- [x] 三种关系类型都支持
- [x] 错误处理完善
- [x] 日志记录完整

---

## G. 故障排查指南（Phase 1新增）

### G1. Jest测试问题

#### 问题: ReferenceError: require is not defined
```bash
# 症状
FAIL tests/unit/dualStorage.test.js
  ● Test suite failed to run
    ReferenceError: require is not defined

# 原因
ES模块环境中无法使用CommonJS的require()

# 解决方案
1. 确认测试文件使用ES6 import语法
2. 检查jest.mock()是否与ES模块兼容
3. 考虑将测试文件改为.cjs扩展名
4. 或降级Jest版本
```

#### 问题: Coverage threshold not met
```bash
# 症状
Jest: "global" coverage threshold for statements (80%) not met: 8.52%

# 原因
测试覆盖率未达到配置的阈值

# 解决方案
1. 查看coverage/lcov-report/index.html
2. 添加缺失的测试用例
3. 或临时降低阈值（仅用于开发）
```

### G2. 容器环境问题

#### 问题: 测试在容器中失败
```bash
# 症状
测试在本地通过，但在Docker容器中失败

# 可能原因
1. Node版本不一致
2. 依赖版本不一致
3. 环境变量缺失
4. 网络连接问题

# 解决方案
1. 检查Dockerfile中的Node版本
2. 确认package-lock.json已提交
3. 检查docker-compose.yml的环境变量配置
4. 检查容器网络连接
```

#### 问题: 文件权限问题
```bash
# 症状
Error: EACCES: permission denied

# 原因
容器中的文件权限不正确

# 解决方案
1. 在Dockerfile中设置正确的用户
2. 使用chmod修改文件权限
3. 在docker-compose.yml中配置用户映射
```

### G3. LangChain集成问题

#### 问题: LLM调用失败
```bash
# 症状
Error: Failed to call LLM

# 可能原因
1. ModelServer未启动
2. 网络连接问题
3. 模型未加载
4. 超时时间过短

# 解决方案
1. 确认ModelServer容器运行中
2. 检查网络连接（docker网络）
3. 确认模型已加载
4. 增加LLMClient的timeout配置
```

---

## H. API错误码

### 通用错误码

| 错误码 | 描述 | 解决方案 |
|--------|------|---------|
| 1000 | 未知错误 | 联系管理员 |
| 1001 | 用户不存在 | 检查uniqueCode是否正确 |
| 1002 | 角色卡未生成 | 提示用户先生成角色卡 |
| 1003 | 协助关系不存在 | 提示用户先建立协助关系 |
| 1004 | 会话不存在 | 检查sessionId是否正确 |
| 1005 | 参数缺失 | 检查请求参数是否完整 |

### Phase 2错误码

| 错误码 | 描述 | 解决方案 |
|--------|------|---------|
| 2001 | 角色卡生成失败 | 检查A套问题是否完成 |
| 2002 | 对话准则生成失败 | 重试或联系管理员 |
| 2003 | 增量更新失败 | 检查协助者ID是否正确 |
| 2004 | LLM调用失败 | 检查ModelServer状态 |
| 2005 | 向量检索失败 | 检查ChromaDB状态 |

### Phase 3错误码

| 错误码 | 描述 | 解决方案 |
|--------|------|---------|
| 3001 | 会话创建失败 | 检查用户ID和对话者ID |
| 3002 | 会话不存在 | 检查sessionId是否正确 |
| 3003 | 消息发送失败 | 检查会话是否活跃 |
| 3004 | LangGraph执行失败 | 查看错误详情，联系管理员 |
| 3005 | 输入为空 | 提供有效的消息内容 |
| 3006 | 角色卡组装失败 | 检查目标用户是否有角色卡 |
| 3007 | 好感度更新失败 | 检查参数是否正确 |
| 3008 | RAG检索失败 | 检查ChromaDB状态 |
| 3009 | LLM回复生成失败 | 检查ModelServer状态 |

---

## E. 性能指标

| 指标 | 目标值 | 当前值 |
|------|--------|--------|
| 角色卡生成时间 | < 30s | - |
| 协助者准则生成时间（单个） | < 5s | - |
| 消息响应时间 | < 3s | - |
| RAG检索时间 | < 1s | - |
| 并发对话数 | > 100 | - |

---

## 更新日志

### v1.2 (2026-02-07) - Phase 3更新
- 新增Phase 3技术实现总结文档
- 更新技术要点（LangGraph节点、会话状态管理）
- 更新性能指标（Phase 3相关）
- 新增Phase 3已知问题和限制
- 更新验证清单（Phase 3功能验收）
- 新增API错误码（Phase 3相关）

### v1.1 (2026-02-05) - Phase 1更新
- 新增Phase 1实施总结文档
- 新增测试文档
- 新增故障排查指南
- 更新环境配置（Jest、Babel）
- 新增已知问题和限制
- 更新性能指标
- 新增验证清单

### v1.0 (2026-02-05)
- 初始版本
- 完整的实现方案
- 分阶段实施计划
- 详细的进度追踪
