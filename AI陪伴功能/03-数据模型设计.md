# 数据模型设计

## 1. User模型扩展

```javascript
// models/User.js - companionChat字段

companionChat: {
  // ========== 角色卡（个人画像） ==========
  roleCard: {
    personality: String,           // 性格特点
    background: String,           // 生活背景
    interests: [String],          // 兴趣爱好
    communicationStyle: String,    // 沟通风格
    values: [String],             // 价值观
    emotionalNeeds: [String],     // 情感需求
    lifeMilestones: [String],     // 人生里程碑
    preferences: [String],         // 偏好
    memories: [String],           // 重要记忆

    // 陌生人初始好感度（基于个人画像生成）
    strangerInitialSentiment: {
      type: Number,
      default: 50,
      min: 0,
      max: 100
    },

    // 生成相关
    generatedAt: Date,
    updatedAt: Date,
    memoryTokenCount: Number
  },

  // ========== 预处理的协助者对话准则 ==========
  assistantsGuidelines: [{
    assistantId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
      required: true
    },

    // 协助者信息
    assistantName: String,
    assistantUniqueCode: String,

    // 关系信息
    assistRelationId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'AssistRelation'
    },
    relationType: {
      type: String,
      enum: ['family', 'friend'],
      required: true
    },
    specificRelation: {
      type: String,
      required: true
    },

    // 对话准则（预处理的）
    conversationGuidelines: {
      type: String,
      required: true
    },

    // 压缩后的答案
    compressedAnswers: [{
      questionId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Question'
      },
      question: String,
      originalAnswer: String,
      compressed: String,
      questionLayer: {
        type: String,
        enum: ['basic', 'emotional']
      },
      compressedAt: Date
    }],

    // 生成时间
    generatedAt: { type: Date, default: Date.now },
    updatedAt: { type: Date, default: Date.now },

    // 状态
    isValid: { type: Boolean, default: true }
  }],

  // ========== 对话模式 ==========
  currentMode: {
    type: String,
    enum: ['mode1', 'mode2', 'mode3'],
    default: 'mode1'
  },

  // ========== 模型状态 ==========
  modelStatus: {
    hasBaseModel: { type: Boolean, default: false },
    hasSFTModel: { type: Boolean, default: false },
    hasFullModel: { type: Boolean, default: false },
    lastTrainedAt: Date,
    trainingInProgress: { type: Boolean, default: false }
  },

  // ========== 陌生人好感度存储 ==========
  strangerSentiments: [{
    strangerId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
      required: true
    },

    // 好感度分数
    currentScore: { type: Number, default: 50, min: 0, max: 100 },

    // 初始分数
    initialScore: Number,

    // 好感度历史
    history: [{
      score: Number,
      change: Number,
      reason: String,
      factors: {
        sentiment: Number,
        frequency: Number,
        quality: Number,
        decay: Number
      },
      timestamp: Date
    }],

    // 统计信息
    totalConversations: { type: Number, default: 0 },
    totalMessages: { type: Number, default: 0 },
    lastConversationAt: Date,

    // 创建时间
    createdAt: { type: Date, default: Date.now },
    updatedAt: { type: Date, default: Date.now }
  }],

  // ========== 作为被对话者的对话历史 ==========
  conversationsAsTarget: [{
    sessionId: { type: String, required: true },
    interlocutorId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User',
      required: true
    },
    interlocutorName: String,
    relationType: {
      type: String,
      enum: ['family', 'friend', 'stranger']
    },
    assistRelationId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'AssistRelation'
    },
    specificRelation: String,
    sentimentSnapshot: Number,
    messages: [{
      role: {
        type: String,
        enum: ['user', 'assistant', 'system']
      },
      content: String,
      timestamp: Date,
      metadata: {
        ragUsed: Boolean,
        retrievedMemories: [mongoose.Schema.Types.Mixed],
        modelUsed: String,
        tokenCount: Number,
        sentimentSnapshot: Number
      }
    }],
    startedAt: Date,
    endedAt: Date,
    lastMessageAt: Date,
    isActive: { type: Boolean, default: true }
  }]
}
```

---

## 2. ChatSession模型（新增）

```javascript
// models/ChatSession.js

const chatSessionSchema = new mongoose.Schema({
  sessionId: {
    type: String,
    required: true,
    unique: true,
    index: true
  },

  // 目标用户（被对话者，角色卡主人）
  targetUserId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    index: true
  },

  // 对话发起者
  interlocutorUserId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true,
    index: true
  },

  // 关系信息
  relation: {
    type: String,
    enum: ['family', 'friend', 'stranger'],
    required: true
  },

  // 具体关系（家人/朋友）
  assistRelationId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'AssistRelation'
  },
  specificRelation: String,

  // 陌生人好感度
  sentimentScore: {
    type: Number,
    default: 50
  },

  // 动态角色卡（每次对话时重新生成）
  dynamicRoleCard: {
    profile: {
      personality: String,
      background: String,
      interests: [String],
      communicationStyle: String
    },
    interlocutorInfo: {
      name: String,
      relation: String,
      specificRelation: String,
      nickname: String
    },
    conversationGuidelines: String,
    generatedAt: Date
  },

  // LangGraph状态
  langGraphState: {
    currentNode: String,
    stateHistory: [{
      node: String,
      timestamp: Date
    }]
  },

  // 消息历史
  messages: [{
    role: {
      type: String,
      enum: ['user', 'assistant', 'system']
    },
    content: String,
    timestamp: Date,
    metadata: {
      ragUsed: Boolean,
      retrievedMemories: [mongoose.Schema.Types.Mixed],
      modelUsed: String,
      dynamicRoleCardVersion: Number,
      sentimentScore: Number
    }
  }],

  startedAt: { type: Date, default: Date.now },
  endedAt: Date,
  lastMessageAt: Date,
  isActive: { type: Boolean, default: true }
});

// 复合索引
chatSessionSchema.index({ targetUserId: 1, interlocutorUserId: 1, isActive: 1 });
chatSessionSchema.index({ sessionId: 1, isActive: 1 });
```

---

## 3. AssistRelation扩展（可选）

```javascript
// models/AssistRelation.js - 新增字段

answerSummary: {
  hasAnswers: Boolean,
  basicAnswersCount: Number,
  emotionalAnswersCount: Number,
  lastAnswerUpdatedAt: Date
},

guidelinesGenerated: {
  type: Boolean,
  default: false
}
```
