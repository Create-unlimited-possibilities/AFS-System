# Phase 1 配置说明

> **版本**: v1.0  
> **创建日期**: 2026-02-07  
> **作者**: AFS Team  
> **最后更新**: 2026-02-07  

---

## 1. 环境变量配置

### 1.1 数据库配置

| 环境变量 | 说明 | 默认值 | 必填 |
|---------|------|--------|------|
| MONGODB_URI | MongoDB连接字符串 | mongodb://localhost:27018/afs_test | 是 |
| DB_NAME | 数据库名称 | afs_test | 否 |
| NODE_ENV | 运行环境 | development | 否 |

### 1.2 模型服务配置

| 环境变量 | 说明 | 默认值 | 必填 |
|---------|------|--------|------|
| MODEL_SERVER_URL | Ollama模型服务地址 | http://localhost:11434 | 是 |
| LLM_MODEL | 默认LLM模型 | qwen2.5 | 否 |

### 1.3 应用配置

| 环境变量 | 说明 | 默认值 | 必填 |
|---------|------|--------|------|
| PORT | 应用端口 | 3001 | 否 |
| JWT_SECRET | JWT密钥 | your-secret-key | 是 |
| FILE_STORAGE_PATH | 文件存储路径 | /app/data | 否 |

---

## 2. MongoDB配置

### 2.1 连接配置

MongoDB连接通过环境变量`MONGODB_URI`配置：

| 配置项 | 说明 | 示例 |
|-------|------|------|
| 协议 | 连接协议 | mongodb:// 或 mongodb+srv:// |
| 主机 | 数据库主机 | localhost |
| 端口 | 数据库端口 | 27018 |
| 数据库 | 数据库名称 | afs_test |

### 2.2 索引配置

Phase 1为以下字段添加索引以优化查询性能：

| 集合 | 索引字段 | 索引类型 | 说明 |
|------|---------|---------|------|
| users | uniqueCode | unique | 用户唯一编码 |
| users | 'companionChat.strangerSentiments.interlocutorId' | compound | 独立好感度查询 |
| users | 'companionChat.conversationsAsTarget.interlocutorId' | compound | 对话历史查询 |
| chatSessions | sessionId | unique | 会话ID |
| chatSessions | targetUserId | compound | 目标用户查询 |
| chatSessions | interlocutorUserId | compound | 对话者查询 |

### 2.3 数据模型配置

#### User模型配置

| 字段路径 | 类型 | 默认值 | 验证 |
|---------|------|--------|------|
| uniqueCode | String | - | 必填，唯一 |
| companionChat.roleCard.personality | String | - | 必填 |
| companionChat.roleCard.background | String | - | 必填 |
| companionChat.currentMode | String | mode1 | 枚举：mode1/mode2/mode3 |
| companionChat.modelStatus.state | String | not_started | 枚举 |
| companionChat.strangerSentiments | Array | [] | 默认空数组 |
| companionChat.conversationsAsTarget | Array | [] | 默认空数组 |
| companionChat.assistantsGuidelines | Array | [] | 默认空数组 |

#### ChatSession模型配置

| 字段 | 类型 | 默认值 | 验证 |
|------|------|--------|------|
| sessionId | String | - | 必填，唯一 |
| targetUserId | ObjectId | - | 必填 |
| interlocutorUserId | ObjectId | - | 必填 |
| relation | String | - | 枚举：family/friend/stranger |
| sentimentScore | Number | 50 | 范围：0-100 |
| messages | Array | [] | 默认空数组 |

---

## 3. LangChain配置

### 3.1 依赖包配置

Phase 1安装了以下LangChain相关依赖：

| 包名 | 版本 | 用途 |
|------|------|------|
| @langchain/community | ^1.1.11 | LangChain社区组件 |
| @langchain/core | ^1.1.19 | LangChain核心模块 |
| @langchain/langgraph | ^1.1.3 | 图状工作流编排 |
| @langchain/ollama | ^1.2.2 | Ollama模型集成 |
| langchain | ^1.2.17 | LangChain主包 |

### 3.2 ChatOllama配置

ChatOllama配置通过LLMClient工厂方法设置：

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| model | 模型名称 | qwen2.5 |
| baseUrl | 模型服务地址 | http://localhost:11434 |
| temperature | 温度参数 | 0.7（默认） / 0.1（情感分析） |
| maxRetries | 最大重试次数 | 3 |
| timeout | 超时时间（毫秒） | 30000 |
| maxTokens | 最大生成token数 | 2000（默认） / 50（情感分析） |

---

## 4. LLMClient配置

### 4.1 默认LLMClient配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| model | qwen2.5 | 默认使用qwen2.5模型 |
| baseUrl | process.env.MODEL_SERVER_URL | 从环境变量读取 |
| temperature | 0.7 | 创造性程度 |
| maxRetries | 3 | 失败重试次数 |
| timeout | 30000 | 30秒超时 |
| maxTokens | 2000 | 最大生成token数 |

### 4.2 情感分析LLMClient配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| model | qwen2.5 | 使用qwen2.5模型 |
| baseUrl | process.env.MODEL_SERVER_URL | 从环境变量读取 |
| temperature | 0.1 | 低温度，提高一致性 |
| maxRetries | 3 | 失败重试次数 |
| timeout | 30000 | 30秒超时 |
| maxTokens | 50 | 仅生成情感分数 |

---

## 5. SentimentManager配置

### 5.1 多因素权重配置

| 因素 | 权重 | 说明 |
|------|------|------|
| sentiment | 0.6 | 情感分析分数（60%） |
| frequency | 0.2 | 对话频次（20%） |
| quality | 0.1 | 对话质量（10%） |
| decay | 0.1 | 时间衰减（10%） |

### 5.2 好感度范围配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| min | 0 | 最低好感度 |
| max | 100 | 最高好感度 |
| default | 50 | 默认好感度 |

### 5.3 时间衰减配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| decayRate | 0.01 | 衰减率（每天） |
| maxDecayDays | 365 | 最大衰减天数 |

---

## 6. DualStorage配置

### 6.1 文件存储配置

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| basePath | 文件系统基础路径 | /app/data |
| checksum算法 | 校验和算法 | SHA256 |

### 6.2 对话准则存储配置

| 配置项 | 说明 | 值 |
|-------|------|-----|
| 文件路径格式 | /userId/assistants-guidelines.json | 动态生成 |
| 编码格式 | UTF-8 | 固定 |
| 备份策略 | 双重存储（MongoDB + 文件系统） | 固定 |

---

## 7. 测试配置

### 7.1 Jest配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| testEnvironment | node | 测试环境 |
| moduleFileExtensions | js, json, mjs | 支持的文件扩展名 |
| testMatch | **/\*.test.js | 测试文件匹配模式 |
| testTimeout | 10000 | 测试超时时间（毫秒） |
| maxWorkers | 50% | 最大并行工作进程 |

### 7.2 覆盖率配置

| 配置项 | 目标值 | 说明 |
|-------|-------|------|
| 语句覆盖率 | 80% | statements |
| 分支覆盖率 | 80% | branches |
| 函数覆盖率 | 80% | functions |
| 行覆盖率 | 80% | lines |

### 7.3 覆盖率收集配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| collectCoverage | true | 启用覆盖率收集 |
| coverageDirectory | coverage | 覆盖率报告目录 |
| coverageReporters | text, lcov, html | 报告格式 |
| collectCoverageFrom | src/**/*.js | 收集覆盖率的文件 |

---

## 8. Docker配置

### 8.1 容器配置

| 配置项 | 值 | 说明 |
|-------|---|------|
| 镜像 | node:18-alpine | 基础镜像 |
| 工作目录 | /app | 容器内工作目录 |
| 端口映射 | 3001:3001 | 应用端口 |
| 环境变量 | 从.env文件加载 | 应用配置 |
| 数据卷 | ./data:/app/data | 数据持久化 |

### 8.2 Docker Compose配置

| 服务 | 镜像 | 端口 | 说明 |
|------|------|------|------|
| server | node:18-alpine | 3001:3001 | 应用服务器 |
| mongodb | mongo:7 | 27018:27017 | MongoDB数据库 |
| modelserver | ollama/ollama | 11434:11434 | Ollama模型服务 |

---

## 9. 安全配置

### 9.1 JWT配置

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| JWT_SECRET | JWT密钥 | your-secret-key（生产环境必须修改） |
| JWT_EXPIRES_IN | Token过期时间 | 7d |

### 9.2 权限配置

| 角色 | 权限 |
|------|------|
| admin | 完全访问权限 |
| user | 基本访问权限 |
| guest | 只读权限 |

---

## 10. 日志配置

### 10.1 日志级别

| 级别 | 说明 |
|------|------|
| error | 错误信息 |
| warn | 警告信息 |
| info | 一般信息 |
| debug | 调试信息 |

### 10.2 日志输出

| 输出目标 | 说明 |
|---------|------|
| 控制台 | 开发环境 |
| 文件 | 生产环境 |
| 日志文件路径 | /app/logs |

---

## 11. 性能配置

### 11.1 缓存配置

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| 启用缓存 | 是否启用缓存 | false |
| 缓存时间 | 缓存过期时间（秒） | 300 |
| 缓存大小 | 最大缓存条目数 | 1000 |

### 11.2 连接池配置

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| maxPoolSize | MongoDB最大连接数 | 10 |
| minPoolSize | MongoDB最小连接数 | 2 |
| connectTimeoutMS | 连接超时（毫秒） | 10000 |

---

## 12. 监控配置

### 12.1 健康检查

| 配置项 | 说明 | 值 |
|-------|------|-----|
| 健康检查端点 | /health | 固定 |
| 检查间隔 | 30秒 | 固定 |
| 超时时间 | 5秒 | 固定 |

### 12.2 指标监控

| 指标 | 说明 |
|------|------|
| 请求响应时间 | API响应时间 |
| 错误率 | 请求错误率 |
| 系统资源 | CPU、内存使用率 |

---

## 13. 配置文件示例

### 13.1 .env示例

```env
# 数据库配置
MONGODB_URI=mongodb://localhost:27018/afs_test
DB_NAME=afs_test

# 模型服务配置
MODEL_SERVER_URL=http://localhost:11434
LLM_MODEL=qwen2.5

# 应用配置
PORT=3001
JWT_SECRET=your-secret-key-change-in-production
FILE_STORAGE_PATH=/app/data

# 环境配置
NODE_ENV=development
```

### 13.2 .env.example

项目根目录提供了`.env.example`文件，包含所有必需的环境变量配置。

---

## 14. 配置验证

### 14.1 启动前检查

应用启动时会检查以下配置：

| 检查项 | 说明 |
|-------|------|
| MONGODB_URI | MongoDB连接字符串 |
| JWT_SECRET | JWT密钥 |
| MODEL_SERVER_URL | 模型服务地址 |

### 14.2 配置错误处理

| 错误类型 | 处理方式 |
|---------|---------|
| 缺少必需配置 | 应用拒绝启动，显示错误信息 |
| 配置格式错误 | 使用默认值或拒绝启动 |
| 连接失败 | 重试3次后退出 |

---

**文档版本**: v1.0  
**创建日期**: 2026-02-07  
**作者**: AFS Team
