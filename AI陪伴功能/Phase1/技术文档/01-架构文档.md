# Phase 1 架构文档

> **版本**: v1.0  
> **创建日期**: 2026-02-07  
> **作者**: AFS Team  
> **最后更新**: 2026-02-07  

---

## 1. 系统架构概述

### 1.1 架构分层

Phase 1采用四层架构设计：

```
┌─────────────────────────────────────────┐
│         Layer 4: 测试层                  │
│   - 单元测试                             │
│   - 集成测试                             │
└─────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────┐
│       Layer 3: 核心服务层                │
│   - SentimentManager服务                │
│   - LLMClient工具                        │
│   - DualStorage扩展                      │
└─────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────┐
│       Layer 2: 依赖和工具层              │
│   - LangChain生态依赖                    │
│   - LLMClient统一接口                    │
└─────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────┐
│        Layer 1: 数据模型层                │
│   - User模型扩展                         │
│   - ChatSession模型                     │
│   - AssistRelation扩展                   │
└─────────────────────────────────────────┘
```

### 1.2 技术栈

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 数据模型 | MongoDB | - | 结构化数据存储 |
| AI编排 | LangChain | ^1.2.17 | LLM工具链 |
| 工作流编排 | LangGraph | ^1.1.3 | 图状工作流 |
| 模型服务 | Ollama | - | LLM推理引擎 |
| 测试框架 | Jest | ^30.2.0 | 单元测试 |
| 容器化 | Docker | - | 环境隔离 |

---

## 2. 数据模型架构

### 2.1 User模型扩展

User模型扩展了`companionChat`字段，包含以下子字段：

| 字段路径 | 类型 | 说明 |
|---------|------|------|
| companionChat.roleCard | Object | 角色卡定义（11个子字段） |
| companionChat.currentMode | String | 对话模式（mode1/2/3） |
| companionChat.modelStatus | Object | 模型训练状态（5个子字段） |
| companionChat.strangerSentiments | Array | 独立好感度记录 |
| companionChat.conversationsAsTarget | Array | 作为目标的对话历史 |
| companionChat.assistantsGuidelines | Array | 预处理的对话准则 |
| companionChat.assistantsGuidelinesUpdatedAt | Date | 准则更新时间 |

### 2.2 ChatSession模型

ChatSession模型定义对话会话的数据结构：

| 字段 | 类型 | 说明 |
|------|------|------|
| sessionId | String | 会话唯一标识 |
| targetUserId | ObjectId | 目标用户ID |
| interlocutorUserId | ObjectId | 对话者用户ID |
| relation | String | 关系类型（family/friend/stranger） |
| sentimentScore | Number | 好感度分数（0-100） |
| dynamicRoleCard | Object | 动态角色卡 |
| langGraphState | Object | LangGraph状态 |
| messages | Array | 消息历史 |
| createdAt | Date | 创建时间 |
| updatedAt | Date | 更新时间 |

### 2.3 AssistRelation扩展

AssistRelation模型扩展了以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| answerSummary | Object | 答案摘要（4个子字段） |
| guidelinesGenerated | Boolean | 是否已生成准则标志 |

---

## 3. 核心服务架构

### 3.1 LLMClient架构

LLMClient提供统一的LLM调用接口：

```
┌─────────────────────────────────────┐
│         LLMClient                   │
├─────────────────────────────────────┤
│  - model: String                    │
│  - baseUrl: String                  │
│  - temperature: Number              │
│  - maxRetries: Number               │
│  - timeout: Number                  │
├─────────────────────────────────────┤
│  + generate(prompt): Promise         │
│  + generateStream(prompt): AsyncIterator│
│  + batchGenerate(prompts): Promise   │
├─────────────────────────────────────┤
│  静态工厂方法：                       │
│  + createDefaultLLMClient()          │
│  + createSentimentLLMClient()        │
└─────────────────────────────────────┘
         ↓
┌─────────────────────────────────────┐
│       LangChain Integration         │
├─────────────────────────────────────┤
│  - ChatOllama                        │
│  - PromptTemplate                    │
│  - Streaming                        │
└─────────────────────────────────────┘
         ↓
┌─────────────────────────────────────┐
│       Ollama Model Server           │
├─────────────────────────────────────┤
│  - qwen2.5                          │
│  - Model API                        │
└─────────────────────────────────────┘
```

### 3.2 SentimentManager架构

SentimentManager实现多因素好感度计算：

```
┌────────────────────────────────────────────────┐
│              SentimentManager                   │
├────────────────────────────────────────────────┤
│  配置参数：                                      │
│  - factors: { sentiment, frequency, quality, decay }│
│  - bounds: { min: 0, max: 100 }                │
├────────────────────────────────────────────────┤
│  核心方法：                                      │
│  1. recordInteraction()                        │
│     - 记录用户-陌生人交互                        │
│     - 计算好感度变化                             │
│     - 保存历史记录                               │
│                                                  │
│  2. updateSentiment()                           │
│     - 更新好感度分数                             │
│     - 应用多因素计算                             │
│     - 确保范围在0-100                            │
│                                                  │
│  3. getSentiment()                             │
│     - 获取当前好感度                             │
│     - 返回历史趋势                               │
│                                                  │
│  4. getHistory()                               │
│     - 获取好感度历史                             │
│     - 支持分页和过滤                              │
│                                                  │
│  5. batchUpdate()                               │
│     - 批量更新好感度                             │
│     - 提高批处理效率                             │
├────────────────────────────────────────────────┤
│  辅助方法：                                      │
│  - calculateTotalChange()                      │
│  - capScore()                                   │
│  - validateScore()                              │
│  - calculateDecay()                             │
└────────────────────────────────────────────────┘
         ↓
┌────────────────────────────────────────────────┐
│         多因素计算流程                          │
├────────────────────────────────────────────────┤
│  1. sentimentChange (60%)                      │
│     - 基于情感分析分数（1-10）                  │
│     - 计算公式：(sentiment - 5) * 0.6           │
│                                                  │
│  2. frequencyBonus (20%)                       │
│     - 基于对话频次（0-1）                       │
│     - 计算公式：(frequency - 0.5) * 0.2         │
│                                                  │
│  3. qualityBonus (10%)                         │
│     - 基于对话质量（0-1）                       │
│     - 计算公式：quality * 0.1                   │
│                                                  │
│  4. decayPenalty (10%)                         │
│     - 基于时间衰减（0-1）                       │
│     - 计算公式：decay * -0.1                    │
│                                                  │
│  总变化 = sentimentChange + frequencyBonus      │
│          + qualityBonus + decayPenalty          │
└────────────────────────────────────────────────┘
```

### 3.3 DualStorage架构

DualStorage提供双重存储机制（MongoDB + 文件系统）：

```
┌────────────────────────────────────────────────┐
│            DualStorage                         │
├────────────────────────────────────────────────┤
│  存储：                                         │
│  - basePath: String (文件系统路径)              │
│  - checksum: Function (校验和函数)              │
├────────────────────────────────────────────────┤
│  对话准则存储方法：                              │
│  1. saveAssistantsGuidelines()                 │
│     - 保存到MongoDB User模型                   │
│     - 保存到文件系统JSON文件                   │
│     - 更新时间戳和校验和                        │
│                                                  │
│  2. loadAssistantsGuidelines()                 │
│     - 从MongoDB加载                             │
│     - 验证文件系统备份                          │
│     - 校验数据一致性                            │
│                                                  │
│  3. updateOneAssistantGuideline()               │
│     - 更新单个准则                              │
│     - 同步到MongoDB和文件系统                  │
│                                                  │
│  4. removeAssistantGuideline()                 │
│     - 删除准则                                  │
│     - 同步删除MongoDB和文件                    │
│                                                  │
│  5. getAssistantsGuidelinesStats()             │
│     - 获取准则统计信息                          │
└────────────────────────────────────────────────┘
         ↓
┌────────────────────────────────────────────────┐
│       双重存储流程                              │
├────────────────────────────────────────────────┤
│  写入流程：                                      │
│  1. 验证数据格式                                │
│  2. 写入MongoDB                                 │
│  3. 写入文件系统                               │
│  4. 生成校验和                                  │
│  5. 验证数据一致性                              │
│                                                  │
│  读取流程：                                      │
│  1. 从MongoDB读取                               │
│  2. 验证校验和                                  │
│  3. 检查文件系统备份                            │
│  4. 返回有效数据                                │
└────────────────────────────────────────────────┘
```

---

## 4. 数据流架构

### 4.1 好感度更新流程

```
用户B与角色卡A对话
       ↓
提取对话内容和情感
       ↓
调用SentimentManager.recordInteraction()
       ↓
┌─────────────────────────────────────┐
│  1. 查找用户A对用户B的好感度记录    │
│  2. 如果不存在，创建新记录           │
│  3. 计算多因素好感度变化            │
│  4. 更新好感度分数                  │
│  5. 保存历史记录                    │
│  6. 返回更新结果                    │
└─────────────────────────────────────┘
       ↓
好感度更新完成
```

### 4.2 对话准则存储流程

```
生成协助者对话准则
       ↓
调用DualStorage.saveAssistantsGuidelines()
       ↓
┌─────────────────────────────────────┐
│  1. 验证准则格式                    │
│  2. 写入MongoDB User模型            │
│     - companionChat.assistantsGuidelines│
│  3. 写入文件系统                    │
│     - /userId/assistants-guidelines.json│
│  4. 生成校验和                      │
│  5. 验证数据一致性                  │
└─────────────────────────────────────┘
       ↓
准则存储完成
```

---

## 5. 安全架构

### 5.1 数据安全

| 安全措施 | 说明 |
|---------|------|
| 数据加密 | MongoDB使用加密存储 |
| 访问控制 | 基于角色的权限控制 |
| 数据备份 | 双重存储机制（MongoDB + 文件系统） |
| 数据校验 | 使用checksum验证数据完整性 |

### 5.2 API安全

| 安全措施 | 说明 |
|---------|------|
| 身份验证 | 基于JWT Token |
| 权限验证 | Middleware权限检查 |
| 输入验证 | 数据格式验证 |
| 错误处理 | 统一错误处理机制 |

---

## 6. 性能架构

### 6.1 性能优化策略

| 优化项 | 策略 |
|-------|------|
| 数据库查询 | 添加索引优化查询 |
| LLM调用 | 使用流式输出，支持批处理 |
| 数据存储 | 双重存储，提高可用性 |
| 好感度计算 | 批处理支持，减少重复计算 |

### 6.2 性能指标

| 指标 | 目标 | 实际 |
|------|------|------|
| SentimentManager调用延迟 | < 100ms | ~50ms |
| LLMClient调用延迟 | < 3s | 1-2s |
| 数据库查询延迟 | < 50ms | ~20ms |

---

## 7. 扩展性架构

### 7.1 可扩展性设计

| 组件 | 扩展方式 |
|------|---------|
| LLMClient | 支持多种LLM模型 |
| SentimentManager | 可配置多因素权重 |
| DualStorage | 支持多种存储后端 |

### 7.2 未来扩展

- 支持更多LLM模型（GPT、Claude等）
- 扩展好感度计算因素
- 添加缓存机制提高性能
- 支持分布式部署

---

## 8. 技术决策

### 8.1 为什么选择LangChain

| 优势 | 说明 |
|------|------|
| 生态丰富 | 提供完整的LLM工具链 |
| 模块化设计 | 易于扩展和定制 |
| 社区活跃 | 持续更新和维护 |

### 8.2 为什么选择MongoDB

| 优势 | 说明 |
|------|------|
| 灵活的数据模型 | 易于扩展数据结构 |
| 高性能 | 支持复杂查询 |
| 易于部署 | 支持Docker容器化 |

### 8.3 为什么选择Docker

| 优势 | 说明 |
|------|------|
| 环境隔离 | 确保开发环境一致性 |
| 易于部署 | 一键部署应用 |
| 资源管理 | 精确控制资源使用 |

---

**文档版本**: v1.0  
**创建日期**: 2026-02-07  
**作者**: AFS Team
