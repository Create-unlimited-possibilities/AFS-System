# Phase 1 部署指南

> **版本**: v1.0  
> **创建日期**: 2026-02-07  
> **作者**: AFS Team  
> **最后更新**: 2026-02-07  

---

## 1. 部署概述

### 1.1 部署架构

Phase 1采用Docker容器化部署，包含三个主要服务：

| 服务 | 镜像 | 端口 | 说明 |
|------|------|------|------|
| server | node:18-alpine | 3001:3001 | 应用服务器 |
| mongodb | mongo:7 | 27018:27017 | MongoDB数据库 |
| modelserver | ollama/ollama | 11434:11434 | Ollama模型服务 |

### 1.2 部署流程

```
环境准备
    ↓
配置环境变量
    ↓
启动MongoDB服务
    ↓
启动Ollama模型服务
    ↓
启动应用服务
    ↓
验证部署
```

---

## 2. 环境准备

### 2.1 系统要求

| 资源 | 最低要求 | 推荐配置 |
|------|---------|---------|
| 操作系统 | Linux/macOS/Windows | Linux (Ubuntu 20.04+) |
| CPU | 2核心 | 4核心 |
| 内存 | 4GB | 8GB |
| 磁盘空间 | 20GB | 50GB |
| Docker | 20.10+ | 24.0+ |
| Docker Compose | 2.0+ | 2.20+ |
| Node.js | 18.x | 18.17+ |

### 2.2 必需软件

| 软件 | 版本 | 用途 |
|------|------|------|
| Docker | 20.10+ | 容器化部署 |
| Docker Compose | 2.0+ | 服务编排 |
| Git | 最新 | 代码管理 |

### 2.3 网络要求

| 端口 | 协议 | 用途 |
|------|------|------|
| 3001 | TCP | 应用服务 |
| 27018 | TCP | MongoDB |
| 11434 | TCP | Ollama模型服务 |

---

## 3. 配置环境变量

### 3.1 创建配置文件

从项目根目录复制示例配置文件：

| 源文件 | 目标文件 | 说明 |
|-------|---------|------|
| .env.example | .env | 应用环境变量 |

### 3.2 配置项说明

根据部署环境修改`.env`文件中的以下配置：

| 配置项 | 说明 | 默认值 | 注意事项 |
|-------|------|--------|---------|
| MONGODB_URI | MongoDB连接字符串 | mongodb://localhost:27018/afs_test | 容器内使用服务名 |
| MODEL_SERVER_URL | Ollama服务地址 | http://localhost:11434 | 容器内使用服务名 |
| JWT_SECRET | JWT密钥 | your-secret-key | 生产环境必须修改 |
| PORT | 应用端口 | 3001 | 根据需要调整 |

### 3.3 生产环境配置

生产环境需要额外配置以下项：

| 配置项 | 说明 | 建议值 |
|-------|------|-------|
| NODE_ENV | 运行环境 | production |
| JWT_SECRET | JWT密钥 | 使用强随机字符串 |
| MONGODB_URI | MongoDB连接 | 使用认证和SSL |
| LOG_LEVEL | 日志级别 | info或warn |

---

## 4. Docker部署

### 4.1 部署架构

```
┌─────────────────────────────────────────────┐
│               Docker Network                 │
├─────────────────────────────────────────────┤
│                                             │
│  ┌─────────────┐    ┌──────────────┐       │
│  │   server    │───→│   mongodb    │       │
│  │  (Node.js)  │    │   (MongoDB)  │       │
│  │  :3001      │    │   :27017     │       │
│  └─────────────┘    └──────────────┘       │
│        │                                   │
│        ↓                                   │
│  ┌──────────────────┐                      │
│  │   modelserver    │                      │
│  │   (Ollama)       │                      │
│  │   :11434         │                      │
│  └──────────────────┘                      │
│                                             │
└─────────────────────────────────────────────┘
```

### 4.2 构建镜像

Phase 1使用预构建的Docker镜像：

| 镜像 | 说明 |
|------|------|
| node:18-alpine | 应用基础镜像 |
| mongo:7 | MongoDB镜像 |
| ollama/ollama | Ollama模型服务镜像 |

### 4.3 启动服务

使用Docker Compose启动所有服务：

| 步骤 | 说明 |
|------|------|
| 1. 构建服务镜像 | docker-compose build |
| 2. 启动所有服务 | docker-compose up -d |
| 3. 查看服务状态 | docker-compose ps |
| 4. 查看服务日志 | docker-compose logs -f |

### 4.4 服务启动顺序

正确的服务启动顺序：

```
1. MongoDB服务
    ↓
2. Ollama模型服务
    ↓
3. 应用服务器服务
```

### 4.5 健康检查

应用启动后自动执行健康检查：

| 检查项 | 说明 |
|-------|------|
| MongoDB连接 | 验证数据库连接 |
| Ollama服务 | 验证模型服务可用性 |
| 应用端口 | 验证3001端口可访问 |

---

## 5. 数据持久化

### 5.1 数据卷配置

Docker Compose配置了以下数据卷：

| 服务 | 数据卷 | 说明 |
|------|--------|------|
| mongodb | mongodb_data | MongoDB数据 |
| server | app_data | 应用数据文件 |

### 5.2 数据备份

建议定期备份以下数据：

| 数据类型 | 位置 | 备份策略 |
|---------|------|---------|
| MongoDB数据 | /data/db | 每日备份 |
| 应用数据 | /app/data | 每周备份 |
| 配置文件 | 项目根目录 | 版本控制 |

---

## 6. 模型服务部署

### 6.1 拉取模型

Ollama服务启动后需要拉取模型：

| 操作 | 说明 |
|------|------|
| 进入容器 | docker exec -it afs-system-modelserver-1 bash |
| 拉取模型 | ollama pull qwen2.5 |
| 验证模型 | ollama list |

### 6.2 模型配置

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| 模型名称 | qwen2.5 | 固定 |
| 模型大小 | ~4GB | 根据模型版本 |
| 显存需求 | ~4GB | 根据模型大小 |

---

## 7. 应用服务部署

### 7.1 应用初始化流程

```
启动应用服务
    ↓
加载环境变量
    ↓
连接MongoDB
    ↓
验证Ollama服务
    ↓
初始化数据模型
    ↓
启动HTTP服务
    ↓
✅ 部署完成
```

### 7.2 应用日志

查看应用日志：

| 日志级别 | 说明 |
|---------|------|
| error | 错误信息 |
| warn | 警告信息 |
| info | 应用信息 |
| debug | 调试信息 |

### 7.3 应用监控

监控应用健康状态：

| 指标 | 端点 |
|------|------|
| 健康检查 | GET /health |
| 应用状态 | GET /status |
| 指标数据 | GET /metrics |

---

## 8. 验证部署

### 8.1 服务状态检查

检查所有服务运行状态：

| 服务 | 检查命令 | 预期结果 |
|------|---------|---------|
| server | docker ps | 状态为Up |
| mongodb | docker ps | 状态为Up |
| modelserver | docker ps | 状态为Up |

### 8.2 服务连接测试

测试服务间连接：

| 连接 | 测试方法 | 预期结果 |
|------|---------|---------|
| server → mongodb | 应用日志 | 连接成功 |
| server → modelserver | LLM调用 | 响应正常 |
| 客户端 → server | HTTP请求 | 响应正常 |

### 8.3 功能验证

验证核心功能：

| 功能 | 验证方法 | 预期结果 |
|------|---------|---------|
| 好感度计算 | SentimentManager测试 | 计算正确 |
| LLM调用 | LLMClient测试 | 响应正常 |
| 数据存储 | DualStorage测试 | 存储成功 |

---

## 9. 常见部署场景

### 9.1 开发环境部署

| 步骤 | 说明 |
|------|------|
| 1. 克隆代码 | git clone |
| 2. 复制配置 | cp .env.example .env |
| 3. 启动服务 | docker-compose up -d |
| 4. 安装依赖 | docker exec -it afs-system-server-1 npm install |
| 5. 运行测试 | docker exec -it afs-system-server-1 npm test |

### 9.2 生产环境部署

| 步骤 | 说明 |
|------|------|
| 1. 配置环境变量 | 修改.env，设置生产环境值 |
| 2. 设置JWT_SECRET | 使用强随机字符串 |
| 3. 配置数据库连接 | 使用认证和SSL |
| 4. 启动服务 | docker-compose up -d |
| 5. 配置反向代理 | Nginx/Apache |
| 6. 配置SSL证书 | Let's Encrypt |

### 9.3 更新部署

| 步骤 | 说明 |
|------|------|
| 1. 拉取最新代码 | git pull |
| 2. 重新构建镜像 | docker-compose build |
| 3. 重启服务 | docker-compose up -d |
| 4. 验证更新 | 检查日志和功能 |

---

## 10. 部署后维护

### 10.1 日志管理

| 日志类型 | 位置 | 保留策略 |
|---------|------|---------|
| 应用日志 | /app/logs | 30天 |
| Docker日志 | docker logs | 7天 |
| 系统日志 | /var/log | 90天 |

### 10.2 监控指标

| 指标 | 阈值 | 告警 |
|------|------|------|
| CPU使用率 | > 80% | 告警 |
| 内存使用率 | > 85% | 告警 |
| 磁盘使用率 | > 90% | 告警 |
| 响应时间 | > 3s | 告警 |

### 10.3 备份策略

| 备份类型 | 频率 | 保留时间 |
|---------|------|---------|
| 数据库备份 | 每日 | 30天 |
| 应用数据备份 | 每周 | 4周 |
| 配置文件备份 | 每次修改 | 永久 |

---

## 11. 性能优化

### 11.1 资源配置

Docker Compose资源配置：

| 服务 | CPU限制 | 内存限制 |
|------|---------|---------|
| server | 2核心 | 2GB |
| mongodb | 2核心 | 4GB |
| modelserver | 4核心 | 8GB |

### 11.2 并发配置

| 配置项 | 推荐值 |
|-------|-------|
| Node.js Worker | CPU核心数 |
| MongoDB连接池 | 10-20 |
| LLM并发请求数 | 2-4 |

---

## 12. 安全加固

### 12.1 网络安全

| 安全措施 | 说明 |
|---------|------|
| 端口限制 | 只开放必要端口 |
| 防火墙规则 | 限制访问来源 |
| SSL/TLS | 使用HTTPS加密 |

### 12.2 应用安全

| 安全措施 | 说明 |
|---------|------|
| JWT密钥 | 使用强随机字符串 |
| 数据库认证 | 启用MongoDB认证 |
| 输入验证 | 严格验证所有输入 |

---

## 13. 故障恢复

### 13.1 服务重启

重启单个服务：

| 命令 | 说明 |
|------|------|
| docker-compose restart server | 重启应用服务 |
| docker-compose restart mongodb | 重启MongoDB |
| docker-compose restart modelserver | 重启Ollama |

### 13.2 数据恢复

从备份恢复数据：

| 步骤 | 说明 |
|------|------|
| 1. 停止服务 | docker-compose down |
| 2. 恢复数据 | mongorestore |
| 3. 重启服务 | docker-compose up -d |
| 4. 验证数据 | 检查数据完整性 |

---

## 14. 扩展部署

### 14.1 水平扩展

扩展应用服务实例：

| 方法 | 说明 |
|------|------|
| Docker Compose Scale | docker-compose up -d --scale server=3 |
| 负载均衡 | 使用Nginx/Haproxy |

### 14.2 集群部署

多节点集群部署：

| 组件 | 说明 |
|------|------|
| MongoDB副本集 | 高可用数据库 |
| 应用集群 | 多实例负载均衡 |
| 模型服务集群 | 分布式推理 |

---

**文档版本**: v1.0  
**创建日期**: 2026-02-07  
**作者**: AFS Team
