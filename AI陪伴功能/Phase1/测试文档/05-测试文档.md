# Phase 1 测试文档

## 1. 测试概述

### 1.1 测试框架
- **框架**: Jest v30.2.0
- **运行环境**: Node.js + Docker容器
- **模块系统**: ES Modules
- **代码覆盖率目标**: 80%

### 1.2 测试文件结构
```
tests/
├── setup.js                    # 全局测试配置（230行）
├── basic.test.js               # 基础功能测试（55行）
├── verify.js                   # 验证脚本
├── fixtures/                   # 测试数据
│   ├── mock-users.json
│   ├── mock-sessions.json
│   └── mock-guidelines.json
├── unit/                       # 单元测试
│   ├── sentimentManager.test.js    # 566行，58个测试
│   ├── dualStorage.test.js         # 388行，45个测试
│   ├── llmClient.test.js          # 347行，32个测试
│   └── chatSession.test.js        # 361行，35个测试
└── integration/                # 集成测试
    └── api.integration.test.js    # 386行，28个测试
```

### 1.3 测试统计
- **总文件数**: 8个
- **总代码行数**: 2,362行
- **测试套件**: 6个
- **测试用例**: 101个
- **通过**: 61个（60.4%）
- **失败**: 40个（39.6%）
- **代码覆盖率**:
  - 语句覆盖率: 8.52%
  - 分支覆盖率: 10.77%
  - 行覆盖率: 8.74%
  - 函数覆盖率: 9.26%

---

## 2. 测试执行方法

### 2.1 运行所有测试
```bash
cd server
docker exec afs-system-server-1 npm test
```

### 2.2 运行单元测试
```bash
npm run test:unit
```

### 2.3 运行集成测试
```bash
npm run test:integration
```

### 2.4 生成覆盖率报告
```bash
npm run test:coverage
```

覆盖率报告位置: `coverage/`目录
- HTML报告: `coverage/lcov-report/index.html`
- LCOV数据: `coverage/lcov.info`

---

## 3. 已知问题

### 3.1 ES模块Mock问题（主要阻碍）

**问题描述**:
- Jest在ES模块环境中无法使用`jest.mock()`
- 5个单元测试文件因mock失败无法执行
- 错误信息: `ReferenceError: require is not defined`

**受影响的文件**:
- tests/unit/sentimentManager.test.js
- tests/unit/dualStorage.test.js
- tests/unit/llmClient.test.js
- tests/unit/chatSession.test.js

**尝试的解决方案**:

#### 方案1: 转换测试文件为ES6语法
```javascript
// 从CommonJS
const { jest } = require('@jest/globals');

// 转换为ES6
import { jest } from '@jest/globals';
```
**结果**: ✅ 语法转换成功，但mock问题未解决

#### 方案2: 配置Babel转译
```javascript
// babel.config.cjs
module.exports = {
  presets: [
    ['@babel/preset-env', {
      targets: { node: 'current' }
    }]
  ]
};
```
**结果**: ⚠️ 配置成功，但jest.mock()仍不兼容

#### 方案3: 使用jest.unstable_mockModule
```javascript
jest.unstable_mockModule('fs/promises', () => ({ ... }));
```
**结果**: ❌ 在当前Jest版本中不稳定

**当前状态**: 未完全解决

**建议的后续方案**:
1. 将测试文件改为CommonJS（.cjs扩展名）
2. 降级Jest到27.x版本（更好的ESM支持）
3. 迁移到Vitest（原生ESM支持）

### 3.2 集成测试失败

**失败的测试**:
- `should update sentiment through API` (超时)
- `should handle malformed request data` (期望状态码不匹配)
- `should handle large payload` (返回413而非500)

**分析**:
- 超时问题: 可能是LLM调用时间过长
- 状态码问题: 测试期望与实际行为不符
- 载荷限制: Express的body-parser限制

**建议修复**:
- 增加超时时间
- 修正测试期望值
- 配置Express的body大小限制

---

## 4. 覆盖率分析

### 4.1 覆盖率详情

| 文件 | 语句 | 分支 | 函数 | 行数 |
|------|------|------|------|------|
| services/langchain/sentimentManager.js | 39.64% | 44.85% | 52.17% | 39.88% |
| utils/llmClient.js | 100% | 86.36% | 100% | 100% |
| services/dualStorage.js | 0% | 0% | 0% | 0% |
| models/ChatSession.js | 0% | 100% | 100% | 0% |
| models/User.js | 28.57% | 0% | 0% | 29.62% |
| **整体** | **8.52%** | **10.77%** | **9.26%** | **8.74%** |

### 4.2 未覆盖代码分析

**SentimentManager未覆盖部分**:
- 行54-117: 错误处理逻辑
- 行192-201: 边界条件检查
- 行239-280: 复杂的好感度计算
- 行362,370-413,465-466,499-557: 部分方法

**DualStorage未覆盖原因**:
- 单元测试无法执行（mock问题）
- 集成测试未覆盖存储操作

### 4.3 提高覆盖率计划

**优先级1**: 解决ES模块mock问题
- 预计影响: +40%覆盖率

**优先级2**: 添加集成测试
- 测试DualStorage的5个新方法
- 预计影响: +15%覆盖率

**优先级3**: 完善SentimentManager测试
- 添加边界条件测试
- 添加错误处理测试
- 预计影响: +15%覆盖率

**总计预计**: 从9%提升到80%

---

## 5. 测试最佳实践

### 5.1 单元测试规范
- ✅ 使用`describe`组织测试套件
- ✅ 使用`test`定义测试用例
- ✅ 使用`beforeEach`/`afterEach`清理测试状态
- ✅ 使用mock隔离依赖
- ✅ 使用全局工具函数（global.testUtils）

### 5.2 集成测试规范
- ✅ 使用supertest测试API端点
- ✅ 验证响应状态码
- ✅ 验证响应数据结构
- ✅ 测试错误处理

### 5.3 覆盖率要求
- 目标: 80%
- 最低可接受: 70%
- 强制执行: jest.config.cjs中的coverageThreshold

---

## 6. 性能测试

### 6.1 并发测试
```bash
# 100并发请求测试
Test: should handle concurrent requests
Result: ✅ 通过（19ms）
```

### 6.2 响应时间测试
```bash
# 快速好感度更新
Test: should handle rapid sentiment updates
Result: ✅ 通过（192ms, 10次迭代）
```

---

## 7. 故障排查指南

### 7.1 测试无法运行
**症状**: `ReferenceError: require is not defined`
**原因**: ES模块语法与Jest兼容性问题
**解决方案**: 参见3.1节

### 7.2 覆盖率生成失败
**症状**: `Jest: "global" coverage threshold for statements (80%) not met`
**原因**: 未达到覆盖率目标
**解决方案**: 
1. 查看覆盖率报告
2. 添加缺失的测试用例
3. 或临时降低阈值（仅用于开发）

### 7.3 容器中测试失败
**症状**: 测试在本地通过，容器中失败
**原因**: 环境差异（Node版本、依赖版本等）
**解决方案**: 确保容器环境与配置一致

---

## 8. 附录

### 8.1 Jest配置
```javascript
// jest.config.cjs
module.exports = {
  testEnvironment: 'node',
  moduleFileExtensions: ['js', 'json', 'mjs'],
  testMatch: ['**/__tests__/**/*.test.js', '**/?(*.)+(spec|test).js'],
  testPathIgnorePatterns: ['/node_modules/', '/dist/', '/build/'],
  collectCoverage: true,
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/**/*.test.js',
    '!src/server.js',
    '!src/mongodb/**',
    '!src/utils/logger.js'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  transform: {
    '^.+\\.js$': 'babel-jest'
  },
  setupFilesAfterEnv: ['./tests/setup.js'],
  verbose: true,
  maxWorkers: '50%',
  testTimeout: 10000
};
```

### 8.2 Babel配置
```javascript
// babel.config.cjs
module.exports = {
  presets: [
    ['@babel/preset-env', {
      targets: { node: 'current' }
    }]
  ]
};
```

### 8.3 测试数据示例
```javascript
// Mock用户
global.testUtils.createMockUser({
  _id: '507f1f77bcf86cd799439011',
  companionChat: {
    roleCard: { ... },
    currentMode: 'mode1',
    modelStatus: { ... },
    strangerSentiments: [],
    conversationsAsTarget: [],
    assistantsGuidelines: []
  }
});

// Mock会话
global.testUtils.createMockChatSession({
  sessionId: 'session_123456',
  targetUserId: '...',
  interlocutorUserId: '...',
  relation: 'stranger',
  sentimentScore: 50
});
```

---

**文档版本**: v1.0  
**创建日期**: 2026-02-05  
**作者**: AFS Team  
**最后更新**: 2026-02-05