# Phase 1 故障排查指南

> **版本**: v1.0  
> **创建日期**: 2026-02-07  
> **作者**: AFS Team  
> **最后更新**: 2026-02-07  

---

## 1. 故障排查概述

### 1.1 故障分类

| 类别 | 说明 |
|------|------|
| 测试问题 | 单元测试、集成测试相关 |
| 部署问题 | Docker、服务启动相关 |
| 数据库问题 | MongoDB连接、查询相关 |
| 模型服务问题 | Ollama服务、LLM调用相关 |
| 应用问题 | 应用运行时错误 |

### 1.2 故障排查流程

```
识别问题
    ↓
收集日志
    ↓
定位原因
    ↓
制定方案
    ↓
实施修复
    ↓
验证结果
```

---

## 2. 测试问题

### 2.1 ES模块Mock问题

#### 症状
- 测试运行时出现：`ReferenceError: require is not defined`
- 单元测试无法执行
- Mock功能失效

#### 影响范围
| 测试文件 | 影响程度 |
|---------|---------|
| tests/unit/sentimentManager.test.js | 严重 |
| tests/unit/dualStorage.test.js | 严重 |
| tests/unit/llmClient.test.js | 严重 |
| tests/unit/chatSession.test.js | 严重 |

#### 原因分析
Jest在ES模块环境中无法使用`jest.mock()`，这是Jest与ESM的兼容性问题。

#### 解决方案

| 方案 | 说明 | 优先级 |
|------|------|-------|
| 方案A | 转换测试文件为CommonJS | 中 |
| 方案B | 降级Jest到27.x版本 | 低 |
| 方案C | 迁移到Vitest | 高 |

#### 推荐方案（方案C）
迁移到Vitest：
| 步骤 | 说明 |
|------|------|
| 1. 安装Vitest | npm install -D vitest |
| 2. 修改配置文件 | vitest.config.js |
| 3. 转换测试文件 | 调整导入语法 |
| 4. 运行测试 | vitest |

---

### 2.2 测试覆盖率未达标

#### 症状
- 代码覆盖率仅9%
- 远低于80%目标
- 未覆盖核心服务代码

#### 覆盖率详情

| 文件 | 语句 | 分支 | 函数 | 行数 |
|------|------|------|------|------|
| sentimentManager.js | 39.64% | 44.85% | 52.17% | 39.88% |
| llmClient.js | 100% | 86.36% | 100% | 100% |
| dualStorage.js | 0% | 0% | 0% | 0% |
| chatSession.js | 0% | 100% | 100% | 0% |
| user.js | 28.57% | 0% | 0% | 29.62% |
| **整体** | **8.52%** | **10.77%** | **9.26%** | **8.74%** |

#### 原因分析
- ES模块mock问题导致单元测试无法执行
- 集成测试未覆盖所有服务方法

#### 解决方案
| 步骤 | 预计提升 |
|------|---------|
| 1. 解决ES模块mock问题 | +40% |
| 2. 添加集成测试 | +15% |
| 3. 完善SentimentManager测试 | +15% |
| 4. 添加DualStorage测试 | +10% |

---

### 2.3 集成测试失败

#### 症状
- 集成测试部分失败
- 超时错误
- 状态码不匹配

#### 失败测试

| 测试名称 | 错误类型 | 说明 |
|---------|---------|------|
| should update sentiment through API | 超时 | LLM调用时间过长 |
| should handle malformed request data | 状态码不匹配 | 期望与实际不符 |
| should handle large payload | 载荷限制 | 返回413而非500 |

#### 解决方案

| 问题 | 解决方法 |
|------|---------|
| 超时 | 增加testTimeout配置 |
| 状态码不匹配 | 修正测试期望值 |
| 载荷限制 | 配置Express body-parser限制 |

---

## 3. 部署问题

### 3.1 服务启动失败

#### 症状
- Docker容器启动失败
- 服务无法启动
- 容器立即退出

#### 排查步骤

| 步骤 | 命令 | 检查内容 |
|------|------|---------|
| 1. 检查容器状态 | docker ps -a | 查看容器状态 |
| 2. 查看容器日志 | docker logs <container> | 查看错误信息 |
| 3. 检查环境变量 | docker exec <container> env | 验证配置 |
| 4. 检查端口占用 | netstat -ano \| findstr <port> | 查看端口占用 |

#### 常见原因

| 原因 | 解决方法 |
|------|---------|
| 端口被占用 | 修改端口配置或停止占用进程 |
| 环境变量缺失 | 检查.env文件 |
| 依赖安装失败 | 重新构建镜像 |
| 磁盘空间不足 | 清理Docker空间 |

---

### 3.2 网络连接问题

#### 症状
- 服务间无法通信
- 连接超时
| 网络不通 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 检查Docker网络 | docker network ls |
| 2. 测试服务连通性 | docker exec <container> ping <service> |
| 3. 检查防火墙规则 | 验证端口是否开放 |
| 4. 检查DNS解析 | 测试域名解析 |

#### 常见原因

| 原因 | 解决方法 |
|------|---------|
| Docker网络配置错误 | 重建Docker网络 |
| 防火墙阻止 | 开放必要端口 |
| 服务名错误 | 检查docker-compose.yml |

---

### 3.3 资源不足

#### 症状
- 容器内存不足
- 性能下降
| 服务崩溃 |

#### 排查步骤

| 步骤 | 命令 | 检查内容 |
|------|------|---------|
| 1. 查看资源使用 | docker stats | CPU、内存使用率 |
| 2. 检查磁盘空间 | df -h | 磁盘使用情况 |
| 3. 查看进程 | top | 进程资源占用 |

#### 解决方案

| 资源 | 解决方法 |
|------|---------|
| 内存不足 | 增加容器内存限制 |
| CPU不足 | 增加容器CPU限制 |
| 磁盘不足 | 清理日志和缓存 |

---

## 4. 数据库问题

### 4.1 MongoDB连接失败

#### 症状
- 应用无法连接MongoDB
- 连接超时
| 认证失败 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 检查MongoDB服务 | docker ps |
| 2. 检查连接字符串 | MONGODB_URI配置 |
| 3. 测试连接 | mongosh连接测试 |
| 4. 查看MongoDB日志 | docker logs <mongodb> |

#### 常见原因

| 原因 | 解决方法 |
|------|---------|
| MongoDB未启动 | 启动MongoDB服务 |
| 连接字符串错误 | 修正MONGODB_URI |
| 认证失败 | 检查用户名密码 |
| 网络不通 | 检查Docker网络 |

---

### 4.2 查询性能问题

#### 症状
- 查询响应慢
| 超时错误 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 查看查询日志 | 启用MongoDB日志 |
| 2. 分析查询计划 | explain()方法 |
| 3. 检查索引 | 查看索引使用情况 |

#### 解决方案

| 问题 | 解决方法 |
|------|---------|
| 缺少索引 | 添加索引 |
| 查询不优化 | 优化查询语句 |
| 数据量过大 | 分页查询 |

---

### 4.3 数据一致性

#### 症状
- 数据不同步
| 双重存储不一致 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 对比MongoDB和文件系统 | 检查数据一致性 |
| 2. 查看校验和 | 验证数据完整性 |
| 3. 检查时间戳 | 验证更新时间 |

#### 解决方案

| 问题 | 解决方法 |
|------|---------|
| 数据不一致 | 同步数据 |
| 校验和不匹配 | 重新计算校验和 |

---

## 5. 模型服务问题

### 5.1 Ollama服务启动失败

#### 症状
- Ollama容器启动失败
- 模型服务不可用

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 检查容器状态 | docker ps |
| 2. 查看容器日志 | docker logs <modelserver> |
| 3. 检查GPU支持 | nvidia-smi（如使用GPU） |

#### 常见原因

| 原因 | 解决方法 |
|------|---------|
| 端口被占用 | 修改端口配置 |
| GPU不可用 | 使用CPU模式 |
| 镜像拉取失败 | 重试拉取镜像 |

---

### 5.2 模型加载失败

#### 症状
- 模型无法加载
| 模型调用失败 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 检查模型列表 | docker exec <modelserver> ollama list |
| 2. 拉取模型 | docker exec <modelserver> ollama pull qwen2.5 |
| 3. 测试模型 | docker exec <modelserver> ollama run qwen2.5 |

#### 常见原因

| 原因 | 解决方法 |
|------|---------|
| 模型未拉取 | 拉取所需模型 |
| 模型损坏 | 重新拉取模型 |
| 内存不足 | 增加容器内存 |

---

### 5.3 LLM调用超时

#### 症状
- LLM调用超时
| 响应时间过长 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 检查Ollama服务状态 | 验证服务可用性 |
| 2. 测试模型响应 | 手动测试模型 |
| 3. 检查网络延迟 | ping测试 |

#### 解决方案

| 问题 | 解决方法 |
|------|---------|
| 响应慢 | 增加timeout配置 |
| 网络延迟 | 优化网络配置 |
| 模型性能 | 使用更快的模型 |

---

## 6. 应用问题

### 6.1 应用启动失败

#### 症状
- 应用无法启动
| 启动后立即退出 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 查看应用日志 | docker logs <server> |
| 2. 检查环境变量 | 验证.env配置 |
| 3. 检查依赖安装 | npm install状态 |
| 4. 检查端口占用 | netstat检查 |

#### 常见原因

| 原因 | 解决方法 |
|------|---------|
| 端口被占用 | 修改PORT配置 |
| 依赖缺失 | 重新安装依赖 |
| 配置错误 | 检查环境变量 |

---

### 6.2 API请求失败

#### 症状
- API请求失败
| 返回错误状态码 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 查看请求日志 | 检查请求参数 |
| 2. 查看错误日志 | 检查错误堆栈 |
| 3. 测试API端点 | 使用curl测试 |

#### 常见原因和解决方案

| 状态码 | 原因 | 解决方法 |
|-------|------|---------|
| 400 | 请求参数错误 | 检查请求格式 |
| 401 | 认证失败 | 检查JWT Token |
| 403 | 权限不足 | 检查用户权限 |
| 404 | 资源不存在 | 检查请求路径 |
| 500 | 服务器错误 | 查看错误日志 |

---

### 6.3 性能问题

#### 症状
- 响应时间过长
| CPU/内存使用率高 |

#### 排查步骤

| 步骤 | 检查内容 |
|------|---------|
| 1. 查看性能指标 | CPU、内存使用率 |
| 2. 分析慢查询 | MongoDB查询分析 |
| 3. 查看LLM调用时间 | LLM响应时间 |

#### 解决方案

| 问题 | 解决方法 |
|------|---------|
| 数据库查询慢 | 优化查询，添加索引 |
| LLM调用慢 | 增加timeout，使用缓存 |
| 内存泄漏 | 查找内存泄漏点 |

---

## 7. 日志收集

### 7.1 日志位置

| 日志类型 | 位置 |
|---------|------|
| 应用日志 | /app/logs |
| Docker日志 | docker logs <container> |
| MongoDB日志 | /var/log/mongodb |
| 系统日志 | /var/log/syslog |

### 7.2 日志级别

| 级别 | 说明 |
|------|------|
| error | 错误信息，需要立即处理 |
| warn | 警告信息，需要关注 |
| info | 一般信息，正常运行 |
| debug | 调试信息，问题排查 |

---

## 8. 工具和命令

### 8.1 Docker命令

| 命令 | 说明 |
|------|------|
| docker ps | 查看运行中的容器 |
| docker ps -a | 查看所有容器 |
| docker logs <container> | 查看容器日志 |
| docker exec -it <container> bash | 进入容器 |
| docker stats | 查看资源使用 |

### 8.2 MongoDB命令

| 命令 | 说明 |
|------|------|
| mongosh | MongoDB Shell |
| db.stats() | 数据库统计 |
| db.collection.stats() | 集合统计 |
| db.collection.getIndexes() | 查看索引 |

### 8.3 测试命令

| 命令 | 说明 |
|------|------|
| npm test | 运行所有测试 |
| npm run test:unit | 运行单元测试 |
| npm run test:integration | 运行集成测试 |
| npm run test:coverage | 生成覆盖率报告 |

---

## 9. 获取帮助

### 9.1 自助资源

| 资源 | 地址 |
|------|------|
| LangChain文档 | https://js.langchain.com/ |
| Ollama文档 | https://ollama.com/docs |
| MongoDB文档 | https://docs.mongodb.com/ |
| Jest文档 | https://jestjs.io/ |

### 9.2 联系支持

如需技术支持，请提供以下信息：

| 信息项 | 说明 |
|-------|------|
| 系统环境 | 操作系统、Docker版本等 |
| 错误信息 | 完整的错误日志 |
| 复现步骤 | 问题的复现步骤 |
| 期望结果 | 期望的正确行为 |

---

**文档版本**: v1.0  
**创建日期**: 2026-02-07  
**作者**: AFS Team
