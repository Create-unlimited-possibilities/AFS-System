# Phase 2 故障排查

## 1. LLM调用问题

### 1.1 LLM调用超时

**症状**:
```
TimeoutError: Request timed out after 30000ms
```

**原因**:
- Ollama服务未响应
- 网络连接问题
- LLM配置错误

**解决方案**:

#### 方案1: 检查Ollama服务状态
```bash
# 检查Ollama服务是否运行
curl http://localhost:11434/api/tags

# 检查Ollama进程
ps aux | grep ollama
```

#### 方案2: 检查Ollama配置
- 检查环境变量 `MODEL_SERVER_URL`
- 检查环境变量 `LLM_MODEL`
- 验证配置格式是否正确

#### 方案3: 增加超时时间
- 修改环境变量 `LLM_TIMEOUT`
- 推荐值: `60000` (60秒)

---

### 1.2 LLM调用失败

**症状**:
```
Error: LLM调用失败: Connection refused
```

**原因**:
- LLM服务未启动
- 网络连接失败
- 配置错误

**解决方案**:

#### 方案1: 启动Ollama服务
```bash
# 启动Ollama服务
ollama serve

# 或使用Docker
docker run -d -p 11434:11434 ollama/ollama
```

#### 方案2: 验证降级策略
- 检查降级策略配置 `FALLBACK_STRATEGY`
- 验证API LLM或本地Ollama至少有一个可用

#### 方案3: 检查网络连接
- 检查防火墙设置
- 检查网络配置
- 使用ping/telnet测试连接

---

### 1.3 降级策略不生效

**症状**:
```
降级策略配置为api-local，但失败后未降级
```

**原因**:
- 降级策略配置错误
- API LLM和本地Ollama都不可用

**解决方案**:

#### 方案1: 验证降级策略配置
- 检查环境变量 `FALLBACK_STRATEGY`
- 确保值为 `api-local` 或 `local-api`

#### 方案2: 验证LLM配置
- 确保API LLM或本地Ollama至少有一个可用
- 运行配置验证测试

#### 方案3: 使用none策略
- 如不需要降级，设置 `FALLBACK_STRATEGY=none`
- 任何LLM失败都会直接返回错误

---

## 2. API路由问题

### 2.1 401 Unauthorized错误

**症状**:
```
Expected 200 but received 401
```

**原因**:
- 未提供Token
- Token无效
- Token过期

**解决方案**:

#### 方案1: 检查Token是否提供
- 检查请求头 `Authorization: Bearer {token}` 是否存在

#### 方案2: 验证Token有效性
- 检查Token格式是否正确
- 检查Token是否过期
- 使用在线工具验证Token

#### 方案3: 重新生成Token
- 使用有效的用户ID重新生成Token
- 确保JWT_SECRET配置正确

---

### 2.2 403 Forbidden错误

**症状**:
```
Expected 200 but received 403
```

**原因**:
- 用户没有所需权限
- 用户角色配置错误
- 权限中间件配置错误

**解决方案**:

#### 方案1: 检查用户角色
- 确保用户有分配角色
- 检查角色是否包含所需权限
- 验证权限名称是否正确

#### 方案2: 检查权限配置
- 确保权限中间件正确配置
- 检查权限名称是否与数据库一致
- 验证requirePermission调用参数

#### 方案3: 分配角色权限
- 为用户角色添加所需权限
- 使用 `companionship:view`, `companionship:create`, `companionship:update` 权限

---

### 2.3 404 Not Found错误

**症状**:
```
Expected 200 but received 404
```

**原因**:
- 角色卡不存在
- 对话准则不存在
- 协助关系不存在

**解决方案**:

#### 方案1: 角色卡不存在
- 先调用生成角色卡API
- 检查A套题进度是否≥80%

#### 方案2: 对话准则不存在
- 先调用预处理对话准则API
- 确保协助关系存在

#### 方案3: 协助关系不存在
- 先创建协助关系
- 检查assist_relation_id是否正确

---

## 3. 数据一致性问题

### 3.1 MongoDB和文件系统数据不一致

**症状**:
```
数据一致性验证失败: MongoDB和文件系统数据不一致
```

**原因**:
- 写入过程中发生错误
- 并发写入冲突
- 文件系统权限问题

**解决方案**:

#### 方案1: 验证文件系统权限
- 确保应用有写入权限
- 检查存储路径是否存在
- 验证文件系统挂载正常

#### 方案2: 重新生成数据
- 调用API重新生成数据
- 自动修复数据不一致问题

#### 方案3: 手动修复数据
- 检查MongoDB数据
- 检查文件系统数据
- 手动同步数据

---

### 3.2 角色卡生成后无法查询

**症状**:
```
生成角色卡成功，但查询时返回404
```

**原因**:
- 数据库查询条件错误
- Token中的用户ID不正确
- MongoDB事务问题

**解决方案**:

#### 方案1: 检查用户ID
- 验证Token中的用户ID是否正确
- 检查userId参数是否正确
- 确保查询逻辑正确

#### 方案2: 检查查询条件
- 验证查询逻辑
- 检查companionChat.roleCard路径
- 验证查询条件

#### 方案3: 重新生成角色卡
- 调用重新生成API
- 或手动删除后重新生成

---

## 4. 性能问题

### 4.1 API响应慢

**症状**:
```
API响应时间超过5秒
```

**原因**:
- LLM调用耗时过长
- 数据库查询慢
- 文件系统IO慢

**解决方案**:

#### 方案1: 优化LLM调用
- 减少LLM调用次数
- 使用更快的模型
- 优化提示词长度

#### 方案2: 优化数据库查询
- 添加索引
- 优化查询条件
- 使用批量操作

#### 方案3: 优化文件系统
- 使用更快的存储设备
- 减少文件IO次数
- 使用缓存策略

---

### 4.2 内存占用高

**症状**:
```
应用内存占用超过2GB
```

**原因**:
- 大量数据缓存
- 并发请求过多
- 内存泄漏

**解决方案**:

#### 方案1: 减少缓存
- 清理不常用的缓存
- 设置缓存过期时间
- 减少缓存数据量

#### 方案2: 限制并发
- 使用限流中间件
- 减少并发请求数量
- 使用队列处理

#### 方案3: 修复内存泄漏
- 检查是否有未释放的资源
- 检查是否有事件监听器未移除
- 使用内存分析工具定位问题

---

## 5. 测试问题

### 5.1 测试运行失败

**症状**:
```
Test failed: expected 200 but received 401
```

**原因**:
- 测试用户没有权限
- 测试Token无效
- 测试数据未正确清理

**解决方案**:

#### 方案1: 检查测试用户
- 确保测试用户有正确的角色
- 确保测试用户有所需权限

#### 方案2: 重新生成测试Token
- 在beforeEach中重新生成Token
- 确保Token有效

#### 方案3: 清理测试数据
- 在afterEach中清理所有测试数据
- 确测试环境干净

---

### 5.2 测试数据污染

**症状**:
```
AssertionError: expected 10 to be 20
```

**原因**:
- 测试数据未正确清理
- 测试依赖顺序
- 共享测试数据

**解决方案**:

#### 方案1: 加强数据清理
- 在afterEach中清理所有测试数据
- 按依赖关系清理数据（先清理子数据）

#### 方案2: 使用独立数据
- 每个测试套件使用独立的数据
- 避免测试间数据共享

#### 方案3: 调整测试顺序
- 将独立的测试放在前面
- 将有依赖的测试放在后面

---

## 6. 部署问题

### 6.1 应用启动失败

**症状**:
```
Error: Configuration validation failed
```

**原因**:
- 环境变量配置错误
- 依赖缺失
- 配置验证失败

**解决方案**:

#### 方案1: 检查环境变量
- 检查.env文件是否存在
- 检查必需的环境变量是否设置
- 检查环境变量格式是否正确

#### 方案2: 安装依赖
- 运行npm install
- 检查package.json中的依赖
- 验证依赖版本

#### 方案3: 验证配置
- 运行配置验证测试
- 检查LLM配置
- 检查数据库配置
- 检查JWT配置

---

### 6.2 数据库连接失败

**症状**:
```
MongoServerError: connect ECONNREFUSED
```

**原因**:
- MongoDB未启动或连接配置错误

**解决方案**:

#### 方案1: 启动MongoDB
```bash
# 启动MongoDB
mongod --dbpath /path/to/data

# 或使用Docker
docker run -d -p 27017:27017 mongo:latest
```

#### 方案2: 验证连接字符串
- 检查MONGO_URI配置
- 确保格式正确
- 测试连接是否可用

#### 方案3: 检查网络连接
- 检查防火墙设置
- 检查网络配置
- 使用ping/telnet测试连接

---

## 7. 常见问题FAQ

### Q1: Phase 2是否依赖Phase 1？

A: 是的，Phase 2依赖Phase 1的基础设施：
- DualStorage服务
- User模型扩展
- ChatSession模型

### Q2: 如何切换API LLM和本地Ollama？

A: 通过环境变量 `USE_API_LLM`控制：
- `USE_API_LLM=true`: 优先使用API LLM
- `USE_API_LLM=false`: 优先使用本地Ollama

### Q3: 如何配置降级策略？

A: 通过环境变量 `FALLBACK_STRATEGY`配置：
- `api-local`: API优先，失败后降级到本地Ollama
- `local-api`: 本地Ollama优先，失败后降级到API LLM
- `none`: 不降级，直接失败

### Q4: 如何验证数据一致性？

A: 使用DualStorage的验证方法：
- `verifyRoleCardConsistency(userId)`: 验证角色卡一致性
- `verifyGuidelinesConsistency(userId)`: 验证对话准则一致性

### Q5: 如何提高LLM调用性能？

A: 可以通过以下方式：
- 使用更快的模型
- 减少提示词长度
- 使用流式生成
- 增加超时时间
- 优化重试策略

---

**文档版本**: v1.0  
**创建日期**: 2026-02-06  
**作者**: AFS Team  
**最后更新**: 2026-02-06
