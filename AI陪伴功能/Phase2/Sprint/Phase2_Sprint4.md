# Phase 2 Sprint 4：API 路由和测试

---

### **Sprint 目标**

完成 Phase 2 的 API 路由层，提供角色卡生成和对话准则预处理的对接口，并编写完整的集成测试。

---

### **小总结**

本 Sprint 主要是集成和测试工作。将前两个 Sprint 的服务通过 API 暴露，确保所有功能可以正常调用，并验证完整的业务流程。预计时间 15 小时。

---

### **任务列表**

#### **任务 4.1：API 路由整合**（4 小时）

**文件**：`server/routes/companionship.js`

**API 路由**：
- POST /api/companionship/generate-rolecard
- POST /api/companionship/preprocess-guidelines
- POST /api/companionship/preprocess-guideline/:assistantId
- POST /api/companionship/update-guideline/:assistantId
- GET /api/companionship/rolecard
- GET /api/companionship/guidelines/:assistantId
- GET /api/companionship/all-guidelines

**实施要点**：
- 使用 Express Router
- 身份验证中间件
- 统一错误处理
- 请求参数验证

**验收标准**：
- 所有路由正常工作
- 参数验证完善
- 错误处理统一
- 日志记录清晰

---

#### **任务 4.2：集成测试**（8 小时）

**文件**：`tests/integration/companionship.test.js`

**测试场景**：
1. 角色卡生成完整流程
   - A 套题完成 → 生成 → 保存
   - 使用测试用户 dxs@gmail.com

2. 对话准则预处理完整流程
   - 多个协助者 → 收集答案 → 压缩 → 生成准则 → 保存

3. 增量更新单个协助者
   - 重新处理单个协助者
   - 验证更新逻辑

4. 边界条件测试
   - A 套题未完成
   - 没有协助者关系
   - LLM 降级测试
   - 文件系统权限测试

**实施要点**：
- 使用内存数据库
- 测试真实数据流
- 模拟 LLM 响应
- 验证双重存储一致性

**验收标准**：
- 核心流程测试通过
- 边界条件覆盖完整
- 错误处理验证
- 覆盖率 80%+

---

#### **任务 4.3：性能测试**（3 小时）

**测试场景**：
1. 角色卡生成性能
   - LLM 调用时间
   - 数据持久化时间
   - 完整流程时间

2. 对话准则预处理性能
   - 批量处理性能
   - 单个处理性能
   - 双重保存性能

3. 并发处理性能
   - 多个请求同时处理
   - 资源使用监控
   - 响应时间基准

**实施要点**：
- 使用性能监控工具
- 设置性能基准目标
- 记录关键指标

**验收标准**：
- 单个请求响应时间 < 5s
- 批量处理每个 < 10s
- 并发 10 个请求无失败
- 资源使用合理

---

### **文件结构**

```
server/routes/
└── companionship.js          # 更新/新增

tests/integration/
└── companionship.test.js      # 新增
```

---

### **依赖关系**

- 依赖：Sprint 1、Sprint 2、Sprint 3
- 被依赖：无（最后一个 Sprint）

---

### **技术要点**

**API 设计原则**：
- RESTful 格式
- 统一响应格式
- 完善的错误处理
- 详细的日志记录

**错误处理策略**：
- 400：请求参数错误
- 401：用户未认证
- 403：权限不足
- 404：资源不存在
- 500：服务器内部错误
- 提供友好的错误提示

**性能优化要点**：
- 数据库查询优化
- 批量操作使用 bulk write
- 缓存策略（可选）
- 并发控制

---

### **时间线**

- Day 1-2：任务 4.1（4 小时）
- Day 3-4：任务 4.2（8 小时）
- Day 5-6：任务 4.3 + 文档（3 小时）

---

### **风险和缓解**

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| API 路由冲突 | 中 | 命名空间隔离、文档说明 |
| 集成测试复杂度高 | 高 | 模块化测试、逐步验证 |
| 性能不达标 | 中 | 查询优化、异步处理 |
| 文件系统并发问题 | 中 | 文件锁、队列处理 |

---

**END OF SPRINT 4**

---

## 📊 总体总结

### **Phase 2 整体架构**

```
Phase 2 架构层次

┌─────────────────────────────────────────────┐
│        Companionship API Routes         │
│         (统一的对外接口）              │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────────┐
│    AssistantsGuidelinesPreprocessor      │
│         (对话准则预处理）              │
│         ← 依赖 RoleCard           │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────────┐
│       RoleCardGenerator Service         │
│         (角色卡生成）                  │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────────┐
│         MultiLLMClient                │
│       (统一 LLM 调用接口）           │
│              ↓                         │
│    ┌──────────┴─────────────┐    │
│    │    llmConfig           │    │
│    │  (LLM 配置管理)      │    │
│    └─────────────────────────┘    │
└─────────────────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────────┐
│          Dual Storage                  │
│     (MongoDB + 文件系统)            │
└─────────────────────────────────────┘
```

---

### **时间汇总**

| Sprint | 内容 | 预估时间 |
|--------|------|-----------|
| Sprint 1 | LLM 配置管理器 + 多 LLM 客户端 | 8 小时 |
| Sprint 2 | 角色卡生成器 | 15 小时 |
| Sprint 3 | 协助者对话准则预处理器 | 15 小时 |
| Sprint 4 | API 路由和测试 | 15 小时 |
| **总计** | | **53 小时** |

---

### **关键里程碑**

- ✅ Sprint 1 完成：LLM 基础设施就绪
- ✅ Sprint 2 完成：角色卡生成功能可用
- ✅ Sprint 3 完成：对话准则预处理功能可用
- ✅ Sprint 4 完成：API 完整暴露，测试通过

---

### **Phase 2 完成标准**

当满足以下所有标准时，Phase 2 被认为完成：

✅ **功能完整性**
- 角色卡可以成功生成
- 所有协助者对话准则可以成功预处理
- 支持 API KEY 和本地 Ollama 两种方式
- 增量更新机制正常工作

✅ **数据一致性**
- MongoDB 和文件系统数据一致
- 角色卡和对话准则同步正常
- 降级策略有效

✅ **API 质量**
- 所有路由正常响应
- 错误处理完善
- 参数验证完整
- 日志记录清晰

✅ **测试覆盖**
- 核心流程有集成测试
- 边界条件有测试
- 覆盖率 80%+
- 性能符合预期

✅ **文档完整**
- API 文档清晰
- 配置说明详细
- 使用指南完善

---

**END OF SPRINT 4**