# Phase 2 配置说明

## 1. 概述

Phase 2的配置主要涉及LLM服务配置、数据库配置、JWT配置等。本章节详细说明所有配置项的含义、默认值和使用方式。

---

## 2. 环境变量配置

### 2.1 LLM配置

| 变量名 | 类型 | 描述 | 默认值 | 必填 |
|--------|------|------|--------|------|
| USE_API_LLM | Boolean | 是否优先使用API LLM | false | 否 |
| API_LLM_KEY | String | API LLM的密钥 | 无 | 否 |
| API_LLM_BASE_URL | String | API LLM的基础URL | 无 | 否 |
| API_LLM_MODEL | String | API LLM使用的模型名称 | gpt-3.5-turbo | 否 |
| MODEL_SERVER_URL | String | 本地Ollama服务的基础URL | http://modelserver:11434 | 否 |
| LLM_MODEL | String | 本地Ollama使用的模型名称 | qwen2.5 | 否 |
| FALLBACK_STRATEGY | String | 降级策略 (api-local, local-api, none) | api-local | 否 |
| LLM_TIMEOUT | Number | LLM调用的超时时间（毫秒） | 30000 | 否 |
| LLM_MAX_RETRIES | Number | LLM调用的最大重试次数 | 3 | 否 |
| LLM_TEMPERATURE | Number | LLM生成的温度参数 | 0.7 | 否 |

### 2.2 数据库配置

| 变量名 | 类型 | 描述 | 默认值 | 必填 |
|--------|------|------|--------|------|
| MONGO_URI | String | MongoDB连接URI | mongodb://localhost:27018/afs_db | 否 |
| MONGO_TEST_URI | String | 测试数据库连接URI | mongodb://localhost:27018/afs_test | 否 |

### 2.3 JWT配置

| 变量名 | 类型 | 描述 | 默认值 | 必填 |
|--------|------|------|--------|------|
| JWT_SECRET | String | JWT签名的密钥 | afs-super-secret-key-2025-change-me-in-production | 是 |
| JWT_EXPIRES_IN | String | JWT Token的有效期 | 1h | 否 |

### 2.4 文件存储配置

| 变量名 | 类型 | 描述 | 默认值 | 必填 |
|--------|------|------|--------|------|
| STORAGE_PATH | String | 文件存储的基础路径 | /app/storage | 否 |
| USERDATA_PATH | String | 用户数据存储路径 | /app/storage/userdata | 否 |

### 2.5 日志配置

| 变量名 | 类型 | 描述 | 默认值 | 必填 |
|--------|------|------|--------|------|
| LOG_LEVEL | String | 日志级别 (error, warn, info, debug) | info | 否 |
| LOG_FILE_PATH | String | 日志文件存储路径 | /app/logs | 否 |

---

## 3. 配置加载流程

### 3.1 配置加载流程图

```
配置加载流程

应用启动
    ↓
加载环境变量
    ↓
验证配置有效性
    ↓
初始化LLM配置
    │   ├── 检查USE_API_LLM
    │   ├── 验证API配置
    │   ├── 验证本地Ollama配置
    │   └── 设置降级策略
    ↓
初始化数据库连接
    ↓
初始化JWT配置
    ↓
初始化文件存储
    ↓
配置加载完成
```

### 3.2 LLM配置验证流程

```
LLM配置验证流程

开始验证
    ↓
检查降级策略
    ↓
降级策略为none?
├─ Yes → 结束 (不允许使用LLM)
└─ No → 继续
    ↓
检查API LLM配置
    │   ├── API Key存在?
    │   ├── API URL存在?
    │   └── API Model存在?
    ↓
API LLM可用?
├─ Yes → 记录为可用
└─ No → 记录为不可用
    ↓
检查本地Ollama配置
    │   ├── Model Server URL存在?
    │   ├── Ollama Model存在?
    │   └── Ollama服务可用?
    ↓
本地Ollama可用?
├─ Yes → 记录为可用
└─ No → 记录为不可用
    ↓
至少有一种LLM可用?
├─ Yes → 验证通过
└─ No → 抛出错误
```

---

## 4. 降级策略

### 4.1 降级策略类型

| 策略 | 描述 | 行为 |
|------|------|------|
| api-local | 优先使用API LLM，失败后降级到本地Ollama | 先尝试API LLM，失败后使用Ollama |
| local-api | 优先使用本地Ollama，失败后降级到API LLM | 先尝试Ollama，失败后使用API LLM |
| none | 不使用降级，直接失败 | 任何LLM失败都直接返回错误 |

### 4.2 降级策略流程

```
api-local降级策略流程

LLM调用请求
    ↓
检查配置: USE_API_LLM
    ↓
USE_API_LLM = true?
├─ Yes → 使用API LLM
│   │   ↓
│   │  API LLM可用?
│   │   ├─ Yes → 使用API LLM
│   │   │         ↓
│   │   │     调用成功?
│   │   │     ├─ Yes → 返回结果
│   │   │     └─ No → 降级到本地Ollama
│   │   └─ No → 降级到本地Ollama
└─ No → 直接使用本地Ollama
    ↓
使用本地Ollama
    ↓
调用成功?
├─ Yes → 返回结果
└─ No → 抛出错误
```

```
local-api降级策略流程

LLM调用请求
    ↓
检查配置: USE_API_LLM
    ↓
USE_API_LLM = false?
├─ Yes → 使用本地Ollama
│   │   ↓
│   │  本地Ollama可用?
│   │   ├─ Yes → 使用本地Ollama
│   │   │         ↓
│   │   │     调用成功?
│   │   │     ├─ Yes → 返回结果
│   │   │     └─ No → 降级到API LLM
│   │   └─ No → 降级到API LLM
└─ No → 直接使用API LLM
    ↓
使用API LLM
    ↓
调用成功?
├─ Yes → 返回结果
└─ No → 抛出错误
```

### 4.3 降级策略配置示例

#### 4.3.1 使用API优先策略

```env
USE_API_LLM=true
API_LLM_KEY=your-api-key
API_LLM_BASE_URL=https://api.openai.com/v1
API_LLM_MODEL=gpt-3.5-turbo
FALLBACK_STRATEGY=api-local
```

#### 4.3.2 使用本地Ollama优先策略

```env
USE_API_LLM=false
MODEL_SERVER_URL=http://localhost:11434
LLM_MODEL=qwen2.5
FALLBACK_STRATEGY=local-api
```

#### 4.3.3 禁用降级

```env
FALLBACK_STRATEGY=none
```

---

## 5. 配置验证

### 5.1 配置验证规则

| 规则 | 描述 | 失败处理 |
|------|------|---------|
| JWT_SECRET必须存在 | JWT密钥是必需的 | 抛出错误，应用无法启动 |
| 至少有一种LLM可用 | API LLM或本地Ollama至少有一个可用 | 抛出错误，应用无法启动 |
| MongoDB连接必须有效 | MongoDB必须可以连接 | 抛出错误，应用无法启动 |
| 降级策略必须有效 | 降级策略必须是api-local、local-api或none | 使用默认值api-local |

### 5.2 配置验证流程

```
配置验证流程

开始验证
    ↓
验证JWT_SECRET
    │   ↓
    │  JWT_SECRET存在?
    │   ├─ Yes → 继续
    │   └─ No → 抛出错误
    ↓
验证MongoDB连接
    │   ↓
    │  MongoDB可用?
    │   ├─ Yes → 继续
    │   └─ No → 抛出错误
    ↓
验证LLM配置
    │   ↓
    │  降级策略为none?
    │   ├─ Yes → 验证通过
    │   └─ No → 继续验证
    │       ↓
    │      验证API LLM (如配置)
    │      验证本地Ollama
    │       ↓
    │      至少有一种LLM可用?
    │      ├─ Yes → 验证通过
    │      └─ No → 抛出错误
    ↓
所有验证通过
    ↓
应用启动成功
```

---

## 6. 配置示例

### 6.1 生产环境配置

```env
# LLM配置
USE_API_LLM=true
API_LLM_KEY=your-production-api-key
API_LLM_BASE_URL=https://api.openai.com/v1
API_LLM_MODEL=gpt-3.5-turbo
MODEL_SERVER_URL=http://modelserver:11434
LLM_MODEL=qwen2.5
FALLBACK_STRATEGY=api-local
LLM_TIMEOUT=30000
LLM_MAX_RETRIES=3
LLM_TEMPERATURE=0.7

# 数据库配置
MONGO_URI=mongodb://username:password@production-host:27017/afs_db

# JWT配置
JWT_SECRET=your-production-jwt-secret-change-me
JWT_EXPIRES_IN=1h

# 文件存储配置
STORAGE_PATH=/app/storage
USERDATA_PATH=/app/storage/userdata

# 日志配置
LOG_LEVEL=info
LOG_FILE_PATH=/app/logs
```

### 6.2 测试环境配置

```env
# LLM配置
USE_API_LLM=false
MODEL_SERVER_URL=http://modelserver:11434
LLM_MODEL=qwen2.5
FALLBACK_STRATEGY=none
LLM_TIMEOUT=30000
LLM_MAX_RETRIES=3
LLM_TEMPERATURE=0.7

# 数据库配置
MONGO_URI=mongodb://localhost:27018/afs_db
MONGO_TEST_URI=mongodb://localhost:27018/afs_test

# JWT配置
JWT_SECRET=afs-super-secret-key-2025-change-me-in-production
JWT_EXPIRES_IN=1h

# 文件存储配置
STORAGE_PATH=/app/storage
USERDATA_PATH=/app/storage/userdata

# 日志配置
LOG_LEVEL=debug
LOG_FILE_PATH=/app/logs
```

### 6.3 开发环境配置

```env
# LLM配置
USE_API_LLM=false
MODEL_SERVER_URL=http://localhost:11434
LLM_MODEL=qwen2.5
FALLBACK_STRATEGY=none
LLM_TIMEOUT=30000
LLM_MAX_RETRIES=3
LLM_TEMPERATURE=0.7

# 数据库配置
MONGO_URI=mongodb://localhost:27018/afs_db

# JWT配置
JWT_SECRET=afs-super-secret-key-2025-change-me-in-production
JWT_EXPIRES_IN=1h

# 文件存储配置
STORAGE_PATH=./storage
USERDATA_PATH=./storage/userdata

# 日志配置
LOG_LEVEL=debug
LOG_FILE_PATH=./logs
```

---

## 7. 配置最佳实践

### 7.1 安全性

- **生产环境必须使用强JWT_SECRET**
- **生产环境必须使用真实的API_LLM_KEY**
- **不要将敏感信息提交到版本控制**
- **使用环境变量管理配置**

### 7.2 性能

- **合理设置LLM_TIMEOUT**，避免超时等待
- **合理设置LLM_MAX_RETRIES**，避免无限重试
- **合理设置LLM_TEMPERATURE**，平衡创造性和一致性**

### 7.3 可靠性

- **配置降级策略，确保服务可用性**
- **定期备份MongoDB数据**
- **定期备份文件系统数据**
- **监控配置变更**

---

## 8. 配置更新

### 8.1 配置更新流程

```
配置更新流程

修改配置文件
    ↓
验证配置有效性
    ↓
重启应用
    ↓
验证配置生效
    ↓
配置更新完成
```

### 8.2 配置更新注意事项

- **修改JWT_SECRET会导致所有现有Token失效**
- **修改数据库配置需要确保数据迁移**
- **修改LLM配置需要测试降级策略**

---

## 9. 配置故障排查

### 9.1 配置加载失败

**症状**: 应用启动失败，提示配置错误

**原因**: 环境变量未设置或设置错误

**解决方案**:
1. 检查`.env`文件是否存在
2. 检查必需的环境变量是否设置
3. 检查环境变量格式是否正确

### 9.2 LLM调用失败

**症状**: LLM调用返回错误

**原因**: LLM配置错误或LLM服务不可用

**解决方案**:
1. 检查LLM配置是否正确
2. 检查降级策略是否正确
3. 检查LLM服务是否可用
4. 检查网络连接是否正常

### 9.3 数据库连接失败

**症状**: 数据库连接失败

**原因**: MongoDB配置错误或MongoDB服务不可用

**解决方案**:
1. 检查MongoDB配置是否正确
2. 检查MongoDB服务是否启动
3. 检查网络连接是否正常
4. 检查MongoDB用户权限是否正确

---

**文档版本**: v1.0  
**创建日期**: 2026-02-06  
**作者**: AFS Team  
**最后更新**: 2026-02-06
