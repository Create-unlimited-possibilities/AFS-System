# Phase 2 部署指南

## 1. 概述

本指南说明如何部署Phase 2的角色卡生成和对话准则预处理功能到生产环境。

---

## 2. 部署前置条件

### 2.1 系统要求

| 要求 | 最低配置 | 推荐配置 |
|------|---------|---------|
| 操作系统 | Linux 64位 | Linux 64位 |
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 磁盘空间 | 20GB | 50GB+ |
| Node.js | v18.0.0 | v20.0.0+ |
| MongoDB | v5.0.0 | v6.0.0+ |

### 2.2 软件依赖

| 软件 | 版本 | 用途 |
|------|------|------|
| Node.js | v18.0.0+ | 运行时环境 |
| npm | v9.0.0+ | 包管理器 |
| MongoDB | v5.0.0+ | 数据库 |
| Ollama | latest | 本地LLM服务（可选）|

### 2.3 网络要求

| 要求 | 说明 |
|------|------|
| 外网访问 | 需要访问OpenAI API（如使用API LLM） |
| 内网访问 | 需要访问Ollama服务（如使用本地LLM） |
| 端口开放 | 需要开放应用端口（默认3001） |
| MongoDB访问 | 需要访问MongoDB服务 |

---

## 3. 部署步骤

### 3.1 部署流程图

```
部署流程

准备环境
    ↓
安装依赖
    │   ├── 安装Node.js
    │   ├── 安装MongoDB
    │   └── 安装Ollama (可选)
    ↓
下载代码
    ↓
配置环境变量
    ↓
构建项目
    ↓
启动服务
    ↓
验证部署
    ↓
部署完成
```

### 3.2 准备环境

```
环境准备流程

检查系统资源
    │   ├── 检查CPU
    │   ├── 检查内存
    │   └── 检查磁盘空间
    ↓
安装Node.js
    ↓
验证Node.js版本
    ↓
安装MongoDB
    ↓
验证MongoDB版本
    ↓
安装Ollama (可选)
    ↓
验证Ollama版本
    ↓
环境准备完成
```

### 3.3 下载代码

```
代码下载流程

克隆代码仓库
    │   ├── 从Git仓库克隆
    │   ├── 切换到正确分支
    │   └── 拉取最新代码
    ↓
切换到项目目录
    ↓
验证代码完整性
    ↓
代码下载完成
```

### 3.4 配置环境变量

```
环境变量配置流程

创建.env文件
    ↓
配置LLM配置
    │   ├── 配置API LLM (如使用)
    │   ├── 配置本地Ollama (如使用)
    │   └── 配置降级策略
    ↓
配置数据库
    │   ├── 配置MongoDB URI
    │   └── 配置测试数据库URI
    ↓
配置JWT
    │   ├── 配置JWT_SECRET
    │   └── 配置JWT_EXPIRES_IN
    ↓
配置文件存储
    │   ├── 配置STORAGE_PATH
    │   └── 配置USERDATA_PATH
    ↓
配置日志
    │   ├── 配置LOG_LEVEL
    │   └── 配置LOG_FILE_PATH
    ↓
验证配置有效性
    ↓
配置完成
```

### 3.5 构建项目

```
项目构建流程

安装依赖
    │   ├── 运行npm install
    │   ├── 验证依赖安装
    │   └── 验证依赖版本
    ↓
构建项目
    │   ├── 运行npm run build (如需要)
    │   ├── 验证构建产物
    │   └── 验证构建日志
    ↓
运行测试
    │   ├── 运行单元测试
    │   ├── 运行集成测试
    │   └── 验证测试结果
    ↓
构建完成
```

### 3.6 启动服务

```
服务启动流程

准备数据目录
    │   ├── 创建storage目录
    │   ├── 创建logs目录
    │   └── 设置正确的权限
    ↓
启动MongoDB
    ↓
验证MongoDB连接
    ↓
启动Ollama (如需要)
    ↓
验证Ollama连接
    ↓
启动应用
    │   ├── 运行npm start
    │   ├── 验证启动日志
    │   └── 验证服务状态
    ↓
验证服务可用性
    │   ├── 检查健康检查端点
    │   ├── 检查API端点
    │   └── 验证日志输出
    ↓
启动完成
```

---

## 4. 部署检查清单

### 4.1 环境检查清单

| 检查项 | 状态 | 备注 |
|--------|------|------|
| Node.js已安装且版本正确 | | 版本: v18.0.0+ |
| MongoDB已安装且版本正确 | | 版本: v5.0.0+ |
| Ollama已安装（如需要） | | 版本: latest |
| 磁盘空间充足 | | 最少20GB |
| 内存充足 | | 最少4GB |
| 网络连接正常 | | 可以访问外部服务 |

### 4.2 代码检查清单

| 检查项 | 状态 | 备注 |
|--------|------|------|
| 代码已下载且完整 | | 最新代码 |
| 依赖已安装 | | npm install成功 |
| 项目已构建 | | npm run build成功 |
| 测试已通过 | | 测试通过率>90% |

### 4.3 配置检查清单

| 检查项 | 状态 | 备注 |
|--------|------|------|
| .env文件已创建 | | 文件存在 |
| JWT_SECRET已配置 | | 必填项 |
| LLM配置已配置 | | 至少一种LLM可用 |
| MongoDB配置已配置 | | 连接字符串正确 |
| 文件存储路径已配置 | | 路径存在且可写 |
| 日志配置已配置 | | 路径存在且可写 |

### 4.4 服务检查清单

| 检查项 | 状态 | 备注 |
|--------|------|------|
| MongoDB服务已启动 | | 服务运行中 |
| Ollama服务已启动（如需要） | | 服务运行中 |
| 应用服务已启动 | | 服务运行中 |
| 健康检查端点正常 | | 返回200 |
| API端点正常 | | 可以正常调用 |
| 日志正常输出 | | 日志文件正常写入 |

---

## 5. 部署后验证

### 5.1 验证流程图

```
部署验证流程

验证MongoDB连接
    │   ├── 连接成功
    │   ├── 可以查询数据
    │   └── 可以写入数据
    ↓
验证LLM连接
    │   ├── API LLM连接 (如配置)
    │   ├── 本地Ollama连接 (如配置)
    │   └── 降级策略正常工作
    ↓
验证JWT认证
    │   ├── 可以生成Token
    │   ├── 可以验证Token
    │   └── Token过期后正确拒绝
    ↓
验证API端点
    │   ├── 角色卡生成API正常
    │   ├── 对话准则预处理API正常
    │   └── 所有API端点返回正确数据
    ↓
验证数据一致性
    │   ├── MongoDB数据正常
    │   ├── 文件系统数据正常
    │   └── MongoDB和文件系统数据一致
    ↓
验证完成
```

### 5.2 功能验证清单

| 功能 | 验证项 | 状态 |
|------|--------|------|
| 角色卡生成 | 可以成功生成角色卡 | |
| 角色卡获取 | 可以成功获取角色卡 | |
| 进度检查 | 可以成功检查A套题进度 | |
| 角色卡重新生成 | 可以成功重新生成角色卡 | |
| 批量预处理 | 可以成功预处理所有协助者 | |
| 单个预处理 | 可以成功预处理单个协助者 | |
| 单个更新 | 可以成功更新单个协助者 | |
| 获取单个准则 | 可以成功获取单个协助者准则 | |
| 获取所有准则 | 可以成功获取所有协助者准则 | |
| 数据一致性 | MongoDB和文件系统数据一致 | |

### 5.3 性能验证清单

| 性能指标 | 目标 | 实际 | 状态 |
|---------|------|------|------|
| 角色卡生成时间 | < 5s | | |
| 对话准则预处理时间 | < 10s | | |
| 并发处理能力 | 10并发无失败 | | |
| 内存使用 | < 2GB | | |
| CPU使用 | < 80% | | |

---

## 6. 回滚流程

### 6.1 回滚触发条件

| 触发条件 | 说明 |
|---------|------|
| 部署后测试失败 | 核心功能无法正常使用 |
| 性能严重下降 | 响应时间超过预期2倍以上 |
| 数据损坏 | MongoDB或文件系统数据损坏 |
| 严重错误 | 频繁出现500错误 |

### 6.2 回滚流程图

```
回滚流程

停止新版本服务
    ↓
恢复旧版本代码
    │   ├── 切换到稳定分支
    │   ├── 拉取稳定版本代码
    │   └── 验证代码完整性
    ↓
恢复旧版本配置
    │   ├── 恢复.env文件
    │   └── 验证配置有效性
    ↓
重启服务
    │   ├── 停止MongoDB (如需要)
    │   ├── 启动MongoDB
    │   ├── 启动Ollama (如需要)
    │   └── 启动应用
    ↓
验证回滚成功
    │   ├── 验证服务状态
    │   ├── 验证API端点
    │   └── 验证数据完整性
    ↓
回滚完成
```

### 6.3 回滚检查清单

| 检查项 | 状态 | 备注 |
|--------|------|------|
| 旧版本代码已恢复 | | 稳定版本 |
| 旧版本配置已恢复 | | 原有配置 |
| 服务已重启 | | 服务运行中 |
| API端点正常 | | 可以正常调用 |
| 数据完整性正常 | | 没有数据丢失 |
| 回滚成功 | | 服务恢复到之前状态 |

---

## 7. 部署监控

### 7.1 监控指标

| 指标类型 | 监控项 | 说明 |
|---------|--------|------|
| 服务状态 | 应用进程状态 | 服务是否运行 |
| 服务状态 | API响应时间 | API响应是否及时 |
| 服务状态 | 错误率 | 500错误率 |
| 资源使用 | CPU使用率 | CPU使用情况 |
| 资源使用 | 内存使用率 | 内存使用情况 |
| 资源使用 | 磁盘使用率 | 磁盘使用情况 |
| 数据库 | MongoDB连接数 | MongoDB连接数 |
| 数据库 | MongoDB查询时间 | MongoDB查询是否及时 |
| 数据库 | MongoDB错误率 | MongoDB错误率 |
| LLM | LLM调用成功率 | LLM调用是否成功 |
| LLM | LLM响应时间 | LLM响应是否及时 |

### 7.2 告警规则

| 告警项 | 阈值 | 级别 | 处理方式 |
|--------|------|------|---------|
| 应用停止 | 服务不可访问 | P0 | 立即通知运维 |
| API错误率高 | 错误率 > 5% | P1 | 立即通知开发 |
| API响应时间慢 | P99 > 5s | P2 | 通知开发 |
| CPU使用率高 | CPU > 80% | P2 | 通知开发 |
| 内存使用率高 | 内存 > 80% | P3 | 通知开发 |
| MongoDB连接失败 | 连接失败 | P1 | 立即通知运维 |
| LLM调用失败 | 成功率 < 90% | P2 | 通知开发 |

---

## 8. 部署最佳实践

### 8.1 部署策略

- **使用蓝绿部署**: 减少部署风险
- **使用滚动更新**: 逐步替换旧版本
- **使用金丝雀发布**: 先在小范围验证
- **保留回滚方案**: 随时可以回滚到稳定版本

### 8.2 安全最佳实践

- **使用HTTPS**: 保护数据传输安全
- **使用强JWT_SECRET**: 防止Token被伪造
- **限制API访问**: 使用IP白名单或VPN
- **定期更新依赖**: 修复已知安全漏洞

### 8.3 监控最佳实践

- **监控所有关键指标**: 确保及时发现异常
- **设置合理的告警阈值**: 避免误报和漏报
- **定期检查监控数据**: 确保监控正常工作
- **定期测试告警**: 确保告警有效

---

## 9. 故障排查

### 9.1 服务无法启动

**症状**: 应用启动失败

**原因**: 环境变量配置错误或依赖缺失

**解决方案**:
1. 检查环境变量配置
2. 检查依赖是否安装
3. 查看启动日志

### 9.2 API调用失败

**症状**: API调用返回错误

**原因**: 服务配置错误或服务依赖不可用

**解决方案**:
1. 检查服务日志
2. 检查MongoDB连接
3. 检查LLM连接
4. 检查网络连接

### 9.3 数据不一致

**症状**: MongoDB和文件系统数据不一致

**原因**: 双重保存失败或并发问题

**解决方案**:
1. 检查服务日志
2. 验证数据完整性
3. 运行数据修复脚本

---

**文档版本**: v1.0  
**创建日期**: 2026-02-06  
**作者**: AFS Team  
**最后更新**: 2026-02-06
