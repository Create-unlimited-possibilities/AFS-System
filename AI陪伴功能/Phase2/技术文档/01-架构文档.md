# Phase 2 架构文档

## 1. 概述

Phase 2实现了角色卡生成和对话准则预处理功能，建立了完整的LLM调用基础设施和统一的API接口。

---

## 2. 系统架构

### 2.1 整体架构

```
Phase 2 架构层次

┌─────────────────────────────────────────────┐
│         Companionship API Routes         │
│         (9个API端点)                       │
│  - 角色卡生成API (4个)                      │
│  - 对话准则预处理API (5个)                 │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────────┐
│       Controllers Layer                     │
│  - companionship.js (359行)                  │
│  - 请求处理                                 │
│  - 业务逻辑协调                              │
│  - 错误处理                                   │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────────┐
│       Services Layer                         │
│  ┌──────────────────────────────────────┐  │
│  │  AssistantsGuidelinesPreprocessor   │  │
│  │  (对话准则预处理)                     │  │
│  │  - 协助者关系获取                     │  │
│  │  - B/C套题答案收集                    │  │
│  │  - 答案压缩                           │  │
│  │  - 对话准则生成                       │  │
│  │  - 双重存储保存                       │  │
│  │  - 增量更新机制                       │  │
│  └──────────────────────────────────────┘  │
│                    ↑ 依赖                   │
│  ┌──────────────────────────────────────┐  │
│  │     RoleCardGenerator Service        │  │
│  │     (角色卡生成)                       │  │
│  │  - A套题进度检查                      │  │
│  │  - A套题答案收集                       │  │
│  │  - 令牌计数                            │  │
│  │  - 个人画像生成                       │  │
│  │  - 双重存储保存                       │  │
│  └──────────────────────────────────────┘  │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────────┐
│         MultiLLMClient                     │
│       (统一LLM调用接口)                     │
│  ↓                                          │
│  ┌──────────┴─────────────┐              │
│  │    llmConfig           │              │
│  │  (LLM配置管理)        │              │
│  │  - 环境变量检测       │              │
│  │  - 配置验证           │              │
│  │  - 降级策略配置       │              │
│  └─────────────────────────┘              │
└──────────────┬──────────────────────────┘
               │
               ↓
┌─────────────────────────────────────────────┐
│          Dual Storage                       │
│     (MongoDB + 文件系统)                    │
│  ┌─────────────────────────────────────┐    │
│  │  MongoDB                             │    │
│  │  - 角色卡存储                        │    │
│  │  - 对话准则存储                      │    │
│  │  - 用户数据存储                        │    │
│  └─────────────────────────────────────┘    │
│  ┌─────────────────────────────────────┐    │
│  │  File System                         │    │
│  │  - 角色卡文件                        │    │
│  │  - 对话准则文件                      │    │
│  │  - 用户数据文件                        │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
```

---

## 3. 服务层架构

### 3.1 核心服务依赖关系

```
服务依赖关系

MultiLLMClient
    ↓
    ├─→ RoleCardGenerator
    │       ↓
    │       └─→ DualStorage
    │
    └─→ AssistantsGuidelinesPreprocessor
            ↓
            └─→ DualStorage
```

### 3.2 服务通信流程

```
服务通信流程

API Routes
    ↓
Controllers
    ↓
    ├─→ AssistantsGuidelinesPreprocessor
    │       ↓ (调用)
    │       └─→ RoleCardGenerator
    │               ↓ (调用)
    │               └─→ MultiLLMClient
    │
    └─→ RoleCardGenerator
            ↓ (调用)
            └─→ MultiLLMClient
```

---

## 4. 数据流程

### 4.1 角色卡生成数据流程

```
角色卡生成数据流程

用户A套题答案 (Answer Collection)
    ↓
进度检查 (Progress Check)
    ↓ (通过)
答案收集 (Answer Collection)
    ↓
令牌计数 (Token Counting)
    ↓
LLM调用 (LLM Call)
    ↓
个人画像生成 (Profile Generation)
    ↓
双重存储保存 (Dual Storage Save)
    ├─→ MongoDB Update
    └─→ File System Write
    ↓
数据一致性验证 (Data Consistency Verification)
    ↓
完成
```

### 4.2 对话准则预处理数据流程

```
对话准则预处理数据流程

协助者关系查询 (Assistant Relations Query)
    ↓
B/C套题答案收集 (B/C Set Answers Collection)
    ↓
答案分组 (Answers Grouping)
    ↓ (按questionId)
LLM答案压缩 (LLM Answer Compression)
    ↓ (串行处理)
压缩结果保存 (Compressed Results Save)
    ↓
LLM对话准则生成 (LLM Guidelines Generation)
    ↓
双重存储保存 (Dual Storage Save)
    ├─→ MongoDB Update
    └─→ File System Write
    ↓
状态标记更新 (Status Update)
    ↓
完成
```

---

## 5. LLM调用架构

### 5.1 LLM调用流程

```
LLM调用流程

LLM调用请求
    ↓
检查配置: USE_API_LLM
    ↓
USE_API_LLM = true?
├─ Yes → 尝试API LLM
│   ↓
│   API LLM可用?
│   ├─ Yes → 使用API LLM
│   │         ↓
│   │     调用成功?
│   │     ├─ Yes → 返回结果
│   │     └─ No → 降级到本地Ollama
│   └─ No → 降级到本地Ollama
└─ No → 直接使用本地Ollama
    ↓
使用本地Ollama
    ↓
调用成功?
├─ Yes → 返回结果
└─ No → 抛出错误
```

### 5.2 降级策略

```
降级策略流程

配置检查
    ↓
降级策略选择
├─ api-local
│   ├─ 第1步: 尝试API LLM
│   │   ├─ 成功 → 返回结果
│   │   └─ 失败 → 第2步
│   └─ 第2步: 使用本地Ollama
│       ├─ 成功 → 返回结果
│       └─ 失败 → 抛出错误
│
├─ local-api
│   ├─ 第1步: 使用本地Ollama
│   │   ├─ 成功 → 返回结果
│   │   └─ 失败 → 第2步
│   └─ 第2步: 尝试API LLM
│       ├─ 成功 → 返回结果
│       └─ 失败 → 抛出错误
│
└─ none
    └─ 不使用降级
        └─ 任何LLM失败都直接返回错误
```

---

## 6. 双重存储架构

### 6.1 存储架构

```
双重存储架构

数据写入流程
    ↓
同时写入两个存储
    ├─→ MongoDB
    │   └─ 数据持久化
    │
    └─→ File System
        └─ 文件持久化
            ↓
数据一致性验证
            ↓
写入完成
```

### 6.2 数据一致性机制

```
数据一致性验证机制

写入操作
    ↓
步骤1: 写入MongoDB
    ↓
步骤2: 写入File System
    ↓
步骤3: 验证数据一致性
    │
    ├─ MongoDB数据 == File System数据?
    │   ├─ Yes → 写入成功
    │   └─ No → 步骤4
    │
    └─ 步骤4: 回滚MongoDB
        ↓
        修复数据不一致
```

---

## 7. API架构

### 7.1 API分层架构

```
API分层架构

客户端请求
    ↓
┌───────────────────────────────────────┐
│         Middleware Layer             │
│  - 认证中间件 (protect)              │
│  - 权限中间件 (requirePermission)      │
└────────────────┬──────────────────┘
                 │
                 ↓
┌───────────────────────────────────────┐
│         Controller Layer             │
│  - 参数验证                            │
│  - 业务逻辑协调                         │
│  - 统一响应格式                         │
│  - 错误处理                             │
└────────────────┬──────────────────┘
                 │
                 ↓
┌───────────────────────────────────────┐
│         Service Layer                 │
│  - 核心业务逻辑                         │
│  - 数据处理                             │
│  - LLM调用                              │
└────────────────┬──────────────────┘
                 │
                 ↓
┌───────────────────────────────────────┐
│         Data Layer                    │
│  - MongoDB访问                          │
│  - File System访问                      │
└───────────────────────────────────────┘
```

### 7.2 认证与授权流程

```
认证与授权流程

API请求
    ↓
步骤1: 身份认证
    │   ├─ 检查Token是否存在
    │   ├─ 验证Token有效性
    │   └─ 提取用户信息到req.user
    │   ├─ 失败 → 返回401
    │   └─ 成功 → 继续
    ↓
步骤2: 权限验证
    │   ├─ 查询用户角色
    │   ├─ 查询角色权限
    │   └─ 验证是否有所需权限
    │   ├─ 失败 → 返回403
    │   └─ 成功 → 继续
    ↓
步骤3: 业务处理
    └─ 返回200
```

---

## 8. 错误处理架构

### 8.1 错误处理流程

```
错误处理流程

请求处理
    ↓
参数验证
    ├─ 失败 → 返回400
    └─ 成功 → 继续
    ↓
业务逻辑处理
    ├─ 业务错误 → 返回业务错误代码
    └─ 成功 → 继续
    ↓
LLM调用
    ├─ 失败 → 降级或返回500
    └─ 成功 → 继续
    ↓
数据持久化
    ├─ 失败 → 回滚或返回500
    └─ 成功 → 继续
    ↓
返回响应
```

### 8.2 错误响应格式

```
错误响应格式

{
  "success": false,
  "message": "错误描述",
  "errors": null
}
```

---

## 9. 性能优化策略

### 9.1 LLM调用优化

```
LLM调用优化

策略1: 串行处理
    └─ 避免并发压力

策略2: 降级机制
    └─ 确保服务可用性

策略3: 超时控制
    └─ 避免长时间等待

策略4: 重试机制
    └─ 提高成功率
```

### 9.2 数据库优化

```
数据库优化

策略1: 索引优化
    └─ 为常用查询添加索引

策略2: 批量操作
    └─ 使用批量更新提高性能

策略3: 查询优化
    └─ 优化查询条件，减少数据量
```

### 9.3 文件系统优化

```
文件系统优化

策略1: 路径优化
    └─ 使用合理的文件路径结构

策略2: 并发控制
    └─ 避免文件并发冲突

策略3: 缓存策略
    └─ 缓存热点数据
```

---

**文档版本**: v1.0  
**创建日期**: 2026-02-06  
**作者**: AFS Team  
**最后更新**: 2026-02-06
