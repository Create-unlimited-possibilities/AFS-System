# 实施计划

## Phase 1: 数据模型和基础服务（Week 1）

### 目标
- 完成数据模型设计
- 实现基础服务类
- 搭建LangChain环境

### 任务清单

- [ ] **数据模型**
  - [ ] 扩展User模型（companionChat字段完整定义）
  - [ ] 创建ChatSession模型
  - [ ] 扩展AssistRelation模型（可选）
  - [ ] 创建数据库索引
  - [ ] 更新MongoDB连接配置

- [ ] **基础服务**
  - [ ] 安装LangChain相关依赖
  - [ ] 创建DualStorage扩展（支持assistants-guidelines.json）
  - [ ] 创建SentimentManager服务
  - [ ] 编写单元测试
  - [ ] 文档编写

### 验收标准
- 数据模型通过MongoDB验证
- SentimentManager能够正确计算好感度
- 所有单元测试通过

### 预计工作量
- 后端开发: 40小时
- 测试: 10小时
- 文档: 5小时
- **总计: 55小时**

---

## Phase 2: 角色卡生成和预处理（Week 2）

### 目标
- 实现角色卡生成功能
- 实现协助者对话准则预处理
- 实现增量更新机制

### 任务清单

- [ ] **角色卡生成器**
  - [ ] 创建RoleCardGenerator服务
  - [ ] 实现A套问题进度检查
  - [ ] 实现答案收集和token计算
  - [ ] 实现个人画像生成（包含陌生人初始好感度）
  - [ ] 实现模式确定逻辑
  - [ ] 实现双重存储保存

- [ ] **协助者对话准则预处理器**
  - [ ] 创建AssistantsGuidelinesPreprocessor服务
  - [ ] 实现所有协助者预处理
  - [ ] 实现单个协助者处理
  - [ ] 实现逐题压缩（LLM）
  - [ ] 实现对话准则生成
  - [ ] 实现默认准则创建
  - [ ] 实现MongoDB保存
  - [ ] 实现文件系统保存（双重存储）

- [ ] **增量更新机制**
  - [ ] 实现单个协助者更新
  - [ ] 实现文件系统加载
  - [ ] 编写单元测试
  - [ ] 性能测试

### 验收标准
- 能够成功生成角色卡
- 能够预处理所有协助者对话准则
- 增量更新功能正常
- 双重存储正确同步

### 预计工作量
- 后端开发: 50小时
- 测试: 15小时
- 文档: 5小时
- **总计: 70小时**

---

## Phase 3: 对话功能（Week 3-4）

### 目标
- 实现动态角色卡组装
- 实现好感度系统
- 实现LangGraph对话流程
- 实现API接口

### 任务清单

- [ ] **动态角色卡组装器**
  - [ ] 创建DynamicRoleCardAssembler服务
  - [ ] 实现个人画像加载
  - [ ] 实现对话者信息加载
  - [ ] 实现协助者对话准则加载（预处理结果）
  - [ ] 实现陌生人对话准则生成（含好感度）
  - [ ] 实现System Prompt构建

- [ ] **好感度系统**
  - [ ] 实现陌生人好感度获取/创建
  - [ ] 实现好感度更新（多因素综合）
  - [ ] 实现情感分析
  - [ ] 实现对话质量计算
  - [ ] 实现时间衰减计算
  - [ ] 实现原因生成

- [ ] **LangGraph编排器**
  - [ ] 创建ChatGraphOrchestrator服务
  - [ ] 实现所有节点
  - [ ] 实现边和条件边
  - [ ] 实现会话创建
  - [ ] 实现消息发送
  - [ ] 实现状态管理

- [ ] **API接口**
  - [ ] 创建rolecard路由
  - [ ] 创建chat路由
  - [ ] 创建RoleCardController
  - [ ] 创建ChatController
  - [ ] 实现所有API端点
  - [ ] 实现错误处理
  - [ ] 实现日志记录

### 验收标准
- 能够成功创建对话会话
- 能够正常发送和接收消息
- 好感度系统正常工作
- LangGraph流程正确执行

### 预计工作量
- 后端开发: 60小时
- 测试: 20小时
- 文档: 5小时
- **总计: 85小时**

---

## Phase 4: 前端开发（Week 5-6）

### 目标
- 实现角色卡管理界面
- 实现对话界面
- 实现关系管理界面

### 任务清单

- [ ] **角色卡管理页面**
  - [ ] 创建rolecard/page.tsx
  - [ ] 实现RoleCardViewer组件
  - [ ] 实现MemoryPreview组件
  - [ ] 实现GenerateButton组件
  - [ ] 实现GuidelinesViewer组件
  - [ ] 实现API集成
  - [ ] 实现状态管理

- [ ] **对话界面**
  - [ ] 创建chat/page.tsx
  - [ ] 实现ChatInterface组件
  - [ ] 实现MessageList组件
  - [ ] 实现MessageInput组件
  - [ ] 实现RoleCardEntry组件
  - [ ] 实现API集成
  - [ ] 实现WebSocket实时通信（可选）

- [ ] **关系管理页面**
  - [ ] 创建relationships/page.tsx
  - [ ] 实现RelationshipList组件
  - [ ] 实现RelationshipEditor组件
  - [ ] 实现SentimentChart组件
  - [ ] 实现API集成

### 验收标准
- 所有页面功能正常
- UI/UX符合设计要求
- 响应式设计良好
- 所有API调用正常

### 预计工作量
- 前端开发: 60小时
- 测试: 15小时
- 文档: 5小时
- **总计: 80小时**

---

## Phase 5: 监听和触发机制（Week 7）

### 目标
- 实现协助关系变更监听
- 实现答案变更监听
- 实现增量更新触发
- 完善错误处理

### 任务清单

- [ ] **监听机制**
  - [ ] 监听AssistRelation创建（新协助者加入）
  - [ ] 监听AssistRelation删除（协助关系解除）
  - [ ] 监听Answer创建/更新（协助者修改答案）
  - [ ] 实现监听器注册和注销

- [ ] **触发机制**
  - [ ] 实现增量更新触发
  - [ ] 实现任务队列（可选）
  - [ ] 实现重试机制
  - [ ] 实现失败通知

- [ ] **错误处理**
  - [ ] 实现全局错误捕获
  - [ ] 实现错误日志记录
  - [ ] 实现用户友好的错误提示
  - [ ] 实现错误恢复机制

### 验收标准
- 监听机制正常工作
- 增量更新自动触发
- 错误处理完善
- 日志记录完整

### 预计工作量
- 后端开发: 30小时
- 测试: 10小时
- 文档: 5小时
- **总计: 45小时**

---

## Phase 6: 测试和优化（Week 8）

### 目标
- 完成端到端测试
- 性能优化
- 代码优化
- 文档完善

### 任务清单

- [ ] **测试**
  - [ ] 单元测试覆盖率 > 80%
  - [ ] 集成测试
  - [ ] 端到端测试
  - [ ] 性能测试
  - [ ] 压力测试

- [ ] **优化**
  - [ ] 数据库查询优化
  - [ ] LLM调用优化（批处理、缓存）
  - [ ] 前端性能优化
  - [ ] 内存优化
  - [ ] 网络请求优化

- [ ] **文档**
  - [ ] API文档完善
  - [ ] 用户文档完善
  - [ ] 开发者文档完善
  - [ ] 部署文档完善

### 验收标准
- 所有测试通过
- 性能指标达标
- 文档完整准确

### 预计工作量
- 测试: 30小时
- 优化: 20小时
- 文档: 15小时
- **总计: 65小时**
