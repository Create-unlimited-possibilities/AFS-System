# 核心概念

## 1. 角色定义

### 用户A（被对话者 / 角色卡主人）
- 填写A套问题（基础层+情感层）
- 生成角色卡A（个人画像）
- **不参与对话**（被动角色）

### 用户B（对话发起者）
- 可以是协助者（家人/朋友）
- 可以是陌生人
- **与角色卡A对话**（主动角色）

### 角色卡A（数字化的用户A）
- 动态拼接的System Prompt
- 包含：个人画像 + 当前对话者信息 + 对话准则
- 基于LangGraph进行对话

---

## 2. 对话流程

```
用户B输入用户A的uniqueCode
    ↓
识别用户B与用户A的关系
    ├─ 查询AssistRelation → 家人/朋友
    └─ 未找到 → 陌生人
    ↓
动态组装角色卡A
    ├─ 加载个人画像（User.companionChat.roleCard）
    ├─ 加载用户B信息
    ├─ 加载关系信息
    ├─ 如果是协助者：加载预处理的对话准则
    └─ 如果是陌生人：动态生成对话准则（含好感度）
    ↓
创建ChatSession
    ↓
基于LangGraph进行对话
```

---

## 3. 预处理机制

```
角色卡生成完成
    ↓
检索所有协助者
    ↓
对每个协助者：
  ├─ 获取B套/C套答案
  ├─ 逐题压缩（LLM）
  ├─ 汇总压缩结果
  └─ 生成对话准则
    ↓
保存到MongoDB + 文件系统（双重存储）
    ↓
✅ 预处理完成，后续直接加载
```

---

## 4. 增量更新机制

触发条件：
- 新协助者加入 → 只生成新协助者的准则
- 协助者修改答案 → 只更新该协助者的准则

处理方式：
- 只重新处理受影响的协助者
- 无需重新生成所有协助者的准则

---

## 5. 独立好感度系统

```
角色卡A对用户B的好感度：50
角色卡A对用户C的好感度：30

每个用户（每个协助者/陌生人）都有独立的：
  ├─ 初始好感度（陌生人：基于角色卡个人画像生成）
  ├─ 当前好感度
  └─ 好感度历史记录

好感度影响因素：
  ├─ 对话情感分析
  ├─ 对话频次
  ├─ 对话质量
  └─ 时间衰减
```
