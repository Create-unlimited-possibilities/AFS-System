# 技术架构

## 系统架构图

```
┌─────────────────────────────────────────────────┐
│         Next.js 15 前端 (端口 3000)              │
│  - 对话界面                                      │
│  - 角色卡管理                                    │
│  - 记忆查看                                      │
└────────────────┬────────────────────────────────┘
                 │ REST API / WebSocket
┌────────────────▼────────────────────────────────┐
│       Express.js 后端 (端口 3001)                │
│  ┌──────────────────────────────────────────┐  │
│  │   LangGraph Agent Orchestrator          │  │
│  │   - 对话状态管理                          │  │
│  │   - 多节点协调                            │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │   LangChain Service Layer                │  │
│  │   - RAG检索链                             │  │
│  │   - 角色卡生成链                          │  │
│  │   - 对话生成链                            │  │
│  │   - 动态角色卡组装器                       │  │
│  │   - 好感度管理器                           │  │
│  │   - 协助者对话准则预处理器                  │  │
│  └──────────────────────────────────────────┘  │
└────────────────┬────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────┐
│     ModelServer (Python, 端口 8000)             │
│  - Ollama 模型推理                               │
│  - LoRA 微调                                    │
│  - Embedding 服务                               │
└────────────────┬────────────────────────────────┘
                 │
    ┌────────────┴────────────┐
    ▼                         ▼
┌──────────────┐      ┌──────────────┐
│   MongoDB    │      │  ChromaDB    │
│  (结构化数据) │      │  (向量索引)  │
└──────────────┘      └──────────────┘
```

---

## LangGraph节点设计

```javascript
const chatGraph = {
  nodes: {
    // 输入处理节点
    'input_processor': 处理用户输入，提取关键信息,

    // 关系确认节点
    'relation_confirm': 确认对话者关系（家人/朋友/陌生人）,

    // 角色卡组装节点
    'rolecard_assemble': 动态组装角色卡（使用预处理结果）,

    // RAG检索节点
    'rag_retriever': 根据关系和上下文检索相关记忆,

    // 好感度分析节点
    'sentiment_analyzer': 分析情感和好感度（陌生人）,

    // 上下文整合节点
    'context_builder': 整合角色卡+记忆+对话历史,

    // 回复生成节点
    'response_generator': 调用LLM生成回复,

    // 记忆更新节点
    'memory_updater': 将对话加入记忆历史,

    // 输出格式化节点
    'output_formatter': 格式化输出给前端
  },

  edges: {
    'input_processor' -> 'relation_confirm',
    'relation_confirm' -> 'rolecard_assemble',
    'rolecard_assemble' -> (条件边) -> {
      'family' -> 'rag_retriever',
      'friend' -> 'rag_retriever',
      'stranger' -> 'sentiment_analyzer'
    },
    'rag_retriever' -> 'context_builder',
    'sentiment_analyzer' -> 'context_builder',
    'context_builder' -> 'response_generator',
    'response_generator' -> 'memory_updater',
    'memory_updater' -> 'output_formatter',
    'output_formatter' -> END
  }
};
```
