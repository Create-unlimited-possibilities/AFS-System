# 技术要点

## 1. 预处理机制的优势

| 优势 | 说明 |
|------|------|
| **性能优化** | 对话时直接加载，无需实时生成 |
| **一致性** | 所有协助者的准则统一处理 |
| **可追溯** | 保存压缩后的答案，便于调试 |
| **可复用** | 预处理结果可多次使用 |

---

## 2. 增量更新机制

| 特性 | 说明 |
|------|------|
| **高效** | 只更新受影响的协助者 |
| **实时性** | 协助者修改答案后立即触发 |
| **灵活性** | 支持手动触发 |
| **可靠性** | 支持重试和失败通知 |

---

## 3. 独立好感度系统

| 特性 | 说明 |
|------|------|
| **个性化** | 每个用户有独立的好感度 |
| **多因素** | 情感、频次、质量、时间衰减 |
| **可追溯** | 保存完整的好感度历史 |
| **动态性** | 实时更新，实时反映 |

---

## 4. 动态角色卡组装

| 特性 | 说明 |
|------|------|
| **实时性** | 每次对话都重新组装 |
| **个性化** | 根据对话者不同，准则也不同 |
| **可扩展** | 易于添加新的组装部分 |
| **性能** | 使用预处理结果，快速组装 |

---

## 5. LangGraph编排

| 特性 | 说明 |
|------|------|
| **有状态** | 自动管理对话状态 |
| **可视化** | 支持LangSmith可视化调试 |
| **灵活性** | 图状结构比线性流程更灵活 |
| **可扩展** | 易于添加新节点和边 |

---

## 6. LangGraph节点设计 (Phase 3)

| 节点 | 功能 | 关键特性 |
|------|------|---------|
| input_processor | 处理用户输入 | 输入验证、长度计算 |
| relation_confirm | 确认对话者关系 | 协助关系查询、关系类型判定 |
| rolecard_assemble | 组装动态角色卡 | 预处理结果加载、System Prompt构建 |
| rag_retriever | 检索相关记忆 | ChromaDB检索、相关性评分 |
| sentiment_analyzer | 分析情感和好感度 | LLM情感分析、多因素好感度计算 |
| context_builder | 整合上下文 | 历史、角色卡、记忆整合 |
| response_generator | 生成回复 | LLM调用、参数配置 |
| memory_updater | 更新记忆历史 | 持久化、时间戳记录 |
| output_formatter | 格式化输出 | 统一响应格式、错误处理 |

---

## 7. 会话状态管理 (Phase 3)

| 状态字段 | 类型 | 用途 |
|----------|------|------|
| userId | string | 目标用户ID |
| userName | string | 目标用户名称 |
| interlocutor | object | 对话者信息（ID、关系类型、好感度） |
| messages | array | 对话历史消息 |
| retrievedMemories | array | 检索到的相关记忆 |
| roleCard | object | 当前使用的角色卡 |
| currentInput | string | 当前轮次的用户输入 |
| generatedResponse | string | 当前轮次的AI回复 |
| metadata | object | 元数据（时间戳、模型信息等） |
| errors | array | 错误列表 |

---

## 8. 条件路由机制 (Phase 3)

| 关系类型 | 下一节点 | 触发条件 |
|----------|---------|---------|
| family | rag_retriever | 是家人，需要检索家人记忆 |
| friend | rag_retriever | 是朋友，需要检索朋友记忆 |
| stranger | sentiment_analyzer | 是陌生人，需要分析情感 |

**优势**:
- 根据关系类型智能选择处理路径
- 避免不必要的计算（如陌生人不检索记忆）
- 易于扩展新关系类型

---

## 9. 错误恢复机制 (Phase 3)

| 层级 | 处理方式 | 特点 |
|------|---------|------|
| 节点级 | try-catch + state.addError() | 单个节点失败不影响流程 |
| 编排器级 | try-catch + 统一错误响应 | 整个流程失败时返回友好错误 |
| 控制器级 | try-catch + HTTP状态码 | API层错误处理 |

**特点**:
- 错误不会中断整个流程
- 错误信息完整记录到日志
- 返回给前端的错误信息友好

---

## 10. 双重存储应用 (Phase 3)

| 数据类型 | MongoDB | 文件系统 | 同步策略 |
|----------|---------|-----------|---------|
| 角色卡 | ✅ 主存储 | ✅ 备份 | 写入时同步 |
| 对话准则 | ✅ 主存储 | ✅ 备份 | 写入时同步 |
| 用户资料 | ✅ 主存储 | ✅ 备份 | 写入时同步 |
| 对话历史 | ✅ 主存储 | ❌ - | 仅MongoDB |
| 会话状态 | ❌ - | ✅ 内存 | 仅内存 |

**优势**:
- 文件系统读取速度快
- MongoDB提供查询和持久化
- 内存存储活跃会话，快速访问
