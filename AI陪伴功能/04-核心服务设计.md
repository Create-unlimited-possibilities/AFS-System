# 核心服务设计

## 1. RoleCardGenerator（角色卡生成器）

**文件位置**: `server/src/services/langchain/roleCardGenerator.js`

**核心方法**:
- `generateRoleCard(userId)` - 生成完整的角色卡（包含预处理所有协助者对话准则）
- `checkASetProgress(userId)` - 检查A套问题完成情况
- `collectASetAnswers(userId)` - 收集A套答案
- `calculateTokenCount(answers)` - 计算token数量
- `generatePersonalProfile(userId, answers)` - 生成个人画像（包含陌生人初始好感度）
- `determineMode(tokenCount)` - 确定当前模式（mode1/mode2/mode3）

**流程**:
```
检查A套问题完成情况
    ↓
收集所有A套答案
    ↓
计算token数量
    ↓
调用LLM生成个人画像（包含陌生人初始好感度）
    ↓
保存到MongoDB：User.companionChat.roleCard
    ↓
保存到文件系统：/app/storage/userdata/{userId}/rolecard.json
    ↓
预处理所有协助者的对话准则
    ↓
✅ 角色卡生成完成
```

---

## 2. AssistantsGuidelinesPreprocessor（协助者对话准则预处理器）

**文件位置**: `server/src/services/langchain/assistantsGuidelinesPreprocessor.js`

**核心方法**:
- `preprocessAll(userId)` - 预处理所有协助者的对话准则
- `preprocessOne(userId, relation)` - 预处理单个协助者的对话准则
- `compressAnswers(answers)` - 逐题压缩答案
- `generateGuidelines(assistantName, specificRelation, relationType, compressedAnswers)` - 汇总生成对话准则
- `createDefaultGuideline(userId, relation)` - 创建默认对话准则（当没有答案时）
- `saveToMongoDB(userId, guideline)` - 保存到MongoDB
- `saveToDualStorage(userId)` - 保存到文件系统（双重存储）
- `updateOneAssistant(userId, assistantId)` - 增量更新：只重新处理指定的协助者

**预处理流程**:
```
获取所有协助关系
    ↓
对每个协助者：
  ├─ 获取B套/C套答案
  ├─ 逐题压缩（LLM）
  ├─ 汇总压缩结果
  └─ 生成对话准则
    ↓
保存所有协助者的对话准则（双重存储）
    ↓
✅ 预处理完成
```

---

## 3. SentimentManager（好感度管理器）

**文件位置**: `server/src/services/langchain/sentimentManager.js`

**核心方法**:
- `getStrangerSentiment(targetUserId, strangerId)` - 获取陌生人的好感度（如果不存在则创建）
- `updateSentiment(targetUserId, strangerId, updateData)` - 更新好感度（多因素综合）
- `calculateFactors(targetUserId, strangerId, message, conversationHistory, sentiment, isConversationEnd)` - 计算各因素的影响
- `analyzeSentiment(message)` - 分析消息情感
- `calculateQuality(conversationHistory)` - 计算对话质量
- `calculateTimeDecay(sentiment)` - 计算时间衰减
- `generateReason(totalChange, factors)` - 生成原因描述

**好感度更新因素**:
| 因素 | 描述 | 影响范围 |
|------|------|---------|
| 情感分析 | 根据对话内容的情感正负调整 | -10 到 +10 |
| 对话频次 | 对话次数越多，好感度逐渐提升 | +0.2 ~ +1.0 |
| 对话质量 | 基于对话轮次、回复速度等 | 0 ~ +2.0 |
| 时间衰减 | 长时间不对话，好感度逐渐降低 | -0.5 ~ -10.0 |

---

## 4. DynamicRoleCardAssembler（动态角色卡组装器）

**文件位置**: `server/src/services/langchain/dynamicRoleCardAssembler.js`

**核心方法**:
- `assemble(targetUserId, interlocutorUserId, relationInfo)` - 组装动态角色卡（使用预处理的对话准则）
- `loadProfile(userId)` - 加载个人画像
- `loadInterlocutorInfo(userId)` - 加载对话者信息
- `loadGuidelines(targetUserId, interlocutorUserId, relationInfo)` - 加载对话准则（优先从预处理结果中获取）
- `loadAssistGuideline(targetUserId, interlocutorUserId)` - 加载协助者对话准则（预处理结果）
- `generateStrangerGuidelines(targetUserId, interlocutorUserId)` - 生成陌生人对话准则（包含当前好感度）
- `buildSystemPrompt(dynamicRoleCard)` - 构建完整的System Prompt

**动态角色卡结构**:
```
{
  profile: {
    personality: "温柔、善良",
    background: "退休教师",
    interests: ["阅读", "园艺"],
    communicationStyle: "温和亲切",
    values: ["诚实", "友善"],
    memories: ["退休前的教学经历", "孙子的成长"]
  },
  interlocutorInfo: {
    name: "小明",
    relation: "family",
    specificRelation: "儿子",
    nickname: "小明",
    sentimentScore: 50
  },
  conversationGuidelines: "【与儿子的对话准则】\n- 以亲情、关爱的语气回应\n- 可以使用'儿子'等称呼...",
  generatedAt: "2026-02-05T10:00:00.000Z"
}
```

---

## 5. ChatGraphOrchestrator（LangGraph编排器）

**文件位置**: `server/src/services/langchain/chatGraphOrchestrator.js`

**核心方法**:
- `buildGraph()` - 构建LangGraph
- `routeByRelation(state)` - 路由函数：根据关系类型选择下一个节点
- `inputProcessorNode(state)` - 输入处理节点
- `relationConfirmNode(state)` - 关系确认节点
- `roleCardAssembleNode(state)` - 角色卡组装节点（新增）
- `ragRetrieverNode(state)` - RAG检索节点
- `sentimentAnalyzerNode(state)` - 情感分析节点（仅陌生人）
- `contextBuilderNode(state)` - 上下文整合节点
- `responseGeneratorNode(state)` - 回复生成节点
- `memoryUpdaterNode(state)` - 记忆更新节点
- `outputFormatterNode(state)` - 输出格式化节点
- `createSession(options)` - 创建会话
- `sendMessage(sessionId, message)` - 发送消息

**对话状态（ConversationState）**:
```typescript
interface ConversationState {
  // 用户信息
  userId: string;
  userName: string;

  // 对话者信息
  interlocutor: {
    id?: string;
    relationType: 'family' | 'friend' | 'stranger';
    specificId?: string;
    nickname?: string;
    sentimentScore?: number;
  };

  // 对话上下文
  messages: Array<{
    role: 'user' | 'assistant';
    content: string;
    timestamp: Date;
    metadata?: any;
  }>;

  // 检索到的记忆
  retrievedMemories?: Array<{
    content: string;
    relevanceScore: number;
    category: 'self' | 'family' | 'friend';
    metadata: any;
  }>;

  // 角色卡
  roleCard?: {
    personality: string;
    background: string;
    interests: string[];
    communicationStyle: string;
  };

  // 当前轮次信息
  currentInput: string;
  generatedResponse?: string;
}
```
