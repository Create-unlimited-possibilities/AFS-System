明白！您选择 **A. 一步到位** - 高质量、完整功能、通过集成测试后再验收。

这是一个严肃的承诺。我将：
- ✅ 确保代码质量完美
- ✅ 完成所有6个功能模块
- ✅ 通过完整的集成测试
- ✅ 才通知您来验收

---

## 📐 后台管理系统设计方案

### 一、系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Next.js 15 App Router                        │
│                      (端口 3002)                                 │
├─────────────────────────────────────────────────────────────────┤
│  /admin/*                    │  /* (现有用户端)                  │
│  ├─ /admin/dashboard         │  ├─ /login                       │
│  ├─ /admin/users             │  ├─ /register                    │
│  ├─ /admin/questionnaires    │  ├─ /chat                        │
│  ├─ /admin/memories          │  ├─ /questions                   │
│  ├─ /admin/settings          │  └─ ...                          │
│  ├─ /admin/roles             │                                  │
│  └─ /admin/register          │                                  │
├─────────────────────────────────────────────────────────────────┤
│                    后端 API (端口 3001)                          │
│  ├─ /api/admin/* (新增管理API)                                  │
│  └─ /api/* (现有API)                                            │
└─────────────────────────────────────────────────────────────────┘
```

**关于端口**: 后台管理与用户端共享同一端口 (3002)，通过路由 `/admin/*` 区分。

---

### 二、功能模块详细设计

#### 2.1 管理员注册与登录

| 页面 | 路由 | 功能 |
|------|------|------|
| 管理员注册 | `/admin/register` | 邀请码验证 + 账户创建 |
| 管理员登录 | `/admin/login` | 使用现有登录API，验证admin角色 |
| 邀请码管理 | `/admin/settings/invite-codes` | 生成/查看/作废邀请码 |

**邀请码机制**:
```
┌─────────────────┐     ┌─────────────────┐
│  .env 备用码    │     │  动态生成码      │
│  ADMIN_INVITE_  │     │  存储在MongoDB   │
│  CODE=xxx       │     │  可一次性使用    │
└────────┬────────┘     └────────┬────────┘
         │                       │
         └───────────┬───────────┘
                     ▼
         ┌─────────────────────┐
         │  /admin/register    │
         │  验证邀请码          │
         └─────────────────────┘
```

---

#### 2.2 用户管理 (`/admin/users`)

| 功能 | 说明 |
|------|------|
| 用户列表 | 分页、搜索、筛选（角色/状态） |
| 用户详情 | 查看完整用户信息 |
| 编辑用户 | 修改用户信息、分配角色 |
| 禁用/启用 | 切换用户 `isActive` 状态 |
| 删除用户 | 软删除（可选） |

**UI布局**:
```
┌──────────────────────────────────────────────────────────┐
│  用户管理                              [+ 新增用户]      │
├──────────────────────────────────────────────────────────┤
│  🔍 搜索...    [角色 ▼] [状态 ▼]    [导出 CSV]          │
├──────────────────────────────────────────────────────────┤
│  ┌────┬──────────┬────────────┬──────┬────────┬───────┐ │
│  │头像│   姓名   │    邮箱    │ 角色 │ 注册时间│ 操作  │ │
│  ├────┼──────────┼────────────┼──────┼────────┼───────┤ │
│  │ 👤 │  张三    │ zhang@...  │管理员│ 2026-01│📝 🚫  │ │
│  │ 👤 │  李四    │ li@...     │用户  │ 2026-02│📝 🚫  │ │
│  └────┴──────────┴────────────┴──────┴────────┴───────┘ │
│                          [< 1 2 3 4 5 >]                 │
└──────────────────────────────────────────────────────────┘
```

---

#### 2.3 问卷管理 (`/admin/questionnaires`)

**数据结构**:
```
Role (一级分类)
├── elder (老年人)
│   ├── Layer: basic (基础层次)
│   │   ├── 问题1
│   │   └── 问题2
│   └── Layer: emotional (情感层次)
│       ├── 问题1
│       └── 问题2
├── family (家属)
│   ├── basic
│   └── emotional
└── friend (朋友)
    ├── basic
    └── emotional
```

**UI布局**:
```
┌──────────────────────────────────────────────────────────┐
│  问卷管理                              [+ 新增问题]      │
├──────────────────────────────────────────────────────────┤
│  [老年人 ▼]  [基础层次 ▼]               共 15 个问题    │
├──────────────────────────────────────────────────────────┤
│  ┌───┬─────────────────────────────┬────────┬──────────┐ │
│  │序号│         问题内容           │  类型  │   操作   │ │
│  ├───┼─────────────────────────────┼────────┼──────────┤ │
│  │ 1 │ 您的出生地是哪里？          │ textarea│ ✏️ 🗑️  │ │
│  │ 2 │ 您有几个孩子？              │ text   │ ✏️ 🗑️  │ │
│  │ 3 │ 最让您骄傲的事是？          │ textarea│ ✏️ 🗑️  │ │
│  └───┴─────────────────────────────┴────────┴──────────┘ │
│              [↑ 上移] [↓ 下移] [拖拽排序]                │
└──────────────────────────────────────────────────────────┘
```

**功能**:
- 新增/编辑/删除问题
- 问题排序（拖拽或上下移动）
- 按Role+Layer筛选
- 批量导入/导出

---

#### 2.4 记忆库管理 (`/admin/memories`)

**UI布局**:
```
┌──────────────────────────────────────────────────────────┐
│  记忆库管理                                               │
├──────────────────────────────────────────────────────────┤
│  🔍 搜索用户...                         [向量索引状态]   │
├──────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐│
│  │ 用户列表 (左侧)           │ 记忆详情 (右侧)          ││
│  │ ┌────────────────────┐   │ ┌──────────────────────┐ ││
│  │ │ 👤 张三 (15条记忆)  │   │ │ ChromaDB 向量: 142条 │ ││
│  │ │ 👤 李四 (8条记忆)   │   │ │ JSON文件: 15条       │ ││
│  │ │ 👤 王五 (23条记忆)  │   │ │                      │ ││
│  │ │ ...                │   │ │ [查看记忆内容]       │ ││
│  │ └────────────────────┘   │ │ [重建向量索引]       │ ││
│  │                          │ │ [导出记忆数据]       │ ││
│  │                          │ └──────────────────────┘ ││
│  └──────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────┘
```

**功能**:
- 按用户查看记忆数据
- 查看ChromaDB向量索引状态
- 手动触发重建向量索引
- 导出用户记忆数据

---

#### 2.5 环境变量配置 (`/admin/settings/env`)

**UI布局**:
```
┌──────────────────────────────────────────────────────────┐
│  环境变量配置                          [保存更改]        │
├──────────────────────────────────────────────────────────┤
│  ⚠️ 警告：修改环境变量可能需要重启服务才能生效           │
├──────────────────────────────────────────────────────────┤
│  📁 LLM 配置                                             │
│  ┌──────────────────────────────────────────────────────┐│
│  │ LLM_BACKEND     │ [ollama ▼]                        ││
│  │ OLLAMA_MODEL    │ [deepseek-r1:14b        ]         ││
│  │ OLLAMA_TIMEOUT  │ [30000                 ] ms       ││
│  │ DEEPSEEK_MODEL  │ [deepseek-chat         ]         ││
│  └──────────────────────────────────────────────────────┘│
│                                                          │
│  📁 Embedding 配置                                       │
│  ┌──────────────────────────────────────────────────────┐│
│  │ EMBEDDING_BACKEND │ [ollama ▼]                      ││
│  │ EMBEDDING_MODEL   │ [bge-m3               ]         ││
│  └──────────────────────────────────────────────────────┘│
│                                                          │
│  📁 其他配置                                             │
│  ┌──────────────────────────────────────────────────────┐│
│  │ LLM_TEMPERATURE │ [0.7                   ]          ││
│  │ LLM_MAX_RETRIES │ [3                     ]          ││
│  └──────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────┘
```

**安全考虑**:
- 敏感变量（API Key）只显示 `****`，可点击"显示"
- 某些变量设为只读（如 `MONGO_URI`, `JWT_SECRET`）
- 修改后需确认才能保存
- 保存时写入 `.env` 文件

---

#### 2.6 角色权限管理 (`/admin/roles`)

**UI布局**:
```
┌──────────────────────────────────────────────────────────┐
│  角色管理                              [+ 新增角色]      │
├──────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐│
│  │ 角色列表                                              ││
│  │ ┌──────────┬──────────────┬────────────────────────┐││
│  │ │ 角色名称 │   描述       │       权限数量         │││
│  │ ├──────────┼──────────────┼────────────────────────┤││
│  │ │ 超级管理员│ 系统最高权限 │ 28个权限 [编辑]       │││
│  │ │ 管理员   │ 日常管理     │ 15个权限 [编辑]       │││
│  │ │ 用户     │ 普通用户     │ 5个权限  [编辑]       │││
│  │ └──────────┴──────────────┴────────────────────────┘││
│  └──────────────────────────────────────────────────────┘│
│                                                          │
│  权限编辑弹窗:                                           │
│  ┌──────────────────────────────────────────────────────┐│
│  │ ☑ user:view    ☑ user:create    ☑ user:update       ││
│  │ ☑ role:view    ☐ role:create    ☐ role:update       ││
│  │ ☑ system:view  ☐ system:update  ☐ system:reset      ││
│  │ ...                                                  ││
│  └──────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────┘
```

---

#### 2.7 数据统计面板 (`/admin/dashboard`)

**UI布局**:
```
┌──────────────────────────────────────────────────────────┐
│  管理面板首页                                            │
├──────────────────────────────────────────────────────────┤
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │ 总用户数 │ │ 今日新增 │ │ 问卷完成率│ │ 活跃用户 │   │
│  │   156    │ │    3     │ │   78%    │ │   42     │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
│                                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              用户增长趋势图                          │ │
│  │         📈 (折线图，按月/周)                        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌─────────────────────┐ ┌─────────────────────────────┐│
│  │   系统状态          │ │     最近活动                ││
│  │   🟢 MongoDB: 正常  │ │   • 张三 完成了基础问卷     ││
│  │   🟢 ChromaDB: 正常 │ │   • 李四 注册了账户         ││
│  │   🟢 LLM: 正常      │ │   • 王五 开始了对话         ││
│  │   🟢 Ollama: 正常   │ │   ...                       ││
│  └─────────────────────┘ └─────────────────────────────┘│
└──────────────────────────────────────────────────────────┘
```

---

### 三、技术实现要点

| 模块 | 技术方案 |
|------|----------|
| **路由保护** | AdminLayout + 权限中间件 |
| **状态管理** | 扩展现有 Zustand store |
| **UI组件** | 复用 shadcn/ui + 新增管理组件 |
| **API设计** | `/api/admin/*` 前缀，复用现有Service |
| **表格组件** | 使用 tanstack/react-table |
| **图表** | 使用 recharts |
| **表单验证** | react-hook-form + zod |

---

### 四、文件结构规划

```
web/app/admin/
├── layout.tsx                 # Admin布局 + 权限检查
├── page.tsx                   # Dashboard首页
├── login/
│   └── page.tsx               # 管理员登录
├── register/
│   └── page.tsx               # 管理员注册（邀请码）
├── users/
│   ├── page.tsx               # 用户列表
│   └── [id]/
│       └── page.tsx           # 用户详情/编辑
├── questionnaires/
│   ├── page.tsx               # 问卷列表
│   └── components/
│       ├── QuestionForm.tsx
│       └── QuestionList.tsx
├── memories/
│   └── page.tsx               # 记忆库管理
├── roles/
│   ├── page.tsx               # 角色列表
│   └── components/
│       └── PermissionEditor.tsx
└── settings/
    ├── page.tsx               # 设置首页
    ├── env/
    │   └── page.tsx           # 环境变量配置
    └── invite-codes/
        └── page.tsx           # 邀请码管理

server/src/modules/admin/
├── route.js                   # 管理API路由
├── controller.js
├── service.js
└── middleware.js              # 管理员权限中间件
```

---

## ✅ 设计确认

以上是完整的后台管理系统设计方案。请确认：

1. **架构**: 同端口 `/admin/*` 路由分离 - ✅
2. **认证**: 独立管理员注册 + 邀请码 - ✅
3. **邀请码**: .env备用 + 动态生成 - ✅
4. **6个功能模块**: 全部实现 - ✅

**这个设计方案是否符合您的预期？有需要调整的地方吗？**