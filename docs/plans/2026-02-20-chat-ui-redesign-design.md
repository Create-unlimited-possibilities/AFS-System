# AI å¯¹è¯ç•Œé¢é‡æ„è®¾è®¡æ–‡æ¡£

**æ—¥æœŸ**: 2026-02-20
**ä½œè€…**: AFS Team
**çŠ¶æ€**: å·²æ‰¹å‡†

## 1. æ¦‚è¿°

å°†ç°æœ‰ AI å¯¹è¯ç•Œé¢é‡æ„ä¸ºç±»ä¼¼ WhatsApp/å¾®ä¿¡çš„ä¸‰æ å¸ƒå±€ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

### 1.1 ç›®æ ‡

- å®ç°ä¸‰æ å¼å¸ƒå±€ï¼šå¯¼èˆªæ  + ç”¨æˆ·åˆ—è¡¨ + ä¼šè¯é¢æ¿
- æ”¯æŒæ¡Œé¢ç«¯å’Œæ‰‹æœºç«¯å“åº”å¼è®¾è®¡
- ä¼˜åŒ–ç”¨æˆ·åˆ—è¡¨å±•ç¤ºï¼ˆæœç´¢ã€æ–°å¢å¥½å‹ï¼‰
- å®ç°"ä¸€å¯¹ä¸€ç”¨æˆ· = ä¸€ä¸ªä¼šè¯çª—å£"çš„æ¨¡å¼

### 1.2 éç›®æ ‡

- ç¾¤ç»„èŠå¤©åŠŸèƒ½ï¼ˆæš‚ä¸å¼€å‘ï¼‰
- å¤´åƒæ˜¾ç¤ºï¼ˆæš‚ä¸éœ€è¦ï¼‰

## 2. å¸ƒå±€è®¾è®¡

### 2.1 æ¡Œé¢ç«¯å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        â”‚  â”‚  èŠå¤©          [+æ–°å¢å¥½å‹] â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚  è¿”å›  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                           â”‚ â”‚
â”‚  â”‚        â”‚  â”‚  ğŸ” æœç´¢åå­—/ç¼–å·...     â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚    è¯·é€‰æ‹©å·¦ä¾§ç”¨æˆ·         â”‚ â”‚
â”‚  â”‚  ä¸­å¿ƒ  â”‚  â”‚  ğŸ‘¤ å¼ ä¸‰                â”‚  â”‚    å¼€å§‹å¯¹è¯               â”‚ â”‚
â”‚  â”‚        â”‚  â”‚     #A12345             â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚        â”‚  â”‚     æœ€è¿‘: ä½ å¥½ï¼Œæœ€è¿‘...  â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                           â”‚ â”‚
â”‚  â”‚        â”‚  â”‚  ğŸ‘¤ æå››                â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚        â”‚  â”‚     #B67890             â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚        â”‚  â”‚     æœ€è¿‘: æ˜å¤©è§ï¼       â”‚  â”‚                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â†‘                  â†‘                            â†‘                 â”‚
â”‚    å¯¼èˆªæ             ç”¨æˆ·åˆ—è¡¨                    ä¼šè¯åŒºåŸŸ              â”‚
â”‚    (w-16)           (w-80)                   (flex-1)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ‰‹æœºç«¯å¸ƒå±€

**é»˜è®¤çŠ¶æ€ï¼ˆåˆ—è¡¨é¡µï¼‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â—€ â”‚ èŠå¤©    [+] â”‚â”‚
â”‚  â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ â”€â”€ â”‚ğŸ” æœç´¢...  â”‚â”‚
â”‚  â”‚ ä¸­å¿ƒâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚    â”‚ğŸ‘¤ å¼ ä¸‰     â”‚â”‚
â”‚  â”‚    â”‚   #A12345  â”‚â”‚
â”‚  â”‚    â”‚   ä½ å¥½...  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é€‰ä¸­ç”¨æˆ·åï¼ˆä¼šè¯é¡µï¼‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  å¼ ä¸‰            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ AIæ¶ˆæ¯æ°”æ³¡   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚      â”‚ ç”¨æˆ·æ°”æ³¡   â”‚ â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ è¾“å…¥... ]    [â¤] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. ç»„ä»¶æ¶æ„

### 3.1 æ–‡ä»¶ç»“æ„

```
web/app/chat/
â”œâ”€â”€ page.tsx                 # ä¸»é¡µé¢ï¼ˆä¸‰æ å¸ƒå±€å®¹å™¨ï¼‰
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Sidebar.tsx          # å·¦ä¾§å¯¼èˆªæ 
â”‚   â”œâ”€â”€ UserList.tsx         # ä¸­é—´ç”¨æˆ·åˆ—è¡¨
â”‚   â”œâ”€â”€ UserListItem.tsx     # åˆ—è¡¨é¡¹ç»„ä»¶
â”‚   â”œâ”€â”€ ChatPanel.tsx        # å³ä¾§ä¼šè¯é¢æ¿
â”‚   â”œâ”€â”€ ChatMessages.tsx     # æ¶ˆæ¯åˆ—è¡¨
â”‚   â”œâ”€â”€ ChatInput.tsx        # è¾“å…¥åŒºåŸŸ
â”‚   â”œâ”€â”€ AddFriendModal.tsx   # æ–°å¢å¥½å‹å¼¹çª—
â”‚   â””â”€â”€ SearchBar.tsx        # æœç´¢æ 
â””â”€â”€ hooks/
    â””â”€â”€ useChat.ts           # èŠå¤©ç›¸å…³é€»è¾‘ hook
```

### 3.2 ç»„ä»¶å±‚çº§

```
page.tsx
â”œâ”€â”€ Sidebar
â”œâ”€â”€ UserList
â”‚   â”œâ”€â”€ Header ("èŠå¤©" + æ–°å¢æŒ‰é’®)
â”‚   â”œâ”€â”€ SearchBar
â”‚   â””â”€â”€ UserListItem[]
â””â”€â”€ ChatPanel
    â”œâ”€â”€ ChatHeader
    â”œâ”€â”€ ChatMessages
    â”‚   â””â”€â”€ MessageBubble[]
    â””â”€â”€ ChatInput
```

## 4. UI è®¾è®¡è§„èŒƒ

### 4.1 é…è‰²

- ä¸»è‰²è°ƒï¼šæ©™è‰²ç³»ï¼ˆä¿æŒç°æœ‰é£æ ¼ï¼‰
- èƒŒæ™¯ï¼šç™½è‰²/æµ…ç°è‰²

### 4.2 æ¶ˆæ¯æ°”æ³¡æ ·å¼

| ç±»å‹ | èƒŒæ™¯ | æ–‡å­— | å¯¹é½ |
|------|------|------|------|
| ç”¨æˆ·æ¶ˆæ¯ | æ©™è‰²æ¸å˜ | é»‘è‰² | å³å¯¹é½ |
| AIæ¶ˆæ¯ | ç™½è‰² + è¾¹æ¡† | é»‘è‰² | å·¦å¯¹é½ |

### 4.3 ç”¨æˆ·åˆ—è¡¨é¡¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼ ä¸‰                   â”‚  â† ç”¨æˆ·åï¼ˆç²—ä½“ï¼‰
â”‚  #A12345                â”‚  â† ç‰¹æ®Šç¼–å·ï¼ˆç°è‰²å°å­—ï¼‰
â”‚  ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·...    â”‚  â† æœ€åæ¶ˆæ¯ï¼ˆç°è‰²ï¼‰
â”‚                    10:30â”‚  â† æ—¶é—´ï¼ˆå³å¯¹é½ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5. æ•°æ®æµè®¾è®¡

### 5.1 å‰ç«¯çŠ¶æ€

```typescript
interface ChatState {
  // ç”¨æˆ·åˆ—è¡¨
  users: User[];
  searchQuery: string;

  // å½“å‰é€‰ä¸­
  selectedUserId: string | null;

  // ä¼šè¯æ•°æ®
  currentSession: Session | null;
  messages: Message[];

  // UI çŠ¶æ€
  isLoading: boolean;
  isMobile: boolean;
  showAddModal: boolean;
}
```

### 5.2 å“åº”å¼é€»è¾‘

```javascript
// æ‰‹æœºç«¯è§†å›¾æ§åˆ¶
const showUserList = isMobile && selectedUserId === null;
const showChat = !isMobile || selectedUserId !== null;
```

### 5.3 æ•°æ®æµç¨‹

```
1. é¡µé¢åŠ è½½
   â””â”€â†’ GET /api/chat/contacts
       â””â”€â†’ æ¸²æŸ“ UserListï¼ˆæŒ‰ lastMessageAt æ’åºï¼‰

2. ç‚¹å‡»ç”¨æˆ·
   â””â”€â†’ è®¾ç½® selectedUserId
   â””â”€â†’ å¦‚æœæœ‰ sessionIdï¼ŒåŠ è½½å†å²æ¶ˆæ¯
   â””â”€â†’ æ¸²æŸ“ ChatPanel

3. å‘é€æ¶ˆæ¯
   â””â”€â†’ ä¹è§‚æ›´æ–°ï¼šç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
   â””â”€â†’ ç¡®ä¿ä¼šè¯å­˜åœ¨ï¼ˆæ‡’åŠ è½½ï¼‰
   â””â”€â†’ SSE æµå¼æ¥æ”¶ AI å›å¤
```

### 5.4 ä¹è§‚æ›´æ–° + SSE æµå¼å“åº”

```typescript
async function handleSend(message: string) {
  // 1. ä¹è§‚æ›´æ–°ï¼šç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
  setMessages(prev => [...prev, {
    role: 'user',
    content: message,
    timestamp: new Date(),
    pending: true
  }]);

  // 2. æ‡’åŠ è½½ï¼šç¡®ä¿æœ‰ä¼šè¯
  if (!sessionId) {
    const session = await createSession(targetUniqueCode);
    setSessionId(session.sessionId);
  }

  // 3. SSE æµå¼å“åº”
  const eventSource = new EventSource(...);
  // å®æ—¶æ›´æ–° AI æ¶ˆæ¯
}
```

## 6. åç«¯å˜æ›´

### 6.1 æ¨¡å‹å˜æ›´

**æ— æ¨¡å‹å˜æ›´** - ç°æœ‰ ChatSessionã€AssistRelationã€User æ¨¡å‹å­—æ®µè¶³å¤Ÿã€‚

### 6.2 ä»£ç å˜æ›´

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | å†…å®¹ |
|------|---------|------|
| `orchestrator.js` | ä¿®æ”¹ | `createSession` æ”¹ä¸º"æŸ¥æ‰¾æˆ–åˆ›å»º"æ¨¡å¼ |
| `controller.js` | ä¿®æ”¹ | æ‰©å±• `getActiveSessions` è¿”å›å­—æ®µ |
| `controller.js` | æ–°å¢ | `getContacts` æ–¹æ³• |
| `routes.js` | æ–°å¢ | `GET /api/chat/contacts` è·¯ç”± |

### 6.3 API å˜æ›´

**æ–°å¢ API**ï¼š

```
GET /api/chat/contacts
```

å“åº”ç»“æ„ï¼š
```json
{
  "success": true,
  "contacts": [
    {
      "targetUserId": "...",
      "targetUserName": "å¼ ä¸‰",
      "targetUniqueCode": "A12345",
      "relationType": "family | friend | stranger",
      "specificRelation": "å„¿å­",
      "sessionId": "chat_xxx",
      "lastMessage": "ä½ å¥½...",
      "lastMessageAt": "2026-02-20T10:30:00Z",
      "sentimentScore": 50
    }
  ]
}
```

**ä¿®æ”¹ API**ï¼š

```
POST /api/chat/sessions/code
```

ä¿®æ”¹ï¼šæ”¹ä¸º"æŸ¥æ‰¾æˆ–åˆ›å»º"æ¨¡å¼ï¼ŒåŒä¸€ç”¨æˆ·å¯¹åªè¿”å›ä¸€ä¸ªä¼šè¯ã€‚

### 6.4 getContacts å®ç°é€»è¾‘

```javascript
async getContacts(req, res) {
  const userId = req.user.id;

  // 1. è·å–å®¶äºº/æœ‹å‹å…³ç³»ï¼ˆå³ä½¿æœªèŠå¤©ï¼‰
  const relations = await AssistRelation.find({
    assistantId: userId,
    isActive: true
  }).populate('targetId', 'name uniqueCode');

  // 2. è·å–æœ‰ä¼šè¯çš„é™Œç”Ÿäºº
  const sessions = await ChatSession.find({
    interlocutorUserId: userId,
    relation: 'stranger'
  }).populate('targetUserId', 'name uniqueCode');

  // 3. åˆå¹¶å¹¶å»é‡
  // 4. æŒ‰ lastMessageAt æ’åºï¼ˆæœªèŠå¤©çš„æ’åœ¨æœ€åï¼‰

  res.json({ success: true, contacts });
}
```

## 7. å…¥å£è®¾è®¡

### 7.1 å¯¼èˆªæµç¨‹

```
/dashboard â†’ ç‚¹å‡»"AIå¯¹è¯" â†’ /chat (ç›´æ¥ä¸‰æ å¸ƒå±€)
                            â†“
                      ç‚¹å‡»[+æ–°å¢å¥½å‹] â†’ å¼¹çª—è¾“å…¥ç¼–å· â†’ åˆ›å»ºä¼šè¯ â†’ åˆ—è¡¨æ˜¾ç¤ºè¯¥ç”¨æˆ·
```

### 7.2 æ–°ç”¨æˆ·é¦–æ¬¡è¿›å…¥

| æ ä½ | æ˜¾ç¤ºå†…å®¹ |
|------|---------|
| ä¸­é—´åˆ—è¡¨ | ç©ºçŠ¶æ€æç¤ºï¼š"è¿˜æ²¡æœ‰å¯¹è¯ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥½å‹" |
| å³ä¾§ä¼šè¯ | "è¯·é€‰æ‹©ç”¨æˆ·å¼€å§‹å¯¹è¯" |

## 8. æ’åºè§„åˆ™

è”ç³»äººåˆ—è¡¨æŒ‰ä»¥ä¸‹è§„åˆ™æ’åºï¼š
1. æŒ‰ `lastMessageAt` é™åºæ’åˆ—
2. æœªèŠè¿‡å¤©çš„è”ç³»äººæ’åœ¨æœ€å
3. ä¸åŒºåˆ†å…³ç³»ç±»å‹ï¼ˆå®¶äºº/æœ‹å‹/é™Œç”Ÿäººæ··åˆæ’åºï¼‰

## 9. åºŸå¼ƒæ–‡ä»¶

é‡æ„å®Œæˆåå¯åˆ é™¤ï¼š
- `web/app/chat/new/page.tsx` - å…¥å£é€»è¾‘å·²æ•´åˆåˆ°ä¸»é¡µé¢
- `web/app/chat/[sessionId]/page.tsx` - æ”¹ä¸ºçŠ¶æ€åˆ‡æ¢ï¼Œä¸å†éœ€è¦ç‹¬ç«‹è·¯ç”±

## 10. é£é™©ä¸æ³¨æ„äº‹é¡¹

1. **ä¼šè¯å”¯ä¸€æ€§**ï¼šç¡®ä¿åç«¯ `createSession` æ­£ç¡®å®ç°"æŸ¥æ‰¾æˆ–åˆ›å»º"é€»è¾‘
2. **SSE å…¼å®¹æ€§**ï¼šç¡®ä¿å‰ç«¯ EventSource æ­£ç¡®å¤„ç†è¿æ¥å’Œé”™è¯¯
3. **ç§»åŠ¨ç«¯è¿”å›**ï¼šç¡®ä¿è¿”å›æŒ‰é’®æ­£ç¡®é‡ç½®çŠ¶æ€
4. **æœç´¢æ€§èƒ½**ï¼šç›®å‰ä½¿ç”¨å‰ç«¯è¿‡æ»¤ï¼Œè”ç³»äººæ•°é‡å¤§æ—¶éœ€æ”¹ä¸ºåç«¯æœç´¢
