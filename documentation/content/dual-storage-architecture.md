---
id: dual-storage-architecture
title: åŒé‡å­˜å‚¨æ¶æ„
sidebar_label: åŒé‡å­˜å‚¨æ¶æ„
slug: /dual-storage-architecture
---

# åŒé‡å­˜å‚¨æ¶æ„è¯´æ˜

## æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨**åŒé‡å­˜å‚¨æ¶æ„**ï¼Œç»“åˆMongoDBå’Œæ–‡ä»¶ç³»ç»Ÿçš„ä¼˜åŠ¿ï¼š

- **MongoDB**: ç»“æ„åŒ–æ•°æ®å­˜å‚¨ã€å®æ—¶æŸ¥è¯¢ï¼ˆmongoserverå®¹å™¨ï¼‰
- **æ–‡ä»¶ç³»ç»Ÿ**: æ‰¹é‡æ•°æ®è¯»å–ã€RAGç¼“å­˜ï¼ˆserverå®¹å™¨ï¼‰

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### å®¹å™¨èŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         serverå®¹å™¨ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ–‡ä»¶ç³»ç»Ÿå·ï¼ˆæœ¬åœ°æŒ‚è½½ï¼‰           â”‚  â”‚
â”‚  â”‚  ./server/storage:/app/storage    â”‚  â”‚
â”‚  â”‚  - userdata/                      â”‚  â”‚
â”‚  â”‚    - A_set/                       â”‚  â”‚
â”‚  â”‚    - B_sets/                      â”‚  â”‚
â”‚  â”‚    - C_sets/                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ ç½‘ç»œè®¿é—®
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      mongoserverå®¹å™¨ï¼ˆæ•°æ®åº“æœåŠ¡ï¼‰      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MongoDBæ•°æ®å·ï¼ˆæœ¬åœ°æŒ‚è½½ï¼‰        â”‚  â”‚
â”‚  â”‚  ./mongoserver/mongodb_data:      â”‚  â”‚
â”‚  â”‚  /data/db                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‚ ç›®å½•ç»“æ„

### é¡¹ç›®ç›®å½•

```
F:\FPY\AFS-System\
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ storage/                 # æ–‡ä»¶ç³»ç»Ÿè®°å¿†æ•°æ®
â”‚   â”‚   â””â”€â”€ userdata/
â”‚   â”‚       â”œâ”€â”€ {userId}/
â”‚   â”‚       â”‚   â”œâ”€â”€ A_set/     # è‡ªå·±å›ç­”çš„é—®é¢˜ï¼ˆ70ä¸ªï¼‰
â”‚   â”‚       â”‚   â”œâ”€â”€ B_sets/    # å®¶äººååŠ©å›ç­”ï¼ˆ70ä¸ªï¼‰
â”‚   â”‚       â”‚   â””â”€â”€ C_sets/    # æœ‹å‹ååŠ©å›ç­”ï¼ˆ64ä¸ªï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ services/
â”‚       â”‚   â”œâ”€â”€ storageService.js  # ç»Ÿä¸€å­˜å‚¨æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ fileStorage.js     # æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
â”‚       â”‚   â”œâ”€â”€ memoryLoader.js    # æ‰¹é‡è¯»å–è®°å¿†
â”‚       â”‚   â””â”€â”€ vectorIndexService.js  # RAGç´¢å¼•
â”‚       â””â”€â”€ routes/
â”‚           â”œâ”€â”€ questions.js      # é—®é¢˜API
â”‚           â””â”€â”€ answers.js        # ç­”æ¡ˆAPI
â”‚
â”œâ”€â”€ mongoserver/
â”‚   â”œâ”€â”€ mongodb_data/            # MongoDBæ•°æ®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ *.wt                # WiredTigeræ•°æ®
â”‚   â”‚   â”œâ”€â”€ collection-*.wt      # é›†åˆæ•°æ®
â”‚   â”‚   â””â”€â”€ journal/            # æ—¥å¿—æ–‡ä»¶
â”‚   â””â”€â”€ init/                   # åˆå§‹åŒ–è„šæœ¬
â”‚
â””â”€â”€ docker-compose.yml
```

## ğŸ”„ æ•°æ®å†™å…¥æµç¨‹

### å†™å…¥åŒé‡å­˜å‚¨

```
ç”¨æˆ·å¡«å†™ç­”æ¡ˆ
    â†“
POST /api/questions/answer
    â†“
serverå®¹å™¨æ¥æ”¶
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StorageService.saveAnswer()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MongoDB  â”‚  â”‚  æ–‡ä»¶ç³»ç»Ÿ      â”‚
â”‚ (åŒæ­¥ï¼‰    â”‚  â”‚  (å¼‚æ­¥ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“             â†“
mongoserver/   server/
mongodb_data/   storage/
```

### ä»£ç å®ç°

```javascript
// server/src/services/storageService.js

export default class StorageService {
  async saveAnswer(answerData) {
    // æ­¥éª¤1ï¼šå†™å…¥MongoDBï¼ˆåŒæ­¥ï¼‰
    const dbAnswer = await Answer.findOneAndUpdate(
      { userId, targetUserId, questionId },
      { question, answer, questionLayer: layer },
      { upsert: true, new: true }
    );

    // æ­¥éª¤2ï¼šå¼‚æ­¥å†™å…¥æ–‡ä»¶ç³»ç»Ÿ
    this.syncToFileSystem(dbAnswer.toObject()).catch(err => {
      console.error('[StorageService] æ–‡ä»¶åŒæ­¥å¤±è´¥:', err);
    });

    return { success: true, answer: dbAnswer };
  }
}
```

## ğŸ“– æ•°æ®è¯»å–æµç¨‹

### åœºæ™¯1ï¼šå‰ç«¯æŸ¥çœ‹ç­”æ¡ˆï¼ˆMongoDBï¼‰

```
å‰ç«¯è¯·æ±‚
    â†“
GET /api/answers?targetUserId={id}
    â†“
serverå®¹å™¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MongoDBæŸ¥è¯¢ï¼ˆæœ€æ–°æ•°æ®ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
          ç½‘ç»œè®¿é—®
             â†“
       mongoserverå®¹å™¨
             â†“
         MongoDBæ•°æ®åº“
             â†“
         è¿”å›ç»™å‰ç«¯
```

### ä»£ç å®ç°

```javascript
// server/src/routes/answers.js

router.get('/', async (req, res) => {
  const { targetUserId } = req.query;

  // ç›´æ¥ä»MongoDBè¯»å–ï¼ˆæœ€æ–°æ•°æ®ï¼‰
  const answers = await Answer.find({ targetUserId })
    .sort({ createdAt: -1 })
    .lean();

  res.json({ success: true, answers });
});
```

### åœºæ™¯2ï¼šç”Ÿæˆè§’è‰²å¡ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰

```
å‰ç«¯è¯·æ±‚
    â†“
POST /api/chatbeta/rolecard/generate
    â†“
serverå®¹å™¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FileStorage.loadUserMemories()       â”‚
â”‚  - æ‰¹é‡è¯»å–JSONæ–‡ä»¶                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
      æœ¬åœ°æ–‡ä»¶è¯»å–
             â†“
   server/storage/userdata/
   {userId}/A_set/self/emotional/
             â†“
        æ‰¹é‡åŠ è½½
             â†“
       è¿”å›æ•°æ®ç»“æ„
```

### ä»£ç å®ç°

```javascript
// server/src/services/memoryLoader.js

export default class MemoryLoader {
  async loadUserMemories(userId) {
    const memories = { A_set: [], B_sets: [], C_sets: [] };
    const userPath = path.join(this.basePath, String(userId));

    // æ‰¹é‡åŠ è½½A_set
    const A_setPath = path.join(userPath, 'A_set', 'self');
    await this.loadMemoriesFromFolder(A_setPath, memories.A_set, 'basic');
    await this.loadMemoriesFromFolder(A_setPath, memories.A_set, 'emotional');

    // æ‰¹é‡åŠ è½½B_sets
    const B_setsPath = path.join(userPath, 'B_sets');
    const B_folders = await fs.readdir(B_setsPath);
    for (const folder of B_folders) {
      await this.loadMemoriesFromFolder(folderPath, memories.B_sets, 'basic');
      await this.loadMemoriesFromFolder(folderPath, memories.B_sets, 'emotional');
    }

    return memories;
  }
}
```

### åœºæ™¯3ï¼šRAGæ£€ç´¢ï¼ˆChromaDBå‘é‡ç´¢å¼•ï¼‰

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
POST /api/chatbeta/chat/send
    â†“
serverå®¹å™¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VectorIndexService.search()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
       ChromaDBæŸ¥è¯¢
             â†“
    server/storage/chroma_db/
    user_{userId} é›†åˆ
             â†“
       è¿”å›ç›¸å…³è®°å¿†
```

### ä»£ç å®ç°

```javascript
// server/src/services/vectorIndexService.js

export default class VectorIndexService {
  async search(userId, query, topK = 5) {
    const collection = await this.chroma.getCollection({
      name: `user_${userId}`
    });

    const results = await collection.query({
      queryTexts: [query],
      nResults: topK
    });

    return results;
  }
}
```

## ğŸ¯ æ•°æ®ä½¿ç”¨ç­–ç•¥

| åœºæ™¯ | æ•°æ®æ¥æº | è®¿é—®æ–¹å¼ | åŸå›  |
|------|---------|---------|------|
| **ç”¨æˆ·å¡«å†™ç­”æ¡ˆ** | MongoDB + æ–‡ä»¶ç³»ç»Ÿ | ç½‘ç»œè®¿é—® + æœ¬åœ°å†™å…¥ | ç¡®ä¿æ•°æ®æŒä¹…åŒ– |
| **å‰ç«¯æŸ¥çœ‹ç­”æ¡ˆ** | MongoDB | ç½‘ç»œè®¿é—® | è·å–æœ€æ–°æ•°æ® |
| **ç”Ÿæˆè§’è‰²å¡** | æ–‡ä»¶ç³»ç»Ÿ | æœ¬åœ°è¯»å– | æ‰¹é‡è¯»å–ï¼Œé«˜æ€§èƒ½ |
| **RAGæ£€ç´¢** | ChromaDB | æœ¬åœ°è¯»å– | å¿«é€Ÿè¯­ä¹‰æ£€ç´¢ |
| **é™çº§è¯»å–** | MongoDB | ç½‘ç»œè®¿é—® | æ–‡ä»¶ç³»ç»Ÿä¸ºç©ºæ—¶ä½¿ç”¨ |

## ğŸ”‘ æ ¸å¿ƒåŸåˆ™

### 1. æ•°æ®å½’å±
- **MongoDBæ•°æ®** â†’ `mongoserver/mongodb_data/`ï¼ˆmongoserverå®¹å™¨è´Ÿè´£ï¼‰
- **æ–‡ä»¶ç³»ç»Ÿæ•°æ®** â†’ `server/storage/userdata/`ï¼ˆserverå®¹å™¨è´Ÿè´£ï¼‰
- å„å®¹å™¨ç®¡ç†è‡ªå·±çš„æ•°æ®

### 2. è®¿é—®æ–¹å¼
- **MongoDB**: é€šè¿‡ç½‘ç»œè®¿é—® (`mongodb://mongoserver:27017`)
- **æ–‡ä»¶ç³»ç»Ÿ**: é€šè¿‡ç»‘å®šæŒ‚è½½è®¿é—® (æœ¬åœ°å·)

### 3. å†™å…¥ç­–ç•¥
- **MongoDB**: åŒæ­¥å†™å…¥ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
- **æ–‡ä»¶ç³»ç»Ÿ**: å¼‚æ­¥å†™å…¥ï¼Œä¸å½±å“å“åº”é€Ÿåº¦

### 4. è¯»å–ç­–ç•¥
- **å®æ—¶æŸ¥è¯¢**: ä»MongoDBè¯»å–ï¼ˆæœ€æ–°æ•°æ®ï¼‰
- **æ‰¹é‡å¤„ç†**: ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–ï¼ˆé«˜æ€§èƒ½ï¼‰

## ğŸ“Š æ•°æ®ç»Ÿè®¡

### å½“å‰åç«¯æ•°æ®
- ç”¨æˆ·æ•°ï¼š13
- ç­”æ¡ˆè®°å½•ï¼š270æ¡
- è®°å¿†æ–‡ä»¶ï¼š270ä¸ªJSON

### å­˜å‚¨ç©ºé—´
- MongoDBæ•°æ®ï¼šçº¦XX MB (`mongoserver/mongodb_data/`)
- æ–‡ä»¶ç³»ç»Ÿæ•°æ®ï¼šçº¦XX MB (`server/storage/userdata/`)

## ğŸ’¾ æ•°æ®å¤‡ä»½

### å¤‡ä»½MongoDB

```bash
# mongodumpå¤‡ä»½
docker exec afs-system-mongoserver-1 mongodump --db afs_db --out /tmp/backup
docker cp afs-system-mongoserver-1:/tmp/backup ./backup/

# æˆ–ç›´æ¥å¤åˆ¶æ–‡ä»¶
copy mongoserver\mongodb_data\ backup\
```

### å¤‡ä»½æ–‡ä»¶ç³»ç»Ÿ

```bash
# å¤åˆ¶æ•´ä¸ªstorageç›®å½•
copy server\storage\ backup\
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Gitåä½œ
- æ•°æ®æ–‡ä»¶å·²æ·»åŠ åˆ° `.gitignore`
- ä¸è¦æäº¤æ•æ„Ÿæ•°æ®åˆ°Git
- å…¶ä»–äººå…‹éš†åä¼šåˆ›å»ºç©ºç›®å½•

### 2. å®¹å™¨é‡å¯
- æ•°æ®æŒä¹…åŒ–åœ¨æœ¬åœ°ç›®å½•
- å®¹å™¨é‡å¯ä¸ä¼šä¸¢å¤±æ•°æ®

### 3. è·¨å®¹å™¨è®¿é—®
- MongoDBï¼šé€šè¿‡ç½‘ç»œç«¯å£è®¿é—®
- æ–‡ä»¶ç³»ç»Ÿï¼šæ¯ä¸ªå®¹å™¨æœ‰è‡ªå·±çš„å·

---

**æœ€åæ›´æ–°**: 2026-02-03  
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ