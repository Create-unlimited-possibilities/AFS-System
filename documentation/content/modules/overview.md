---
sidebar_position: 1
---

# 模块概述

后端采用**功能模块化**架构，每个模块独立完整，包含：

- `controller.js` - 控制器（处理 HTTP 请求）
- `service.js` - 业务逻辑
- `repository.js` - 数据访问（可选）
- `model.js` - 数据模型（可选）
- `route.js` - 路由定义

## 模块列表

| 模块 | 路径 | 功能 |
|------|------|------|
| **认证** | `modules/auth/` | 用户登录、注册、JWT 认证 |
| **用户** | `modules/user/` | 用户 CRUD、统计、状态管理 |
| **角色权限** | `modules/roles/` | 角色管理、权限控制 |
| **问答** | `modules/qa/` | 问题管理、回答保存 |
| **协助关系** | `modules/assist/` | 协助关系建立、管理 |
| **AI 对话** | `modules/chat/` | LangGraph 对话编排 |
| **角色卡** | `modules/rolecard/` | 角色卡生成、向量索引 |
| **好感度** | `modules/sentiment/` | 陌生人好感度追踪 |
| **设置** | `modules/settings/` | 系统配置管理 |

## 核心基础设施

### Storage（存储服务）

位置：`core/storage/`

| 文件 | 功能 |
|------|------|
| `dual.js` | 双重存储协调 |
| `file.js` | 文件系统操作 |
| `vector.js` | 向量索引服务 |
| `embedding.js` | 文本嵌入服务 |
| `syncQueue.js` | 同步队列 |

### LLM（语言模型服务）

位置：`core/llm/`

| 文件 | 功能 |
|------|------|
| `client.js` | LLM 客户端封装 |
| `config.js` | 模型配置 |
| `multi.js` | 多模型管理 |

### Utils（工具函数）

位置：`core/utils/`

| 文件 | 功能 |
|------|------|
| `logger.js` | 日志记录 |
| `tokens.js` | Token 计数 |
| `progress.js` | 进度追踪 |
| `lock.js` | 文件锁 |
| `response.js` | 响应格式化 |

## 模块依赖关系

```
                    ┌──────────┐
                    │   Auth   │
                    └────┬─────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │  User   │    │  Roles  │    │ Settings│
    └────┬────┘    └─────────┘    └─────────┘
         │
         ├───────────────┬───────────────┐
         │               │               │
         ▼               ▼               ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │   QA    │    │  Assist │    │RoleCard │
    └────┬────┘    └────┬────┘    └────┬────┘
         │              │               │
         └──────────────┼───────────────┘
                        │
                        ▼
                   ┌─────────┐
                   │  Chat   │
                   └────┬────┘
                        │
                        ▼
                   ┌─────────┐
                   │Sentiment│
                   └─────────┘
```
