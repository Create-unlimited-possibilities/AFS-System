---
sidebar_position: 1
---

# 系统架构

## 整体架构

AFS System 采用**前后端分离 + 微服务**的架构设计：

```
┌─────────────────────────────────────────────────────────────┐
│                        用户浏览器                            │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Next.js 前端 (3002)                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │  Dashboard  │ │  Questions  │ │    Chat     │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTP/REST
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   Express.js 后端 (3001)                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Modules                           │   │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐      │   │
│  │  │ Auth │ │ User │ │  QA  │ │ Chat │ │RoleCard│     │   │
│  │  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘      │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                     Core                             │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │ Storage │ │   LLM   │ │  Utils  │ │  Hooks  │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└───────────┬─────────────────┬─────────────────┬─────────────┘
            │                 │                 │
            ▼                 ▼                 ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│   MongoDB     │  │    Ollama     │  │   ChromaDB    │
│   (27018)     │  │    (8000)     │  │    (8001)     │
└───────────────┘  └───────────────┘  └───────────────┘
```

## 后端模块化架构

后端采用**功能模块化**设计，每个模块独立完整：

```
server/src/
├── modules/                    # 业务模块
│   ├── auth/                   # 认证模块
│   │   ├── controller.js       # 控制器
│   │   ├── service.js          # 业务逻辑
│   │   ├── middleware.js       # JWT 中间件
│   │   └── route.js            # 路由定义
│   ├── user/                   # 用户模块
│   ├── qa/                     # 问答模块
│   ├── assist/                 # 协助关系模块
│   ├── chat/                   # AI对话模块
│   ├── rolecard/               # 角色卡模块
│   ├── sentiment/              # 好感度模块
│   ├── settings/               # 设置模块
│   └── roles/                  # 角色权限模块
└── core/                       # 核心基础设施
    ├── storage/                # 存储服务
    ├── llm/                    # LLM 服务
    ├── utils/                  # 工具函数
    ├── hooks/                  # 自动 Hook
    └── middleware/             # 共享中间件
```

## 数据流

### 用户注册流程

```
用户填写信息 → 验证邮箱唯一性 → 生成16位专属编号 → 密码加密 → 保存到 MongoDB → 返回 JWT Token
```

### 角色卡生成流程

```
请求生成 → 检查完成度 → 收集所有回答 → LLM 分析 → 生成角色卡 → 保存到数据库和文件
```

### AI 对话流程

```
用户输入 → 关系确认 → 角色卡组装 → RAG 检索 → 情感分析 → 上下文构建 → LLM 生成 → 记忆更新 → 返回响应
```

## 存储架构

### 双重存储机制

系统采用 MongoDB + 文件系统的双重存储：

| 存储方式 | 用途 | 优势 |
|---------|------|------|
| MongoDB | 结构化数据 | 快速查询、事务支持 |
| 文件系统 | JSON 备份 | 可移植性、灾难恢复 |

### 文件存储结构

```
server/storage/
├── users/
│   └── {userId}/
│       ├── A_set.json      # 自己的回答
│       ├── Bste.json       # 家人的回答
│       ├── Cste.json       # 朋友的回答
│       ├── rolecard.json   # 角色卡
│       └── guidelines.json # 对话准则
├── chroma_db/              # ChromaDB 数据
└── vector_index/           # 向量索引
```
